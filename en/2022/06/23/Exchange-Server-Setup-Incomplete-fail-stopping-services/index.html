<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Exchange Server Setup Incomplete but fails to complete | diecknet</title>
<meta name=keywords content="exchange,exchange server setup,troubleshooting,powershell"><meta name=description content="I had an issue with a broken Exchange Server 2016 CU23. Or rather it was not fully installed.
It was just a test environment, but I thought it would be useful or interesting to drill down on that issue.
I&rsquo;ll guide you through my troubleshooting steps / thought process.

"><meta name=author content="Andreas Dieckmann"><link rel=canonical href=https://diecknet.de/en/2022/06/23/Exchange-Server-Setup-Incomplete-fail-stopping-services/><link crossorigin=anonymous href=/assets/css/stylesheet.75a517428f403193483801122d6350f6956c3bb6bf5c6504311f8c24e6bab3e7.css integrity="sha256-daUXQo9AMZNIOAESLWNQ9pVsO7a/XGUEMR+MJOa6s+c=" rel="preload stylesheet" as=style><link rel=icon href=https://diecknet.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://diecknet.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://diecknet.de/favicon-32x32.png><link rel=apple-touch-icon href=https://diecknet.de/apple-touch-icon.png><link rel=mask-icon href=https://diecknet.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://diecknet.de/en/2022/06/23/Exchange-Server-Setup-Incomplete-fail-stopping-services/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Exchange Server Setup Incomplete but fails to complete"><meta property="og:description" content="I had an issue with a broken Exchange Server 2016 CU23. Or rather it was not fully installed.
It was just a test environment, but I thought it would be useful or interesting to drill down on that issue.
I&rsquo;ll guide you through my troubleshooting steps / thought process.

"><meta property="og:type" content="article"><meta property="og:url" content="https://diecknet.de/en/2022/06/23/Exchange-Server-Setup-Incomplete-fail-stopping-services/"><meta property="og:image" content="https://diecknet.de/images/2022/2022-06-22_Exchange_Server_Incomplete_Installation_Detected_small.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-23T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-23T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://diecknet.de/images/2022/2022-06-22_Exchange_Server_Incomplete_Installation_Detected_small.png"><meta name=twitter:title content="Exchange Server Setup Incomplete but fails to complete"><meta name=twitter:description content="I had an issue with a broken Exchange Server 2016 CU23. Or rather it was not fully installed.
It was just a test environment, but I thought it would be useful or interesting to drill down on that issue.
I&rsquo;ll guide you through my troubleshooting steps / thought process.

"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://diecknet.de/en/posts/"},{"@type":"ListItem","position":2,"name":"Exchange Server Setup Incomplete but fails to complete","item":"https://diecknet.de/en/2022/06/23/Exchange-Server-Setup-Incomplete-fail-stopping-services/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Exchange Server Setup Incomplete but fails to complete","name":"Exchange Server Setup Incomplete but fails to complete","description":"I had an issue with a broken Exchange Server 2016 CU23. Or rather it was not fully installed. It was just a test environment, but I thought it would be useful or interesting to drill down on that issue.\nI\u0026rsquo;ll guide you through my troubleshooting steps / thought process.\n","keywords":["exchange","exchange server setup","troubleshooting","powershell"],"articleBody":"I had an issue with a broken Exchange Server 2016 CU23. Or rather it was not fully installed. It was just a test environment, but I thought it would be useful or interesting to drill down on that issue.\nI’ll guide you through my troubleshooting steps / thought process.\nTry to continue Setup First I tried to resume the setup. The setup fails early - at Step 1 of 13: Stopping Services. The error message in detail:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 Error: The following error was generated when \"$error.Clear(); $roleList = $RoleRoles.Replace('Role','').Split(','); if($roleList -contains 'LanguagePacks') { \u0026 $RoleBinPath\\ServiceControl.ps1 Save \u0026 $RoleBinPath\\ServiceControl.ps1 DisableServices $roleList; \u0026 $RoleBinPath\\ServiceControl.ps1 Stop $roleList; }; \" was run: \"System.Management.Automation.MethodInvocationException: Exception calling \"Reverse\" with \"1\" argument(s): \"Value cannot be null. Parameter name: array\" ---\u003e System.ArgumentNullException: Value cannot be null. Parameter name: array at System.Array.Reverse(Array array) at CallSite.Target(Closure , CallSite , Type , Object ) --- End of inner exception stack trace --- at System.Management.Automation.ExceptionHandlingOps.ConvertToMethodInvocationException(Exception exception, Type typeToThrow, String methodName, Int32 numArgs, MemberInfo memberInfo) at CallSite.Target(Closure , CallSite , Type , Object ) at System.Dynamic.UpdateDelegates.UpdateAndExecute2[T0,T1,TRet](CallSite site, T0 arg0, T1 arg1) at System.Management.Automation.Interpreter.DynamicInstruction`3.Run(InterpretedFrame frame) at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)\". Okay, so the setup tried to execute ServiceControl.ps1. Where is that script located…? I don’t know right now, but I’ll find out later.\nCheck Exchange Server Setup Log Let’s first check the Exchange Server Setup Log, at C:\\ExchangeSetupLogs\\ExchangeSetup.log. In the log there is some more context of the previously failed command. So the variable $RoleRoles (nice name) is certainly not empty:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [06/22/2022 07:20:25.0377] [1] Executing: $RoleRoles = 'LanguagePacksRole,BridgeheadRole,ClientAccessRole,UnifiedMessagingRole,MailboxRole,FrontendTransportRole,CafeRole' [...] [06/22/2022 07:20:25.0383] [1] Executing: $roleList = $RoleRoles.Replace('Role','').Split(','); if($roleList -contains 'LanguagePacks') { \u0026 $RoleBinPath\\ServiceControl.ps1 Save \u0026 $RoleBinPath\\ServiceControl.ps1 DisableServices $roleList; \u0026 $RoleBinPath\\ServiceControl.ps1 Stop $roleList; }; [...] [06/22/2022 07:20:25.0332] [1] Writing informational script to 'C:\\ExchangeSetupLogs\\Start-PreFileCopy-20220622-0720250331374206211.ps1' Check Start-PreFileCopy[…].ps1 The Setup also created a script to replicate that command. Neat! I navigated to the file at C:\\ExchangeSetupLogs\\Start-PreFileCopy-20220622-0720250331374206211.ps1.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 # Default Start steps for PreFileCopy. # Programmatically generated on 6/22/2022 7:20:25 AM. # # Variable Declarations # $RoleBinPath = 'X:\\ExchangeServer\\Bin' $RoleDatacenterPath = 'X:\\ExchangeServer\\Datacenter' $RoleDatacenterServiceEndpointABCHContactService = 'http://pvt-contacts.msn.com/abservice/abservice.asmx' $RoleDatacenterServiceEndpointDomainPartnerManageDelegation = 'https://domains.live.com/service/managedelegation.asmx' $RoleDatacenterServiceEndpointDomainPartnerManageDelegation2 = 'https://domains.live.com/service/managedelegation2.asmx' $RoleDatacenterServiceEndpointLiveFederationMetadata = 'https://nexus.passport.com/FederationMetadata/2006-12/FederationMetadata.xml' $RoleDatacenterServiceEndpointLiveGetUserRealm = 'https://login.live.com/GetUserRealm.srf' $RoleDatacenterServiceEndpointLiveServiceLogin2 = 'https://login.live.com/RST2.srf' $RoleDatacenterServiceEndpointMsoFederationMetadata = 'https://nexus.microsoftonline-p.com/FederationMetadata/2006-12/FederationMetadata.xml' $RoleInstallationMode = 'Install' $RoleInstallPath = 'X:\\ExchangeServer\\' $RoleInvocationID = '20220622-0720250331374206211' $RoleIsDatacenter = $False $RoleIsDatacenterDedicated = $False $RoleIsFfo = $False $RoleIsPartnerHosted = $False $RoleLoggingPath = 'X:\\ExchangeServer\\Logging' $RoleProductPlatform = 'amd64' $RoleRoles = 'LanguagePacksRole,BridgeheadRole,ClientAccessRole,UnifiedMessagingRole,MailboxRole,FrontendTransportRole,CafeRole' $RoleSetupLoggingPath = 'C:\\ExchangeSetupLogs' $RoleTargetVersion = '15.01.2507.006' # # Component tasks # # Tasks for 'All Roles Pre File Copy' component # [ID = AllRolesPreFileCopyComponent___2f7e3804a2b340c69e930798211fb8fd, Wt = 10, isFatal = True] \"Stopping services\" #6/22/2022 7:20:25 AM: $roleList = $RoleRoles.Replace('Role','').Split(','); if($roleList -contains 'LanguagePacks') { \u0026 $RoleBinPath\\ServiceControl.ps1 Save \u0026 $RoleBinPath\\ServiceControl.ps1 DisableServices $roleList; \u0026 $RoleBinPath\\ServiceControl.ps1 Stop $roleList; }; I had to comment out one line which was just plaintext with the date/time (above $roleList = [...]). I then tried to manually run that script. And surely I got the same error as the setup before, but with slightly more details. The error occurs in line 302 of ServiceControl.ps1. And now I also know where that ServiceControl.ps1 script actually resided. Nice.\n1 2 3 4 5 6 7 8 PS F:\\Setup\\ServerRoles\\Common\u003e C:\\ExchangeSetupLogs\\Start-PreFileCopy-20220622-0720250331374206211.ps1 Exception calling \"Reverse\" with \"1\" argument(s): \"Value cannot be null. Parameter name: array\" At X:\\ExchangeServer\\Bin\\ServiceControl.ps1:302 char:2 + [array]::Reverse($services) + ~~~~~~~~~~~~~~~~~~~~~~~~~~~ + CategoryInfo : NotSpecified: (:) [], MethodInvocationException + FullyQualifiedErrorId : ArgumentNullException Check ServiceControl.ps1 So ServiceControl.ps1 resides in the Exchange Server Bin-directory. Well that’s easy. Let’s look at that script. Line 301/302 are:\n1 2 $services = Get-ServiceToControl $Roles -Active [array]::Reverse($services) So the reversing of $services fails. The error message from before told us the issue already: Value cannot be null. So is it really null? I’ve set a PowerShell Debugging Breakpoint with the PowerShell ISE to see for myself.\nOKAY, it is empty. What did I even expect here? Then I looked at the definition of the function Get-ServiceToControl, which starts at line 105.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 # Get-ServiceToControl # Returns list of service(s) to control. # Arguments: # $Roles - list of Exchange roles. # $Active - indicates that only non-stopped service should be returned. # Returns: # Service(s) to control. function Get-ServiceToControl ([string[]]$Roles, [switch]$Active) { # 1. Populate full list of services for all roles. \u0026 { # 1.a. Get common ones. if (($Roles -notcontains 'Critical') -and ($script:servicesToControl['Common'])) { $script:servicesToControl['Common'] } # 1.b. Get services for each role. $Roles | foreach { if ($script:servicesToControl[$_]) { $script:servicesToControl[$_] } } } | # 2. Eliminate duplicates. sort | unique | # 3. Filter only those which are installed # and (optionally) running. where { $serviceName = $_ # 3.a. Check if installed. # Note the trick of requesting by pattern prevents Get-Service # from failing in case service is not installed. Get-Service \"$serviceName*\" | ?{$_.Name -eq $serviceName} | # 3.b. If $Active is specified, check that service is not stopped. ?{!$Active -or $_.Status -ne 'Stopped'} } } That function is using the variable $script:servicesToControl. That again is defined starting at line 56.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 $script:servicesToControl = @{} $script:servicesToControl['Common'] = @( 'WinMgmt', 'RemoteRegistry', 'HealthService', 'OnePoint', 'MOM', 'OMCFG', 'pla' ) $script:servicesToControl['ClientAccess'] = @( 'MSExchangeMonitoring', 'MSExchangeIMAP4', 'MSExchangePOP3' , 'MSExchangeADTopology' ,'MSExchangeTopologyService', 'MSExchangeFDS', 'IISAdmin', 'MSExchangeServiceHost', 'W3Svc', 'MSExchangeRPC', 'MSExchangeIMAP4BE', 'MSExchangePOP3BE', 'MSExchangeMailboxReplication', 'MSExchangeFBA', 'MSExchangeProtectedServiceHost', 'MSExchangeDiagnostics', 'MSExchangeHM', 'MSExchangeHMRecovery') $script:servicesToControl['Gateway'] = @( 'MSExchangeMonitoring', 'WorkerService', 'MSExchangeTransport', 'MSExchangeTransportLogSearch', 'MSExchangeEdgeSync', 'MSExchangeAntispamUpdate', 'MSExchangeEdgeCredential', 'MSExchangeServiceHost', 'MSExchangeHM', 'MSExchangeHMRecovery', 'MSExchangeDiagnostics') $script:servicesToControl['Mailbox'] = @( 'MSExchangeMonitoring', 'IISAdmin', 'MSExchangeIS', 'MSExchangeMailboxAssistants', 'MSFTESQL-Exchange', 'MSExchangeThrottling', 'MSExchangeADTopology' ,'MSExchangeTopologyService', 'MSExchangeRepl', 'MSExchangeDagMgmt', 'MSExchangeWatchDog', 'MSExchangeTransportLogSearch', 'MSExchangeRPC', 'MSExchangeServiceHost', 'W3Svc', 'HTTPFilter', 'wsbexchange', 'MSExchangeTransportSyncManagerSvc', 'MSExchangeFastSearch', 'hostcontrollerservice', 'SearchExchangeTracing', 'MSExchangeSubmission', 'MSExchangeDelivery', 'MSExchangeMigrationWorkflow', 'MSExchangeDiagnostics', 'MSExchangeProcessUtilizationManager', 'MSExchangeHM', 'MSExchangeHMRecovery', 'MSExchangeInferenceService') $script:servicesToControl['Bridgehead'] = @( 'MSExchangeMonitoring', 'AdminService', 'FMS', 'MSExchangeAntimalwareSvc', 'MSExchangeAntimalwareUpdateSvc', 'MSExchangeTransport' , 'MSExchangeADTopology' ,'MSExchangeTopologyService', 'MSExchangeEdgeSync', 'MSExchangeProtectedServiceHost', 'MSExchangeTransportLogSearch', 'MSExchangeTransportStreamingOptics', 'MSExchangeAntispamUpdate', 'MSExchangeServiceHost', 'hostcontrollerservice', 'SearchExchangeTracing', 'W3Svc', 'shm', 'MSMessageTracingClient', 'MSExchangeFileUpload', 'MSExchangeDiagnostics', 'MSExchangeProcessUtilizationManager', 'MSExchangeHM', 'MSExchangeHMRecovery', 'MSExchangeStreamingOptics') $script:servicesToControl['UnifiedMessaging'] = @( 'MSExchangeMonitoring', 'Exchange UM Service' , 'MSExchangeADTopology' ,'MSExchangeTopologyService', 'MSExchangeFDS', 'MSExchangeUM', 'MSExchangeServiceHost', 'W3Svc', 'MSExchangeDiagnostics', 'MSExchangeHM', 'MSExchangeHMRecovery') $script:servicesToControl['FrontendTransport'] = @( 'MSExchangeMonitoring', 'AdminService', 'MSExchangeTransport' , 'MSExchangeADTopology' ,'MSExchangeTopologyService', 'MSExchangeEdgeSync', 'MSExchangeProtectedServiceHost', 'MSExchangeTransportLogSearch', 'MSExchangeAntispamUpdate', 'MSExchangeServiceHost', 'W3Svc', 'MSExchangeFrontendTransport', 'shm', 'MSMessageTracingClient', 'MSExchangeFileUpload', 'MSExchangeDiagnostics', 'MSExchangeProcessUtilizationManager', 'MSExchangeHM', 'MSExchangeHMRecovery') $script:servicesToControl['Cafe'] = @( 'MSExchangeMonitoring', 'MSExchangeDiagnostics', 'MSExchangeProcessUtilizationManager', 'MSExchangeHM', 'MSExchangeHMRecovery') $script:servicesToControl['Monitoring'] = @( 'MSExchangeCAMOMConnector', 'MSExchangeMonitoringCorrelation' ) $script:servicesToControl['CentralAdmin'] = @( 'MSExchangeCentralAdmin', 'MSExchangeMonitoringCorrelation', 'WDSServer', 'MSDTC', 'MSExchangeDiagnostics', 'MSExchangeHM', 'MSExchangeHMRecovery') $script:servicesToControl['OSP'] = @( 'IISAdmin', 'W3Svc','MSExchangeADTopology' ,'MSExchangeTopologyService', 'MSExchangeMonitoring', 'MSExchangeHM', 'MSExchangeHMRecovery') $script:servicesToControl['FfoWebService'] = @( 'MSExchangeProcessUtilizationManager','MSExchangeADTopology','MSExchangeProtectedServiceHost','MSExchangeServiceHost','W3Svc') $script:servicesToControl['LanguagePacks'] = $script:servicesToControl['AdminTools'] + $script:servicesToControl['ClientAccess'] + $script:servicesToControl['Gateway'] + $script:servicesToControl['Mailbox'] + $script:servicesToControl['Bridgehead'] + $script:servicesToControl['UnifiedMessaging'] + $script:servicesToControl['Cafe'] + $script:servicesToControl['FrontendTransport'] + $script:servicesToControl['OSP'] # List of critical services required for prereqs. $script:servicesToControl['Critical'] = @( 'WinMgmt', 'RemoteRegistry', 'W3Svc', 'IISAdmin' ) Ah okay, these are the actual Windows Service names for each Exchange Server Role. But that doesn’t really help now. So one step back to Get-ServiceToControl. Oh yeah wait. So if $Active is set, only Windows Services that are not in the Status of Stopped are getting returned. Because of the failed Setup, most Exchange Services are Disabled and surely none are running.\nSo… Could it be that easy? I imagine: If atleast ONE Exchange Service was running, Get-ServiceToControl would NOT return an empty response, so the [array]::Reverse($services) would NOT fail. Then the procedure of “Stopping Exchange Services” should be deemed successful - right?\nManually starting an Exchange Service So opened services.msc to enable and start the Microsoft Exchange Active Directory Topology Service (MSExchangeADTopology).\nRe-run Start-PreFileCopy[…].ps1 I tried to re-run Start-PreFileCopy-20220622-0720250331374206211.ps1. It actually failed now with a different error. But that looks like missing dependencies/functions from the setup environment. Nothing too concerning.\n1 2 3 4 5 6 7 8 9 10 11 12 13 Stop-SetupService : The term 'Stop-SetupService' is not recognized as the name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or if a path was included, verify that the path is correct and try again. At X:\\ExchangeServer\\Bin\\ServiceControl.ps1:342 char:3 + Stop-SetupService -ServiceName $serviceName -ev script:servic ... + ~~~~~~~~~~~~~~~~~ + CategoryInfo : ObjectNotFound: (Stop-SetupService:String) [], CommandNotFoundException + FullyQualifiedErrorId : CommandNotFoundException Cannot index into a null array. At X:\\ExchangeServer\\Bin\\ServiceControl.ps1:343 char:7 + if( $script:serviceControlError[0] -ne $null ) + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ + CategoryInfo : InvalidOperation: (:) [], RuntimeException + FullyQualifiedErrorId : NullArray Re-run Exchange Server Setup So it just might work now, if running from within the Setup context. So I tried. Already looked promising after a bit, because it’s now at Step 2. I went to take break.\nWhen I came back, there was no Exchange Setup running anymore. Weird. Did it crash? I checked the C:\\ExchangeSetupLogs\\ExchangeSetup.log file again. Looks good now:\n1 2 3 4 5 6 7 [06/22/2022 10:07:00.0062] [2] Install is complete. Server state has been set to Active. [06/22/2022 10:07:00.0063] [2] Ending processing Write-ExchangeSetupLog [06/22/2022 10:07:00.0064] [1] Finished executing component tasks. [06/22/2022 10:07:00.0068] [1] Ending processing Start-PostSetup [06/22/2022 10:07:00.0102] [0] CurrentResult setupbase.maincore:396: 0 [06/22/2022 10:07:00.0103] [0] End of Setup [06/22/2022 10:07:00.0103] [0] ********************************************** Verify First I looked if the Services are now enabled and running as they should. Looks good.\nThen I ran the Exchange Management Shell to run Get-ExchangeServer. Looks good aswell.\nConclusion Really weird how that check is implemented. IMO Microsoft could improve the Setup Experience here, if the Setup checks if there are any Services that are running and actually need to get stopped. Instead it crashes now, if there are no running Exchange Services.\nI mean afterwards it always seems easy and obvious. But maybe I could’ve gotten to the goal faster if I had drawn a direct conclusion of the facts\nSetup fails at the step “Stopping Services” No Exchange Services are running = Thus no Services can get stopped Sidenote In the Microsoft Exchange context Cafe stands for “Client Access Front End”. I was somehow not aware of that abbreviation.\n","wordCount":"1690","inLanguage":"en","image":"https://diecknet.de/images/2022/2022-06-22_Exchange_Server_Incomplete_Installation_Detected_small.png","datePublished":"2022-06-23T00:00:00Z","dateModified":"2022-06-23T00:00:00Z","author":{"@type":"Person","name":"Andreas Dieckmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diecknet.de/en/2022/06/23/Exchange-Server-Setup-Incomplete-fail-stopping-services/"},"publisher":{"@type":"Organization","name":"diecknet","logo":{"@type":"ImageObject","url":"https://diecknet.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diecknet.de/en/ accesskey=h title="diecknet (Alt + H)">diecknet</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://diecknet.de/de/ title=Deutsch aria-label=Deutsch>Deutsch</a></li><li><a href=https://diecknet.de/en/ title=English aria-label=English><b>English</b></a></li></ul></div></div><ul id=menu><li><a href=https://diecknet.de/en/ title=Home><span>Home</span></a></li><li><a href=https://diecknet.de/en/services/ title=Services><span>Services</span></a></li><li><a href=https://diecknet.de/en/about/ title=About><span>About</span></a></li><li><a href=https://diecknet.de/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://diecknet.de/en/archive/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://diecknet.de/en/>Home</a>&nbsp;»&nbsp;<a href=https://diecknet.de/en/posts/>Posts</a></div><h1 class=post-title>Exchange Server Setup Incomplete but fails to complete</h1><div class=post-meta><span title='2022-06-23 00:00:00 +0000 UTC'>2022-06-23</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Andreas Dieckmann&nbsp;|&nbsp;<a href=https://github.com/diecknet/diecknet-blog/tree/main/content/en/posts/2022/2022-06-23-Exchange-Server-Setup-Incomplete-fail-stopping-services.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><figure class=entry-cover><img loading=lazy src=https://diecknet.de/images/2022/2022-06-22_Exchange_Server_Incomplete_Installation_Detected_small.png alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#try-to-continue-setup aria-label="Try to continue Setup">Try to continue Setup</a></li><li><a href=#check-exchange-server-setup-log aria-label="Check Exchange Server Setup Log">Check Exchange Server Setup Log</a></li><li><a href=#check-start-prefilecopyps1 aria-label="Check Start-PreFileCopy[&mldr;].ps1">Check Start-PreFileCopy[&mldr;].ps1</a></li><li><a href=#check-servicecontrolps1 aria-label="Check ServiceControl.ps1">Check ServiceControl.ps1</a></li><li><a href=#manually-starting-an-exchange-service aria-label="Manually starting an Exchange Service">Manually starting an Exchange Service</a></li><li><a href=#re-run-start-prefilecopyps1 aria-label="Re-run Start-PreFileCopy[&mldr;].ps1">Re-run Start-PreFileCopy[&mldr;].ps1</a></li><li><a href=#re-run-exchange-server-setup aria-label="Re-run Exchange Server Setup">Re-run Exchange Server Setup</a></li><li><a href=#verify aria-label=Verify>Verify</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a><ul><li><a href=#sidenote aria-label=Sidenote>Sidenote</a></li></ul></li></ul></div></details></div><div class=post-content><p>I had an issue with a broken Exchange Server 2016 CU23. Or rather it was not fully installed.
It was just a test environment, but I thought it would be useful or interesting to drill down on that issue.</p><p>I&rsquo;ll guide you through my troubleshooting steps / thought process.</p><p><a href=/images/2022/2022-06-22_Exchange_Server_Incomplete_Installation_Detected.png><img loading=lazy src=/images/2022/2022-06-22_Exchange_Server_Incomplete_Installation_Detected.png alt="Exchange Server 2016 CU23 Setup Assistant - Incomplete Installation Detected" title="Exchange Server 2016 CU23 Setup Assistant - Incomplete Installation Detected"></a></p><h2 id=try-to-continue-setup>Try to continue Setup<a hidden class=anchor aria-hidden=true href=#try-to-continue-setup>#</a></h2><p>First I tried to resume the setup. The setup fails early - at <code>Step 1 of 13: Stopping Services</code>.
<a href=/images/2022/2022-06-22_Exchange_Server_Setup_Fails_at_stopping_services.png><img loading=lazy src=/images/2022/2022-06-22_Exchange_Server_Setup_Fails_at_stopping_services.png alt="Exchange Server 2016 CU23 Setup Assistant - Fails at Step 1 Stopping services" title="Exchange Server 2016 CU23 Setup Assistant - Fails at Step 1 Stopping services"></a></p><p>The error message in detail:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Error:
</span></span><span style=display:flex><span>The following error was generated when &#34;$error.Clear();
</span></span><span style=display:flex><span>          $roleList = $RoleRoles.Replace(&#39;Role&#39;,&#39;&#39;).Split(&#39;,&#39;);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          if($roleList -contains &#39;LanguagePacks&#39;)
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            &amp; $RoleBinPath\ServiceControl.ps1 Save
</span></span><span style=display:flex><span>            &amp; $RoleBinPath\ServiceControl.ps1 DisableServices $roleList;
</span></span><span style=display:flex><span>            &amp; $RoleBinPath\ServiceControl.ps1 Stop $roleList;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        &#34; was run: &#34;System.Management.Automation.MethodInvocationException: Exception calling &#34;Reverse&#34; with &#34;1&#34; argument(s): &#34;Value cannot be null.
</span></span><span style=display:flex><span>Parameter name: array&#34; ---&gt; System.ArgumentNullException: Value cannot be null.
</span></span><span style=display:flex><span>Parameter name: array
</span></span><span style=display:flex><span>   at System.Array.Reverse(Array array)
</span></span><span style=display:flex><span>   at CallSite.Target(Closure , CallSite , Type , Object )
</span></span><span style=display:flex><span>   --- End of inner exception stack trace ---
</span></span><span style=display:flex><span>   at System.Management.Automation.ExceptionHandlingOps.ConvertToMethodInvocationException(Exception exception, Type typeToThrow, String methodName, Int32 numArgs, MemberInfo memberInfo)
</span></span><span style=display:flex><span>   at CallSite.Target(Closure , CallSite , Type , Object )
</span></span><span style=display:flex><span>   at System.Dynamic.UpdateDelegates.UpdateAndExecute2[T0,T1,TRet](CallSite site, T0 arg0, T1 arg1)
</span></span><span style=display:flex><span>   at System.Management.Automation.Interpreter.DynamicInstruction`3.Run(InterpretedFrame frame)
</span></span><span style=display:flex><span>   at System.Management.Automation.Interpreter.EnterTryCatchFinallyInstruction.Run(InterpretedFrame frame)&#34;.
</span></span></code></pre></td></tr></table></div></div><p>Okay, so the setup tried to execute <code>ServiceControl.ps1</code>. Where is that script located&mldr;? I don&rsquo;t know right now, but I&rsquo;ll find out later.</p><h2 id=check-exchange-server-setup-log>Check Exchange Server Setup Log<a hidden class=anchor aria-hidden=true href=#check-exchange-server-setup-log>#</a></h2><p>Let&rsquo;s first check the Exchange Server Setup Log, at <code>C:\ExchangeSetupLogs\ExchangeSetup.log</code>.
In the log there is some more context of the previously failed command. So the variable <code>$RoleRoles</code> (nice name) is certainly not empty:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[06/22/2022 07:20:25.0377] [1] Executing: $RoleRoles = &#39;LanguagePacksRole,BridgeheadRole,ClientAccessRole,UnifiedMessagingRole,MailboxRole,FrontendTransportRole,CafeRole&#39;
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>[06/22/2022 07:20:25.0383] [1] Executing:
</span></span><span style=display:flex><span>$roleList = $RoleRoles.Replace(&#39;Role&#39;,&#39;&#39;).Split(&#39;,&#39;);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          if($roleList -contains &#39;LanguagePacks&#39;)
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            &amp; $RoleBinPath\ServiceControl.ps1 Save
</span></span><span style=display:flex><span>            &amp; $RoleBinPath\ServiceControl.ps1 DisableServices $roleList;
</span></span><span style=display:flex><span>            &amp; $RoleBinPath\ServiceControl.ps1 Stop $roleList;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>[06/22/2022 07:20:25.0332] [1] Writing informational script to &#39;C:\ExchangeSetupLogs\Start-PreFileCopy-20220622-0720250331374206211.ps1&#39;
</span></span></code></pre></td></tr></table></div></div><h2 id=check-start-prefilecopyps1>Check Start-PreFileCopy[&mldr;].ps1<a hidden class=anchor aria-hidden=true href=#check-start-prefilecopyps1>#</a></h2><p>The Setup also created a script to replicate that command. Neat! I navigated to the file at <code>C:\ExchangeSetupLogs\Start-PreFileCopy-20220622-0720250331374206211.ps1</code>.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#6c7986># Default Start steps for PreFileCopy.</span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Programmatically generated on 6/22/2022 7:20:25 AM.</span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#</span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Variable Declarations</span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleBinPath</span> = <span style=color:#fc6a5d>&#39;X:\ExchangeServer\Bin&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleDatacenterPath</span> = <span style=color:#fc6a5d>&#39;X:\ExchangeServer\Datacenter&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleDatacenterServiceEndpointABCHContactService</span> = <span style=color:#fc6a5d>&#39;&lt;ServiceEndpoint&gt;&lt;Url&gt;http://pvt-contacts.msn.com/abservice/abservice.asmx&lt;/Url&gt;&lt;/ServiceEndpoint&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleDatacenterServiceEndpointDomainPartnerManageDelegation</span> = <span style=color:#fc6a5d>&#39;&lt;ServiceEndpoint&gt;&lt;Url&gt;https://domains.live.com/service/managedelegation.asmx&lt;/Url&gt;&lt;/ServiceEndpoint&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleDatacenterServiceEndpointDomainPartnerManageDelegation2</span> = <span style=color:#fc6a5d>&#39;&lt;ServiceEndpoint&gt;&lt;Url&gt;https://domains.live.com/service/managedelegation2.asmx&lt;/Url&gt;&lt;/ServiceEndpoint&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleDatacenterServiceEndpointLiveFederationMetadata</span> = <span style=color:#fc6a5d>&#39;&lt;ServiceEndpoint&gt;&lt;Url&gt;https://nexus.passport.com/FederationMetadata/2006-12/FederationMetadata.xml&lt;/Url&gt;&lt;/ServiceEndpoint&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleDatacenterServiceEndpointLiveGetUserRealm</span> = <span style=color:#fc6a5d>&#39;&lt;ServiceEndpoint&gt;&lt;Url&gt;https://login.live.com/GetUserRealm.srf&lt;/Url&gt;&lt;/ServiceEndpoint&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleDatacenterServiceEndpointLiveServiceLogin2</span> = <span style=color:#fc6a5d>&#39;&lt;ServiceEndpoint&gt;&lt;Url&gt;https://login.live.com/RST2.srf&lt;/Url&gt;&lt;/ServiceEndpoint&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleDatacenterServiceEndpointMsoFederationMetadata</span> = <span style=color:#fc6a5d>&#39;&lt;ServiceEndpoint&gt;&lt;Url&gt;https://nexus.microsoftonline-p.com/FederationMetadata/2006-12/FederationMetadata.xml&lt;/Url&gt;&lt;/ServiceEndpoint&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleInstallationMode</span> = <span style=color:#fc6a5d>&#39;Install&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleInstallPath</span> = <span style=color:#fc6a5d>&#39;X:\ExchangeServer\&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleInvocationID</span> = <span style=color:#fc6a5d>&#39;20220622-0720250331374206211&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleIsDatacenter</span> = $False
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleIsDatacenterDedicated</span> = $False
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleIsFfo</span> = $False
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleIsPartnerHosted</span> = $False
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleLoggingPath</span> = <span style=color:#fc6a5d>&#39;X:\ExchangeServer\Logging&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleProductPlatform</span> = <span style=color:#fc6a5d>&#39;amd64&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleRoles</span> = <span style=color:#fc6a5d>&#39;LanguagePacksRole,BridgeheadRole,ClientAccessRole,UnifiedMessagingRole,MailboxRole,FrontendTransportRole,CafeRole&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleSetupLoggingPath</span> = <span style=color:#fc6a5d>&#39;C:\ExchangeSetupLogs&#39;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$RoleTargetVersion</span> = <span style=color:#fc6a5d>&#39;15.01.2507.006&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#</span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Component tasks</span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#</span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Tasks for &#39;All Roles Pre File Copy&#39; component</span>
</span></span><span style=display:flex><span><span style=color:#6c7986># [ID = AllRolesPreFileCopyComponent___2f7e3804a2b340c69e930798211fb8fd, Wt = 10, isFatal = True] &#34;Stopping services&#34;</span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#6/22/2022 7:20:25 AM:</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$roleList</span> = <span style=color:#41a1c0>$RoleRoles</span>.Replace(<span style=color:#fc6a5d>&#39;Role&#39;</span>,<span style=color:#fc6a5d>&#39;&#39;</span>).Split(<span style=color:#fc6a5d>&#39;,&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#fc5fa3>if</span>(<span style=color:#41a1c0>$roleList</span> -contains <span style=color:#fc6a5d>&#39;LanguagePacks&#39;</span>)
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            &amp; <span style=color:#41a1c0>$RoleBinPath</span>\ServiceControl.ps1 Save
</span></span><span style=display:flex><span>            &amp; <span style=color:#41a1c0>$RoleBinPath</span>\ServiceControl.ps1 DisableServices <span style=color:#41a1c0>$roleList</span>;
</span></span><span style=display:flex><span>            &amp; <span style=color:#41a1c0>$RoleBinPath</span>\ServiceControl.ps1 Stop <span style=color:#41a1c0>$roleList</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          };
</span></span></code></pre></td></tr></table></div></div><p>I had to comment out one line which was just plaintext with the date/time (above <code>$roleList = [...]</code>). I then tried to manually run that script.
And surely I got the same error as the setup before, but with slightly more details. The error occurs in line 302 of <code>ServiceControl.ps1</code>. And now I also know where that <code>ServiceControl.ps1</code> script actually resided. Nice.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>PS </span>F:\Setup\ServerRoles\Common&gt; C:\ExchangeSetupLogs\<span style=color:#d0a8ff>Start-PreFileCopy</span>-<span style=color:#d0bf69>20220622</span>-<span style=color:#d0bf69>0720250331374206211</span>.ps1
</span></span><span style=display:flex><span>Exception calling <span style=color:#fc6a5d>&#34;Reverse&#34;</span> with <span style=color:#fc6a5d>&#34;1&#34;</span> argument(s)<span style=color:#960050>:</span> <span style=color:#fc6a5d>&#34;Value cannot be null.
</span></span></span><span style=display:flex><span><span style=color:#fc6a5d>Parameter name: array&#34;</span>
</span></span><span style=display:flex><span>At X:\ExchangeServer\Bin\ServiceControl.ps1<span style=color:#960050>:</span><span style=color:#d0bf69>302</span> char<span style=color:#960050>:</span><span style=color:#d0bf69>2</span>
</span></span><span style=display:flex><span>+     [array]::Reverse(<span style=color:#41a1c0>$services</span>)
</span></span><span style=display:flex><span>+     ~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span></span><span style=display:flex><span>    + CategoryInfo          <span style=color:#960050>:</span> NotSpecified<span style=color:#960050>:</span> (<span style=color:#960050>:</span>) [], MethodInvocationException
</span></span><span style=display:flex><span>    + FullyQualifiedErrorId <span style=color:#960050>:</span> ArgumentNullException
</span></span></code></pre></td></tr></table></div></div><h2 id=check-servicecontrolps1>Check ServiceControl.ps1<a hidden class=anchor aria-hidden=true href=#check-servicecontrolps1>#</a></h2><p>So <code>ServiceControl.ps1</code> resides in the Exchange Server <code>Bin</code>-directory. Well that&rsquo;s easy. Let&rsquo;s look at that script. Line 301/302 are:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>    <span style=color:#41a1c0>$services</span> = <span style=color:#d0a8ff>Get-ServiceToControl</span> <span style=color:#41a1c0>$Roles</span> -Active
</span></span><span style=display:flex><span>    [array]::Reverse(<span style=color:#41a1c0>$services</span>)
</span></span></code></pre></td></tr></table></div></div><p>So the reversing of <code>$services</code> fails. The error message from before told us the issue already: <code>Value cannot be null</code>. So is it really null? I&rsquo;ve set a PowerShell Debugging Breakpoint with the PowerShell ISE to see for myself.</p><p><a href=/images/2022/2022-06-22_Exchange_Server_setup_debug_servicecontrol_ps1.png><img loading=lazy src=/images/2022/2022-06-22_Exchange_Server_setup_debug_servicecontrol_ps1.png alt="Exchange Server 2016 CU23 Setup - Debugging ServiceControl.ps1 with PowerShell ISE" title="Exchange Server 2016 CU23 Setup - Debugging ServiceControl.ps1 with PowerShell ISE"></a></p><p>OKAY, it is empty. What did I even expect here?
Then I looked at the definition of the function <code>Get-ServiceToControl</code>, which starts at line 105.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#6c7986># Get-ServiceToControl</span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#  Returns list of service(s) to control.</span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#  Arguments:</span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#   $Roles - list of Exchange roles.</span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#   $Active - indicates that only non-stopped service should be returned.</span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Returns:</span>
</span></span><span style=display:flex><span><span style=color:#6c7986>#  Service(s) to control.</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>function</span> <span style=color:#d0a8ff>Get-ServiceToControl</span> ([string[]]<span style=color:#41a1c0>$Roles</span>, [switch]<span style=color:#41a1c0>$Active</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#6c7986># 1. Populate full list of services for all roles.</span>
</span></span><span style=display:flex><span>    &amp; {
</span></span><span style=display:flex><span>        <span style=color:#6c7986># 1.a. Get common ones.</span>
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>if</span> ((<span style=color:#41a1c0>$Roles</span> -notcontains <span style=color:#fc6a5d>&#39;Critical&#39;</span>) -and (<span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Common&#39;</span>]))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Common&#39;</span>]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6c7986># 1.b. Get services for each role.</span>
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$Roles</span> |
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>foreach</span> {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>if</span> (<span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#41a1c0>$_</span>])
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#41a1c0>$_</span>]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } |
</span></span><span style=display:flex><span>    <span style=color:#6c7986># 2. Eliminate duplicates.</span>
</span></span><span style=display:flex><span>    <span style=color:#d0a8ff>sort </span>| unique |
</span></span><span style=display:flex><span>    <span style=color:#6c7986># 3. Filter only those which are installed</span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986># and (optionally) running.</span>
</span></span><span style=display:flex><span>    <span style=color:#d0a8ff>where </span>{
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$serviceName</span> = <span style=color:#41a1c0>$_</span>
</span></span><span style=display:flex><span>        <span style=color:#6c7986># 3.a. Check if installed.</span>
</span></span><span style=display:flex><span>        <span style=color:#6c7986># Note the trick of requesting by pattern prevents Get-Service</span>
</span></span><span style=display:flex><span>        <span style=color:#6c7986># from failing in case service is not installed.</span>
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Get-Service</span> <span style=color:#fc6a5d>&#34;</span><span style=color:#41a1c0>$serviceName</span><span style=color:#fc6a5d>*&#34;</span> |
</span></span><span style=display:flex><span>        ?{<span style=color:#41a1c0>$_</span>.Name -eq <span style=color:#41a1c0>$serviceName</span>} |
</span></span><span style=display:flex><span>        <span style=color:#6c7986># 3.b. If $Active is specified, check that service is not stopped.</span>
</span></span><span style=display:flex><span>        ?{!<span style=color:#41a1c0>$Active</span> -or <span style=color:#41a1c0>$_</span>.Status -ne <span style=color:#fc6a5d>&#39;Stopped&#39;</span>}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>That function is using the variable <code>$script:servicesToControl</code>. That again is defined starting at line 56.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span> = @{}
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Common&#39;</span>]             = @( <span style=color:#fc6a5d>&#39;WinMgmt&#39;</span>, <span style=color:#fc6a5d>&#39;RemoteRegistry&#39;</span>, <span style=color:#fc6a5d>&#39;HealthService&#39;</span>, <span style=color:#fc6a5d>&#39;OnePoint&#39;</span>, <span style=color:#fc6a5d>&#39;MOM&#39;</span>, <span style=color:#fc6a5d>&#39;OMCFG&#39;</span>, <span style=color:#fc6a5d>&#39;pla&#39;</span> )
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;ClientAccess&#39;</span>]       = @( <span style=color:#fc6a5d>&#39;MSExchangeMonitoring&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeIMAP4&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangePOP3&#39;</span> , <span style=color:#fc6a5d>&#39;MSExchangeADTopology&#39;</span> ,<span style=color:#fc6a5d>&#39;MSExchangeTopologyService&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeFDS&#39;</span>, <span style=color:#fc6a5d>&#39;IISAdmin&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeServiceHost&#39;</span>, <span style=color:#fc6a5d>&#39;W3Svc&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeRPC&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeIMAP4BE&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangePOP3BE&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeMailboxReplication&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeFBA&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeProtectedServiceHost&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDiagnostics&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHMRecovery&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Gateway&#39;</span>]            = @( <span style=color:#fc6a5d>&#39;MSExchangeMonitoring&#39;</span>, <span style=color:#fc6a5d>&#39;WorkerService&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeTransport&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeTransportLogSearch&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeEdgeSync&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeAntispamUpdate&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeEdgeCredential&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeServiceHost&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHMRecovery&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDiagnostics&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Mailbox&#39;</span>]            = @( <span style=color:#fc6a5d>&#39;MSExchangeMonitoring&#39;</span>, <span style=color:#fc6a5d>&#39;IISAdmin&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeIS&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeMailboxAssistants&#39;</span>, <span style=color:#fc6a5d>&#39;MSFTESQL-Exchange&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeThrottling&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeADTopology&#39;</span> ,<span style=color:#fc6a5d>&#39;MSExchangeTopologyService&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeRepl&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDagMgmt&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeWatchDog&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeTransportLogSearch&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeRPC&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeServiceHost&#39;</span>, <span style=color:#fc6a5d>&#39;W3Svc&#39;</span>, <span style=color:#fc6a5d>&#39;HTTPFilter&#39;</span>, <span style=color:#fc6a5d>&#39;wsbexchange&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeTransportSyncManagerSvc&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeFastSearch&#39;</span>, <span style=color:#fc6a5d>&#39;hostcontrollerservice&#39;</span>, <span style=color:#fc6a5d>&#39;SearchExchangeTracing&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeSubmission&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDelivery&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeMigrationWorkflow&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDiagnostics&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeProcessUtilizationManager&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHMRecovery&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeInferenceService&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Bridgehead&#39;</span>]         = @( <span style=color:#fc6a5d>&#39;MSExchangeMonitoring&#39;</span>, <span style=color:#fc6a5d>&#39;AdminService&#39;</span>, <span style=color:#fc6a5d>&#39;FMS&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeAntimalwareSvc&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeAntimalwareUpdateSvc&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeTransport&#39;</span> , <span style=color:#fc6a5d>&#39;MSExchangeADTopology&#39;</span> ,<span style=color:#fc6a5d>&#39;MSExchangeTopologyService&#39;</span>,  <span style=color:#fc6a5d>&#39;MSExchangeEdgeSync&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeProtectedServiceHost&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeTransportLogSearch&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeTransportStreamingOptics&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeAntispamUpdate&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeServiceHost&#39;</span>, <span style=color:#fc6a5d>&#39;hostcontrollerservice&#39;</span>, <span style=color:#fc6a5d>&#39;SearchExchangeTracing&#39;</span>, <span style=color:#fc6a5d>&#39;W3Svc&#39;</span>, <span style=color:#fc6a5d>&#39;shm&#39;</span>, <span style=color:#fc6a5d>&#39;MSMessageTracingClient&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeFileUpload&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDiagnostics&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeProcessUtilizationManager&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHMRecovery&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeStreamingOptics&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;UnifiedMessaging&#39;</span>]   = @( <span style=color:#fc6a5d>&#39;MSExchangeMonitoring&#39;</span>, <span style=color:#fc6a5d>&#39;Exchange UM Service&#39;</span> , <span style=color:#fc6a5d>&#39;MSExchangeADTopology&#39;</span> ,<span style=color:#fc6a5d>&#39;MSExchangeTopologyService&#39;</span>,  <span style=color:#fc6a5d>&#39;MSExchangeFDS&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeUM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeServiceHost&#39;</span>, <span style=color:#fc6a5d>&#39;W3Svc&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDiagnostics&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHMRecovery&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;FrontendTransport&#39;</span>]  = @( <span style=color:#fc6a5d>&#39;MSExchangeMonitoring&#39;</span>, <span style=color:#fc6a5d>&#39;AdminService&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeTransport&#39;</span> , <span style=color:#fc6a5d>&#39;MSExchangeADTopology&#39;</span> ,<span style=color:#fc6a5d>&#39;MSExchangeTopologyService&#39;</span>,  <span style=color:#fc6a5d>&#39;MSExchangeEdgeSync&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeProtectedServiceHost&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeTransportLogSearch&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeAntispamUpdate&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeServiceHost&#39;</span>, <span style=color:#fc6a5d>&#39;W3Svc&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeFrontendTransport&#39;</span>, <span style=color:#fc6a5d>&#39;shm&#39;</span>, <span style=color:#fc6a5d>&#39;MSMessageTracingClient&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeFileUpload&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDiagnostics&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeProcessUtilizationManager&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHMRecovery&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Cafe&#39;</span>]               = @( <span style=color:#fc6a5d>&#39;MSExchangeMonitoring&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDiagnostics&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeProcessUtilizationManager&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHMRecovery&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Monitoring&#39;</span>]         = @( <span style=color:#fc6a5d>&#39;MSExchangeCAMOMConnector&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeMonitoringCorrelation&#39;</span> )
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;CentralAdmin&#39;</span>]       = @( <span style=color:#fc6a5d>&#39;MSExchangeCentralAdmin&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeMonitoringCorrelation&#39;</span>, <span style=color:#fc6a5d>&#39;WDSServer&#39;</span>, <span style=color:#fc6a5d>&#39;MSDTC&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeDiagnostics&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHMRecovery&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;OSP&#39;</span>]                = @( <span style=color:#fc6a5d>&#39;IISAdmin&#39;</span>, <span style=color:#fc6a5d>&#39;W3Svc&#39;</span>,<span style=color:#fc6a5d>&#39;MSExchangeADTopology&#39;</span> ,<span style=color:#fc6a5d>&#39;MSExchangeTopologyService&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeMonitoring&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHM&#39;</span>, <span style=color:#fc6a5d>&#39;MSExchangeHMRecovery&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;FfoWebService&#39;</span>]      = @( <span style=color:#fc6a5d>&#39;MSExchangeProcessUtilizationManager&#39;</span>,<span style=color:#fc6a5d>&#39;MSExchangeADTopology&#39;</span>,<span style=color:#fc6a5d>&#39;MSExchangeProtectedServiceHost&#39;</span>,<span style=color:#fc6a5d>&#39;MSExchangeServiceHost&#39;</span>,<span style=color:#fc6a5d>&#39;W3Svc&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;LanguagePacks&#39;</span>]      = <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;AdminTools&#39;</span>] +
</span></span><span style=display:flex><span>                                                  <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;ClientAccess&#39;</span>] +
</span></span><span style=display:flex><span>                                                  <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Gateway&#39;</span>] +
</span></span><span style=display:flex><span>                                                  <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Mailbox&#39;</span>] +
</span></span><span style=display:flex><span>                                                  <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Bridgehead&#39;</span>] +
</span></span><span style=display:flex><span>                                                  <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;UnifiedMessaging&#39;</span>] +
</span></span><span style=display:flex><span>                                                  <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Cafe&#39;</span>] +
</span></span><span style=display:flex><span>                                                  <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;FrontendTransport&#39;</span>] +
</span></span><span style=display:flex><span>                                                  <span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;OSP&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># List of critical services required for prereqs.</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$script:servicesToControl</span>[<span style=color:#fc6a5d>&#39;Critical&#39;</span>]           = @( <span style=color:#fc6a5d>&#39;WinMgmt&#39;</span>, <span style=color:#fc6a5d>&#39;RemoteRegistry&#39;</span>, <span style=color:#fc6a5d>&#39;W3Svc&#39;</span>, <span style=color:#fc6a5d>&#39;IISAdmin&#39;</span> )
</span></span></code></pre></td></tr></table></div></div><p>Ah okay, these are the actual Windows Service names for each Exchange Server Role. But that doesn&rsquo;t really help now. So one step back to <code>Get-ServiceToControl</code>.
Oh yeah wait. So if <code>$Active</code> is set, only Windows Services that are not in the <code>Status</code> of <code>Stopped</code> are getting returned. Because of the failed Setup, most Exchange Services are <code>Disabled</code> and surely none are running.</p><p><a href=/images/2022/2022-06-22_Exchange_Server_Services_are_stopped.png><img loading=lazy src=/images/2022/2022-06-22_Exchange_Server_Services_are_stopped.png alt="Exchange Server 2016 - Services are not running" title="Exchange Server 2016 - Services are not running"></a></p><p>So&mldr; Could it be that easy? I imagine: If atleast <strong>ONE</strong> Exchange Service was running, <code>Get-ServiceToControl</code> would <strong>NOT</strong> return an empty response, so the <code>[array]::Reverse($services)</code> would <strong>NOT</strong> fail. Then the procedure of &ldquo;Stopping Exchange Services&rdquo; should be deemed successful - right?</p><h2 id=manually-starting-an-exchange-service>Manually starting an Exchange Service<a hidden class=anchor aria-hidden=true href=#manually-starting-an-exchange-service>#</a></h2><p>So opened <code>services.msc</code> to enable and start the <code>Microsoft Exchange Active Directory Topology</code> Service (<code>MSExchangeADTopology</code>).</p><p><a href=/images/2022/2022-06-22_Exchange_Server_enable_service.png><img loading=lazy src=/images/2022/2022-06-22_Exchange_Server_enable_service.png alt="Exchange Server 2016 - Enabling a service manually in services.msc" title="Exchange Server 2016 - Enabling a service manually in services.msc"></a></p><h2 id=re-run-start-prefilecopyps1>Re-run Start-PreFileCopy[&mldr;].ps1<a hidden class=anchor aria-hidden=true href=#re-run-start-prefilecopyps1>#</a></h2><p>I tried to re-run <code>Start-PreFileCopy-20220622-0720250331374206211.ps1</code>. It actually failed now with a different error. But that looks like missing dependencies/functions from the setup environment. Nothing too concerning.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Stop-SetupService</span> <span style=color:#960050>:</span> The term <span style=color:#fc6a5d>&#39;Stop-SetupService&#39;</span> is not recognized as the name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or <span style=color:#fc5fa3>if</span> a path was included, verify that the path is correct and <span style=color:#fc5fa3>try</span> again.
</span></span><span style=display:flex><span>At X:\ExchangeServer\Bin\ServiceControl.ps1<span style=color:#960050>:</span><span style=color:#d0bf69>342</span> char<span style=color:#960050>:</span><span style=color:#d0bf69>3</span>
</span></span><span style=display:flex><span>+         <span style=color:#d0a8ff>Stop-SetupService</span> -ServiceName <span style=color:#41a1c0>$serviceName</span> -ev script<span style=color:#960050>:</span>servic ...
</span></span><span style=display:flex><span>+         ~~~~~~~~~~~~~~~~~
</span></span><span style=display:flex><span>    + CategoryInfo          <span style=color:#960050>:</span> ObjectNotFound<span style=color:#960050>:</span> (<span style=color:#d0a8ff>Stop-SetupService</span><span style=color:#960050>:</span>String) [], CommandNotFoundException
</span></span><span style=display:flex><span>    + FullyQualifiedErrorId <span style=color:#960050>:</span> CommandNotFoundException
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Cannot index into a null array.
</span></span><span style=display:flex><span>At X:\ExchangeServer\Bin\ServiceControl.ps1<span style=color:#960050>:</span><span style=color:#d0bf69>343</span> char<span style=color:#960050>:</span><span style=color:#d0bf69>7</span>
</span></span><span style=display:flex><span>+         <span style=color:#fc5fa3>if</span>( <span style=color:#41a1c0>$script:serviceControlError</span>[<span style=color:#d0bf69>0</span>] -ne $null )
</span></span><span style=display:flex><span>+             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span></span><span style=display:flex><span>    + CategoryInfo          <span style=color:#960050>:</span> InvalidOperation<span style=color:#960050>:</span> (<span style=color:#960050>:</span>) [], RuntimeException
</span></span><span style=display:flex><span>    + FullyQualifiedErrorId <span style=color:#960050>:</span> NullArray
</span></span></code></pre></td></tr></table></div></div><h2 id=re-run-exchange-server-setup>Re-run Exchange Server Setup<a hidden class=anchor aria-hidden=true href=#re-run-exchange-server-setup>#</a></h2><p>So it just might work now, if running from within the Setup context. So I tried. Already looked promising after a bit, because it&rsquo;s now at Step 2. I went to take break.</p><p><a href=/images/2022/2022-06-22_Exchange_Server_setup_copy_exchange_files.png><img loading=lazy src=/images/2022/2022-06-22_Exchange_Server_setup_copy_exchange_files.png alt="Exchange Server 2016 CU23 Setup Assistant - Step 2 Copy Exchange Files running" title="Exchange Server 2016 CU23 Setup Assistant - Step 2 Copy Exchange Files running"></a></p><p>When I came back, there was no Exchange Setup running anymore. Weird. Did it crash? I checked the <code>C:\ExchangeSetupLogs\ExchangeSetup.log</code> file again. Looks good now:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[06/22/2022 10:07:00.0062] [2] Install is complete.  Server state has been set to Active.
</span></span><span style=display:flex><span>[06/22/2022 10:07:00.0063] [2] Ending processing Write-ExchangeSetupLog
</span></span><span style=display:flex><span>[06/22/2022 10:07:00.0064] [1] Finished executing component tasks.
</span></span><span style=display:flex><span>[06/22/2022 10:07:00.0068] [1] Ending processing Start-PostSetup
</span></span><span style=display:flex><span>[06/22/2022 10:07:00.0102] [0] CurrentResult setupbase.maincore:396: 0
</span></span><span style=display:flex><span>[06/22/2022 10:07:00.0103] [0] End of Setup
</span></span><span style=display:flex><span>[06/22/2022 10:07:00.0103] [0] **********************************************
</span></span></code></pre></td></tr></table></div></div><h2 id=verify>Verify<a hidden class=anchor aria-hidden=true href=#verify>#</a></h2><p>First I looked if the Services are now enabled and running as they should. Looks good.</p><p><a href=/images/2022/2022-06-22_Exchange_Server_Services_are_running.png><img loading=lazy src=/images/2022/2022-06-22_Exchange_Server_Services_are_running.png alt="Exchange Server 2016 - Services are running again" title="Exchange Server 2016 - Services are running again"></a></p><p>Then I ran the Exchange Management Shell to run <code>Get-ExchangeServer</code>. Looks good aswell.</p><p><a href=/images/2022/2022-06-22_Exchange_Server_management_shell_working.png><img loading=lazy src=/images/2022/2022-06-22_Exchange_Server_management_shell_working.png alt="Exchange Server 2016 - Exchange Management Shell is running" title="Exchange Server 2016 - Exchange Management Shell is running"></a></p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><ol><li><p>Really weird how that check is implemented. IMO Microsoft could improve the Setup Experience here, if the Setup checks if there are any Services that are running and actually need to get stopped. Instead it crashes now, if there are no running Exchange Services.</p></li><li><p>I mean afterwards it always seems easy and obvious. But maybe I could&rsquo;ve gotten to the goal faster if I had drawn a direct conclusion of the facts</p><ul><li>Setup fails at the step &ldquo;Stopping Services&rdquo;</li><li>No Exchange Services are running</li><li>= Thus no Services can get <strong>stopped</strong></li></ul></li></ol><h3 id=sidenote>Sidenote<a hidden class=anchor aria-hidden=true href=#sidenote>#</a></h3><p>In the Microsoft Exchange context <code>Cafe</code> stands for &ldquo;Client Access Front End&rdquo;. I was somehow not aware of that abbreviation.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://diecknet.de/en/tags/exchange/>Exchange</a></li><li><a href=https://diecknet.de/en/tags/exchange-server-setup/>Exchange Server Setup</a></li><li><a href=https://diecknet.de/en/tags/troubleshooting/>Troubleshooting</a></li><li><a href=https://diecknet.de/en/tags/powershell/>Powershell</a></li></ul><div class=share-buttons></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://diecknet.de/en/>diecknet</a></span>
&nbsp;|&nbsp;
<span><a href=https://diecknet.de/en/legal/>Imprint</a>
</span>&nbsp;|&nbsp;<span>
<a href=https://diecknet.de/en/privacy/>Privacy</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript>var _paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="//nc.diecknet.de/mt/",_paq.push(["setTrackerUrl",t+"mdata"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.defer=!0,e.src=t+"m.js",s.parentNode.insertBefore(e,s)}()</script><noscript><p><img src="https://nc.diecknet.de/mt/mdata?idsite=1&amp;rec=1" style=border:0 alt></p></noscript></body></html>