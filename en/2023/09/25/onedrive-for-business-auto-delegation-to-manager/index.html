<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OneDrive for Business - Delegation to Manager after employee leaves company | diecknet</title>
<meta name=keywords content="onedrive,onedrive for business,sharepoint online,my site"><meta name=description content="Normally when a user leaves the Company their OneDrive for Business site gets automatically delegated to their manager. That means the manager gets SharePoint Site Collection admin rights to the OneDrive site of their subordinate.
Checking and Changing Access Delegation ⚠️ Access Delegation is enabled as default. The setting can be found and changed here:
Go to More features in the new SharePoint admin center, and sign in with an account that has admin permissions for your organization."><meta name=author content="Andreas Dieckmann"><link rel=canonical href=https://diecknet.de/en/2023/09/25/onedrive-for-business-auto-delegation-to-manager/><link crossorigin=anonymous href=/assets/css/stylesheet.75a517428f403193483801122d6350f6956c3bb6bf5c6504311f8c24e6bab3e7.css integrity="sha256-daUXQo9AMZNIOAESLWNQ9pVsO7a/XGUEMR+MJOa6s+c=" rel="preload stylesheet" as=style><link rel=icon href=https://diecknet.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://diecknet.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://diecknet.de/favicon-32x32.png><link rel=apple-touch-icon href=https://diecknet.de/apple-touch-icon.png><link rel=mask-icon href=https://diecknet.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://diecknet.de/en/2023/09/25/onedrive-for-business-auto-delegation-to-manager/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="OneDrive for Business - Delegation to Manager after employee leaves company"><meta property="og:description" content="Normally when a user leaves the Company their OneDrive for Business site gets automatically delegated to their manager. That means the manager gets SharePoint Site Collection admin rights to the OneDrive site of their subordinate.
Checking and Changing Access Delegation ⚠️ Access Delegation is enabled as default. The setting can be found and changed here:
Go to More features in the new SharePoint admin center, and sign in with an account that has admin permissions for your organization."><meta property="og:type" content="article"><meta property="og:url" content="https://diecknet.de/en/2023/09/25/onedrive-for-business-auto-delegation-to-manager/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-25T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="OneDrive for Business - Delegation to Manager after employee leaves company"><meta name=twitter:description content="Normally when a user leaves the Company their OneDrive for Business site gets automatically delegated to their manager. That means the manager gets SharePoint Site Collection admin rights to the OneDrive site of their subordinate.
Checking and Changing Access Delegation ⚠️ Access Delegation is enabled as default. The setting can be found and changed here:
Go to More features in the new SharePoint admin center, and sign in with an account that has admin permissions for your organization."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://diecknet.de/en/posts/"},{"@type":"ListItem","position":2,"name":"OneDrive for Business - Delegation to Manager after employee leaves company","item":"https://diecknet.de/en/2023/09/25/onedrive-for-business-auto-delegation-to-manager/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OneDrive for Business - Delegation to Manager after employee leaves company","name":"OneDrive for Business - Delegation to Manager after employee leaves company","description":"Normally when a user leaves the Company their OneDrive for Business site gets automatically delegated to their manager. That means the manager gets SharePoint Site Collection admin rights to the OneDrive site of their subordinate.\nChecking and Changing Access Delegation ⚠️ Access Delegation is enabled as default. The setting can be found and changed here:\nGo to More features in the new SharePoint admin center, and sign in with an account that has admin permissions for your organization.","keywords":["onedrive","onedrive for business","sharepoint online","my site"],"articleBody":"Normally when a user leaves the Company their OneDrive for Business site gets automatically delegated to their manager. That means the manager gets SharePoint Site Collection admin rights to the OneDrive site of their subordinate.\nChecking and Changing Access Delegation ⚠️ Access Delegation is enabled as default. The setting can be found and changed here:\nGo to More features in the new SharePoint admin center, and sign in with an account that has admin permissions for your organization. […] Under User profiles, select Open. Under My Site Settings, select Setup My Sites. Next to My Site Cleanup, make sure Enable access delegation is selected. (Source: https://learn.microsoft.com/en-us/sharepoint/retention-and-deletion#configure-automatic-access-delegation)\nIn some companies this might not be desired, so you can change that option if you want to. To disable it, uncheck the box next to “Enable access delegation”.\nHow does it look? When a user gets deleted and OneDrive access delegation is enabled, then the users’ manager receives a mail. Atleast in my Test-Tenant the E-Mail lacks any professional design. It’s just a wall of text:\nAdele Vance’s account has been deleted from the Active Directory. Their OneDrive for Business will be preserved for 30 days. You’re the temporary owner of all documents saved to their OneDrive for Business. If you would like to save content beyond the 30 day retention period, you can copy important documents to another location. You can also contact your administrator to reassign ownership to another OneDrive for Business owner. After 30 days, Adele Vance’s OneDrive for Business will be permanently deleted. Go to Adele Vance’s OneDrive for Business at https://diecknetdemotenant-my.sharepoint.com/personal/adelev_yr2z8_onmicrosoft_com/Documents/Forms/All.aspx\nAnd then 7 days before the OneDrive gets deleted the manager receives a reminder:\nAdele Vance’s OneDrive for Business is scheduled for permanent deletion in 7 days. You still have time to copy important documents to another location. After 7 days, Adele Vance’s OneDrive for Business will be permanently deleted. Go to Adele Vance’s OneDrive for Business at https://diecknetdemotenant-my.sharepoint.com/personal/adelev_yr2z8_onmicrosoft_com\nIf they then open the link, they can access all data in the OneDrive site.\nWho changed the “Enable access delegation” setting? If the setting in not in the state you expected, you might want to check the Microsoft 365 Admin Audit Log, if someone changed it in the past. Sadly the option is not available under “Activities - friendly names”. You need to search by “Activities - operation names” for AccessDelegationOnMySiteCleaneupEnabledSet.\nActivities - operation names Option in the GUI AccessDelegationOnMySiteCleaneupEnabledSet Enable access delegation SecondaryMySiteOwnerSet Secondary Owner I put this here, because (once again) I didn’t find proper Documentation from Microsoft regarding this topic.\nReporting on delegated OneDrives A client of mine stumbled about that setting and realized it was enabled, eventhough they have huge privacy concerns regarding it. It really depends on the company and their policies. They quickly changed the setting and asked me about a way to report which OneDrive sites are currently auto-delegated to a manager. And also to remove those delegations.\nTo gather the data I used PowerShell with the additional module Microsoft.Online.SharePoint.PowerShell. To compare it with the users in the tenant, I used the old AzureAD module. I also could’ve used the newer Microsoft.Graph module, but in this case it was easier to use the old stuff.\nI had the “SharePoint Administrator” admin role in the tenant, but I couldn’t read the permissions of the OneDrives sites with that. Apparently to even read the permissions of a SPO site, I had to add my admin account as a Site Collection Admin to every site. Kinda ironic that I had to do that, to find out about potential other admin assignments. I removed my permissions afterwards. So to collect all the data I used the following script.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 # Get-OneDriveOwner.ps1 # This script gathers info about additional (potentially unwanted) Site Collection Admin permissions for OneDrive for Business sites # The script is not really polished, use on your own risk Import-Module Microsoft.Online.SharePoint.PowerShell # change the SPO tenant name accordingly. For example \"demotenant\" $SPOTenantName = \"\" # set this to your admin user. For example \"admin@demotenant.de\" $SPOAdminUsername = \"\" # output file path (CSV file) $outputFile = \"C:\\temp\\OneDriveAdditionalManagers-$($SPOTenantName)-$(Get-Date -Format \"yyyy-MM-dd_HHmmss\").csv\" # insert spo tenant name Connect-SPOService -Url \"https://$($SPOTenantName)-admin.sharepoint.com\" # List all OneDrive Sites $AllOneDriveSites = Get-SPOSite -IncludePersonalSite $true -Limit all -Filter \"Url -like '-my.sharepoint.com/personal/'\" | Where-Object {$_.Title -ne \"RedirectSite\"} foreach($site in $AllOneDriveSites) { # temporarily add admin user as SPO site admin; suppress output try { $null = Set-SPOUser -Site $site.Url -LoginName $SPOAdminUsername -IsSiteCollectionAdmin $True } catch { $txt = \"Error while trying to add admin user $($SPOAdminUsername) to site $($site.Url)\" Write-Host $txt $txt | Out-file -FilePath \"$($outputFile)-LOG.txt\" -Append -Encoding utf8 # skip to next loop iteration continue } # get all user assignments for the current site $SiteUsers = Get-SPOUser -Site $site.Url -Limit All $additionalSiteUsers = $SiteUsers | Where-Object { $_.IsSiteAdmin -eq $true -and $_.LoginName -ne $SPOAdminUsername -and $_.DisplayName -ne $site.Title -and $_.IsGroup -eq $false } # Check if there are unexpected users added to the site if(($additionalSiteUsers | Measure-Object).Count -ne 0) { Write-Host \"Site '$($site.Title)' has $($additionalSiteUsers.Count) additional users.\" foreach($additionalSiteUser in $additionalSiteUsers) { Write-Host \"$($additionalSiteUser.DisplayName) ($($additionalSiteUser.LoginName))\" # custom object for output to csv [PSCustomObject]@{ \"SiteURL\" = $site.Url \"SiteTitle\" = $site.Title \"AdditionalUserDisplayName\" = $additionalSiteUser.DisplayName \"AdditionalUserLoginName\" = $additionalSiteUser.LoginName } | Export-Csv -Encoding utf8 -Delimiter \";\" -Append -NoTypeInformation -Path $outputFile } } # remove admin user from SPO/Onedrive site (we only added it temporarily) try { $null = Set-SPOUser -Site $site.Url -LoginName $SPOAdminUsername -IsSiteCollectionAdmin $false } catch { $txt = \"Error while trying to remove admin user $($SPOAdminUsername) from site $($site.Url)\" Write-Host $txt $txt | Out-file -FilePath \"$($outputFile)-LOG.txt\" -Append -Encoding utf8 } } I then had a CSV-file that I could check out in Excel. I realized that the file contains ALL additional assignments, even some legit ones. So I used the AzureAD PowerShell module to compare if the user account belonging to the OneDrive still existed. Normally a OneDrive4b site has the Name of the user as the site title. So I could use Get-AzureADUser to search for the SPO site title. Get-AzureADUser doesn’t return deleted users. If a user existed, the assignment was treated as legit, because it shouldn’t be an automatic delegation that happens when the user gets deleted.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # Compare-OneDriveSitesWithUsers.ps1 Connect-AzureAD # I also filtered out a specific service accounts that had access to many OneDrives. # if you don't have something similar, then you probably don't need the Where-Object part here $sites = Import-csv \"C:\\temp\\OneDriveAdditionalManagers-mytenant.csv\" -Encoding utf8 -Delimiter \";\" | Where-Object {$_.AdditionalUserLoginName -ne \"some-service-account@example.com\"} # Try to get AAD Users for each SPO site foreach($site in $sites) { Write-Host \"Searching for user $($site.SiteTitle)...\" # filtering out guests for some edge cases $user = Get-AzureADUser -SearchString $site.SiteTitle | Where-Object {$_.UserType -ne \"Guest\"} $resultCount = ($user | Measure-Object).Count if($resultCount -gt 1) { Write-Host \"$resultCount results for user $($site.SiteTitle)!\" $user } elseif($resultCount -eq 1) { Write-Host \"User exists! $($user.UserPrincipalName)\" $site | Add-Member -NotePropertyName \"UserStillExists\" -NotePropertyValue $true -Force } } # check $sites | ft SiteTitle,UserStillExists $sites | Where-Object {$_.UserStillExists -ne $true} | Measure-Object $sites | Where-Object {$_.UserStillExists -ne $true} | Export-Csv -Path C:\\temp\\OneDriveAdditionalManagers-NonExistingUsers.csv -Delimiter \";\" -Encoding utf8 Removing additional admins from OneDrive sites After checking that result, I used another script to actually remove the additional SPO site rights. Again I had to add my admin account as a SPO site collection admin. Then I first removed the site admin permissions of the manager user by calling Set-SPOUser -Site $site.SiteURL -LoginName $SPOAdminUsername -IsSiteCollectionAdmin $True. Afterwards I removed the user completely from the site with Remove-SPOUser -Site $site.SiteURL -LoginName $site.AdditionalUserLoginName. After being done with the site, I removed my admin permissions again.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 # Remove-AdditionalOneDriveOwners.ps1 Import-Module Microsoft.Online.SharePoint.PowerShell # change the SPO tenant name accordingly. For example \"demotenant\" $SPOTenantName = \"\" # set this to your admin user. For example \"admin@demotenant.de\" $SPOAdminUsername = \"\" # output log file path $outputFile = \"C:\\temp\\OneDriveAdditionalManagers-Cleanup-$($SPOTenantName)-$(Get-Date -Format \"yyyy-MM-dd_HHmmss\").txt\" # insert spo tenant name Connect-SPOService -Url \"https://$($SPOTenantName)-admin.sharepoint.com\" # import sites to clean from CSV file $SitesToClean = Import-Csv -Path \"C:\\temp\\OneDriveSitesToCleanPermissions.csv\" -Delimiter \";\" -Encoding utf8 foreach($site in $SitesToClean) { # temporarily add admin user as SPO site admin; suppress output try { $null = Set-SPOUser -Site $site.SiteURL -LoginName $SPOAdminUsername -IsSiteCollectionAdmin $True } catch { $txt = \"Error while trying to add admin user $($SPOAdminUsername) to site $($site.SiteURL)\" Write-Host $txt $txt | Out-file -FilePath $outputFile -Append -Encoding utf8 # skip to next loop iteration continue } # remove additional user from SPO site according to CSV file try { # first remove admin rights $null = Set-SPOUser -Site $site.SiteUrl -LoginName $site.AdditionalUserLoginName -IsSiteCollectionAdmin $false # then remove the user from the site Remove-SPOUser -Site $site.SiteURL -LoginName $site.AdditionalUserLoginName $txt = \"Removed user $($site.AdditionalUserLoginName) from site $($site.SiteURL).\" Write-Host $txt -ForegroundColor Green $txt | Out-file -FilePath $outputFile -Append -Encoding utf8 } catch { $txt = \"Error while trying to remove user $($site.AdditionalUserLoginName) from site $($site.SiteURL). Error details: $_\" Write-Host $txt -ForegroundColor Red $txt | Out-file -FilePath $outputFile -Append -Encoding utf8 } # remove admin user from SPO/Onedrive site (we only added it temporarily) try { $null = Set-SPOUser -Site $site.SiteURL -LoginName $SPOAdminUsername -IsSiteCollectionAdmin $false } catch { $txt = \"Error while trying to remove admin user $($SPOAdminUsername) from site $($site.SiteURL)\" Write-Host $txt $txt | Out-file -FilePath $outputFile -Append -Encoding utf8 } } ","wordCount":"1695","inLanguage":"en","datePublished":"2023-09-25T00:00:00Z","dateModified":"2023-09-25T00:00:00Z","author":{"@type":"Person","name":"Andreas Dieckmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diecknet.de/en/2023/09/25/onedrive-for-business-auto-delegation-to-manager/"},"publisher":{"@type":"Organization","name":"diecknet","logo":{"@type":"ImageObject","url":"https://diecknet.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diecknet.de/en/ accesskey=h title="diecknet (Alt + H)">diecknet</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://diecknet.de/de/ title=Deutsch aria-label=Deutsch>Deutsch</a></li><li><a href=https://diecknet.de/en/ title=English aria-label=English><b>English</b></a></li></ul></div></div><ul id=menu><li><a href=https://diecknet.de/en/ title=Home><span>Home</span></a></li><li><a href=https://diecknet.de/en/services/ title=Services><span>Services</span></a></li><li><a href=https://diecknet.de/en/about/ title=About><span>About</span></a></li><li><a href=https://diecknet.de/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://diecknet.de/en/archive/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://diecknet.de/en/>Home</a>&nbsp;»&nbsp;<a href=https://diecknet.de/en/posts/>Posts</a></div><h1 class=post-title>OneDrive for Business - Delegation to Manager after employee leaves company</h1><div class=post-meta><span title='2023-09-25 00:00:00 +0000 UTC'>2023-09-25</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Andreas Dieckmann&nbsp;|&nbsp;<a href=https://github.com/diecknet/diecknet-blog/tree/main/content/en/posts/2023/2023-09-25-OneDrive-for-Business-auto-delegation.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#checking-and-changing-access-delegation aria-label="Checking and Changing Access Delegation">Checking and Changing Access Delegation</a></li><li><a href=#how-does-it-look aria-label="How does it look?">How does it look?</a></li><li><a href=#who-changed-the-enable-access-delegation-setting aria-label="Who changed the &amp;ldquo;Enable access delegation&amp;rdquo; setting?">Who changed the &ldquo;Enable access delegation&rdquo; setting?</a></li><li><a href=#reporting-on-delegated-onedrives aria-label="Reporting on delegated OneDrives">Reporting on delegated OneDrives</a></li><li><a href=#removing-additional-admins-from-onedrive-sites aria-label="Removing additional admins from OneDrive sites">Removing additional admins from OneDrive sites</a></li></ul></div></details></div><div class=post-content><p>Normally when a user leaves the Company their OneDrive for Business site gets automatically delegated to their manager. That means the manager gets SharePoint Site Collection admin rights to the OneDrive site of their subordinate.</p><h2 id=checking-and-changing-access-delegation>Checking and Changing Access Delegation<a hidden class=anchor aria-hidden=true href=#checking-and-changing-access-delegation>#</a></h2><p><strong>⚠️ Access Delegation is enabled as default</strong>. The setting can be found and changed here:</p><blockquote><ol><li>Go to <strong>More features</strong> in the new SharePoint admin center, and sign in with an account that has admin permissions for your organization.
[&mldr;]</li><li>Under <strong>User profiles</strong>, select <strong>Open</strong>.</li><li>Under <strong>My Site Settings</strong>, select <strong>Setup My Sites</strong>.</li><li>Next to <strong>My Site Cleanup</strong>, make sure <strong>Enable access delegation</strong> is selected.</li></ol></blockquote><p>(Source: <a href=https://learn.microsoft.com/en-us/sharepoint/retention-and-deletion#configure-automatic-access-delegation target=_blank>https://learn.microsoft.com/en-us/sharepoint/retention-and-deletion#configure-automatic-access-delegation</a>)</p><p>In some companies this might not be desired, so you can change that option if you want to. To disable it, uncheck the box next to &ldquo;Enable access delegation&rdquo;.</p><p><a href=/images/2023/2023-09-25-MySiteSettings-Cleanup.jpg><img loading=lazy src=/images/2023/2023-09-25-MySiteSettings-Cleanup.jpg alt="SharePoint Online - My Site settings - Cleanup" title="SharePoint Online - My Site settings - Cleanup"></a></p><h2 id=how-does-it-look>How does it look?<a hidden class=anchor aria-hidden=true href=#how-does-it-look>#</a></h2><p>When a user gets deleted and OneDrive access delegation is <strong>enabled</strong>, then the users&rsquo; manager receives a mail. Atleast in my Test-Tenant the E-Mail lacks any professional design. It&rsquo;s just a wall of text:</p><p><a href=/images/2023/2023-09-25_OneDrive-Delegation-Infomail1.jpg><img loading=lazy src=/images/2023/2023-09-25_OneDrive-Delegation-Infomail1.jpg alt="Info E-Mail to a manager regarding OneDrive of a subordinate" title="Info E-Mail to a manager regarding OneDrive of a subordinate"></a></p><blockquote><p>Adele Vance&rsquo;s account has been deleted from the Active Directory. Their OneDrive for Business will be preserved for 30 days. You&rsquo;re the temporary owner of all documents saved to their OneDrive for Business. If you would like to save content beyond the 30 day retention period, you can copy important documents to another location. You can also contact your administrator to reassign ownership to another OneDrive for Business owner. After 30 days, Adele Vance&rsquo;s OneDrive for Business will be permanently deleted. Go to Adele Vance&rsquo;s OneDrive for Business at <a href=https://diecknetdemotenant-my.sharepoint.com/personal/adelev_yr2z8_onmicrosoft_com/Documents/Forms/All.aspx target=_blank>https://diecknetdemotenant-my.sharepoint.com/personal/adelev_yr2z8_onmicrosoft_com/Documents/Forms/All.aspx</a></p></blockquote><p>And then 7 days before the OneDrive gets deleted the manager receives a reminder:</p><p><a href=/images/2023/2023-09-25_OneDrive-Delegation-Infomail2.jpg><img loading=lazy src=/images/2023/2023-09-25_OneDrive-Delegation-Infomail2.jpg alt="Info E-Mail to a manager regarding expiring OneDrive of a subordinate" title="Info E-Mail to a manager regarding expiring OneDrive of a subordinate"></a></p><blockquote><p>Adele Vance&rsquo;s OneDrive for Business is scheduled for permanent deletion in 7 days. You still have time to copy important documents to another location. After 7 days, Adele Vance&rsquo;s OneDrive for Business will be permanently deleted. Go to Adele Vance&rsquo;s OneDrive for Business at <a href=https://diecknetdemotenant-my.sharepoint.com/personal/adelev_yr2z8_onmicrosoft_com target=_blank>https://diecknetdemotenant-my.sharepoint.com/personal/adelev_yr2z8_onmicrosoft_com</a></p></blockquote><p>If they then open the link, they can access all data in the OneDrive site.</p><h2 id=who-changed-the-enable-access-delegation-setting>Who changed the &ldquo;Enable access delegation&rdquo; setting?<a hidden class=anchor aria-hidden=true href=#who-changed-the-enable-access-delegation-setting>#</a></h2><p>If the setting in not in the state you expected, you might want to check the <a href=https://compliance.microsoft.com/auditlogsearch target=_blank>Microsoft 365 Admin Audit Log</a>, if someone changed it in the past. Sadly the option is not available under &ldquo;Activities - friendly names&rdquo;. You need to search by &ldquo;Activities - operation names&rdquo; for <code>AccessDelegationOnMySiteCleaneupEnabledSet</code>.</p><table><thead><tr><th>Activities - operation names</th><th>Option in the GUI</th></tr></thead><tbody><tr><td>AccessDelegationOnMySiteCleaneupEnabledSet</td><td>Enable access delegation</td></tr><tr><td>SecondaryMySiteOwnerSet</td><td>Secondary Owner</td></tr></tbody></table><p>I put this here, because (once again) I didn&rsquo;t find proper Documentation from Microsoft regarding this topic.</p><p><a href=/images/2023/2023-09-25-M365-audit-log-MySiteSettings-Cleanup.jpg><img loading=lazy src=/images/2023/2023-09-25-M365-audit-log-MySiteSettings-Cleanup.jpg alt="Search the M365 Audit Log for SharePoint Online - My Site settings - Cleanup - Change events" title="Search the M365 Audit Log for SharePoint Online - My Site settings - Cleanup - Change events"></a></p><h2 id=reporting-on-delegated-onedrives>Reporting on delegated OneDrives<a hidden class=anchor aria-hidden=true href=#reporting-on-delegated-onedrives>#</a></h2><p>A client of mine stumbled about that setting and realized it was enabled, eventhough they have huge privacy concerns regarding it. It really depends on the company and their policies. They quickly changed the setting and asked me about a way to report which OneDrive sites are currently auto-delegated to a manager. And also to remove those delegations.</p><p>To gather the data I used PowerShell with the additional module <code>Microsoft.Online.SharePoint.PowerShell</code>. To compare it with the users in the tenant, I used the old <code>AzureAD</code> module. I also could&rsquo;ve used the newer <code>Microsoft.Graph</code> module, but in this case it was easier to use the old stuff.</p><p>I had the &ldquo;SharePoint Administrator&rdquo; admin role in the tenant, but I couldn&rsquo;t read the permissions of the OneDrives sites with that. Apparently to even read the permissions of a SPO site, I had to add my admin account as a <strong>Site Collection Admin</strong> to every site. Kinda ironic that I had to do that, to find out about potential other admin assignments. I removed my permissions afterwards. So to collect all the data I used the following script.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#6c7986># Get-OneDriveOwner.ps1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># This script gathers info about additional (potentially unwanted) Site Collection Admin permissions for OneDrive for Business sites</span>
</span></span><span style=display:flex><span><span style=color:#6c7986># The script is not really polished, use on your own risk</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Import-Module</span> Microsoft.Online.SharePoint.PowerShell
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># change the SPO tenant name accordingly. For example &#34;demotenant&#34;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$SPOTenantName</span> = <span style=color:#fc6a5d>&#34;&lt;ENTER YOUR SHAREPOINT TENANT NAME HERE&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># set this to your admin user. For example &#34;admin@demotenant.de&#34;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$SPOAdminUsername</span> = <span style=color:#fc6a5d>&#34;&lt;ENTER YOUR SPO ADMIN UPN HERE&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># output file path (CSV file)</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$outputFile</span> = <span style=color:#fc6a5d>&#34;C:\temp\OneDriveAdditionalManagers-</span>$(<span style=color:#41a1c0>$SPOTenantName</span>)<span style=color:#fc6a5d>-</span>$(<span style=color:#d0a8ff>Get-Date</span> -Format <span style=color:#fc6a5d>&#34;yyyy-MM-dd_HHmmss&#34;</span>)<span style=color:#fc6a5d>.csv&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># insert spo tenant name</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Connect-SPOService</span> -Url <span style=color:#fc6a5d>&#34;https://</span>$(<span style=color:#41a1c0>$SPOTenantName</span>)<span style=color:#fc6a5d>-admin.sharepoint.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># List all OneDrive Sites</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$AllOneDriveSites</span> = <span style=color:#d0a8ff>Get-SPOSite</span> -IncludePersonalSite $true -Limit all -Filter <span style=color:#fc6a5d>&#34;Url -like &#39;-my.sharepoint.com/personal/&#39;&#34;</span> | <span style=color:#d0a8ff>Where-Object</span> {<span style=color:#41a1c0>$_</span>.Title -ne <span style=color:#fc6a5d>&#34;RedirectSite&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>foreach</span>(<span style=color:#41a1c0>$site</span> <span style=color:#fc5fa3>in</span> <span style=color:#41a1c0>$AllOneDriveSites</span>) {
</span></span><span style=display:flex><span>    <span style=color:#6c7986># temporarily add admin user as SPO site admin; suppress output</span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>        $null = <span style=color:#d0a8ff>Set-SPOUser</span> -Site <span style=color:#41a1c0>$site</span>.Url -LoginName <span style=color:#41a1c0>$SPOAdminUsername</span> -IsSiteCollectionAdmin $True
</span></span><span style=display:flex><span>    } <span style=color:#fc5fa3>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> = <span style=color:#fc6a5d>&#34;Error while trying to add admin user </span>$(<span style=color:#41a1c0>$SPOAdminUsername</span>)<span style=color:#fc6a5d> to site </span>$(<span style=color:#41a1c0>$site</span>.Url)<span style=color:#fc6a5d>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Write-Host</span> <span style=color:#41a1c0>$txt</span>
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> | <span style=color:#d0a8ff>Out-file</span> -FilePath <span style=color:#fc6a5d>&#34;</span>$(<span style=color:#41a1c0>$outputFile</span>)<span style=color:#fc6a5d>-LOG.txt&#34;</span> -Append -Encoding utf8
</span></span><span style=display:flex><span>        <span style=color:#6c7986># skip to next loop iteration</span>
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>continue</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986># get all user assignments for the current site</span>
</span></span><span style=display:flex><span>    <span style=color:#41a1c0>$SiteUsers</span> = <span style=color:#d0a8ff>Get-SPOUser</span> -Site <span style=color:#41a1c0>$site</span>.Url -Limit All
</span></span><span style=display:flex><span>    <span style=color:#41a1c0>$additionalSiteUsers</span> = <span style=color:#41a1c0>$SiteUsers</span> | <span style=color:#d0a8ff>Where-Object</span> {
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$_</span>.IsSiteAdmin -eq $true -and
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$_</span>.LoginName -ne <span style=color:#41a1c0>$SPOAdminUsername</span> -and
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$_</span>.DisplayName -ne <span style=color:#41a1c0>$site</span>.Title -and
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$_</span>.IsGroup -eq $false
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986># Check if there are unexpected users added to the site</span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>if</span>((<span style=color:#41a1c0>$additionalSiteUsers</span> | <span style=color:#d0a8ff>Measure-Object</span>).Count -ne <span style=color:#d0bf69>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Write-Host</span> <span style=color:#fc6a5d>&#34;Site &#39;</span>$(<span style=color:#41a1c0>$site</span>.Title)<span style=color:#fc6a5d>&#39; has </span>$(<span style=color:#41a1c0>$additionalSiteUsers</span>.Count)<span style=color:#fc6a5d> additional users.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>foreach</span>(<span style=color:#41a1c0>$additionalSiteUser</span> <span style=color:#fc5fa3>in</span> <span style=color:#41a1c0>$additionalSiteUsers</span>) {
</span></span><span style=display:flex><span>            <span style=color:#d0a8ff>Write-Host</span> <span style=color:#fc6a5d>&#34;</span>$(<span style=color:#41a1c0>$additionalSiteUser</span>.DisplayName)<span style=color:#fc6a5d> (</span>$(<span style=color:#41a1c0>$additionalSiteUser</span>.LoginName)<span style=color:#fc6a5d>)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6c7986># custom object for output to csv</span>
</span></span><span style=display:flex><span>            [PSCustomObject]@{
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>&#34;SiteURL&#34;</span> = <span style=color:#41a1c0>$site</span>.Url
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>&#34;SiteTitle&#34;</span> = <span style=color:#41a1c0>$site</span>.Title
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>&#34;AdditionalUserDisplayName&#34;</span> = <span style=color:#41a1c0>$additionalSiteUser</span>.DisplayName
</span></span><span style=display:flex><span>                <span style=color:#fc6a5d>&#34;AdditionalUserLoginName&#34;</span> = <span style=color:#41a1c0>$additionalSiteUser</span>.LoginName
</span></span><span style=display:flex><span>            } | <span style=color:#d0a8ff>Export-Csv</span> -Encoding utf8 -Delimiter <span style=color:#fc6a5d>&#34;;&#34;</span> -Append -NoTypeInformation -Path <span style=color:#41a1c0>$outputFile</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986># remove admin user from SPO/Onedrive site (we only added it temporarily)</span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>        $null = <span style=color:#d0a8ff>Set-SPOUser</span> -Site <span style=color:#41a1c0>$site</span>.Url -LoginName <span style=color:#41a1c0>$SPOAdminUsername</span> -IsSiteCollectionAdmin $false
</span></span><span style=display:flex><span>    } <span style=color:#fc5fa3>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> = <span style=color:#fc6a5d>&#34;Error while trying to remove admin user </span>$(<span style=color:#41a1c0>$SPOAdminUsername</span>)<span style=color:#fc6a5d> from site </span>$(<span style=color:#41a1c0>$site</span>.Url)<span style=color:#fc6a5d>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Write-Host</span> <span style=color:#41a1c0>$txt</span>
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> | <span style=color:#d0a8ff>Out-file</span> -FilePath <span style=color:#fc6a5d>&#34;</span>$(<span style=color:#41a1c0>$outputFile</span>)<span style=color:#fc6a5d>-LOG.txt&#34;</span> -Append -Encoding utf8
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>I then had a CSV-file that I could check out in Excel. I realized that the file contains <strong>ALL</strong> additional assignments, even some legit ones. So I used the <code>AzureAD</code> PowerShell module to compare if the user account belonging to the OneDrive still existed.
Normally a OneDrive4b site has the Name of the user as the site title. So I could use <code>Get-AzureADUser</code> to search for the SPO site title. <code>Get-AzureADUser</code> doesn&rsquo;t return deleted users. If a user existed, the assignment was treated as legit, because it shouldn&rsquo;t be an automatic delegation that happens when the user gets deleted.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#6c7986># Compare-OneDriveSitesWithUsers.ps1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Connect-AzureAD</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># I also filtered out a specific service accounts that had access to many OneDrives.</span>
</span></span><span style=display:flex><span><span style=color:#6c7986># if you don&#39;t have something similar, then you probably don&#39;t need the Where-Object part here</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$sites</span> = <span style=color:#d0a8ff>Import-csv</span> <span style=color:#fc6a5d>&#34;C:\temp\OneDriveAdditionalManagers-mytenant.csv&#34;</span> -Encoding utf8 -Delimiter <span style=color:#fc6a5d>&#34;;&#34;</span> | <span style=color:#d0a8ff>Where-Object</span> {<span style=color:#41a1c0>$_</span>.AdditionalUserLoginName -ne <span style=color:#fc6a5d>&#34;some-service-account@example.com&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Try to get AAD Users for each SPO site</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>foreach</span>(<span style=color:#41a1c0>$site</span> <span style=color:#fc5fa3>in</span> <span style=color:#41a1c0>$sites</span>) {
</span></span><span style=display:flex><span>    <span style=color:#d0a8ff>Write-Host</span> <span style=color:#fc6a5d>&#34;Searching for user </span>$(<span style=color:#41a1c0>$site</span>.SiteTitle)<span style=color:#fc6a5d>...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986># filtering out guests for some edge cases</span>
</span></span><span style=display:flex><span>    <span style=color:#41a1c0>$user</span> = <span style=color:#d0a8ff>Get-AzureADUser</span> -SearchString <span style=color:#41a1c0>$site</span>.SiteTitle | <span style=color:#d0a8ff>Where-Object</span> {<span style=color:#41a1c0>$_</span>.UserType -ne <span style=color:#fc6a5d>&#34;Guest&#34;</span>}
</span></span><span style=display:flex><span>    <span style=color:#41a1c0>$resultCount</span> = (<span style=color:#41a1c0>$user</span> | <span style=color:#d0a8ff>Measure-Object</span>).Count
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>if</span>(<span style=color:#41a1c0>$resultCount</span> -gt <span style=color:#d0bf69>1</span>) { 
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Write-Host</span> <span style=color:#fc6a5d>&#34;</span><span style=color:#41a1c0>$resultCount</span><span style=color:#fc6a5d> results for user </span>$(<span style=color:#41a1c0>$site</span>.SiteTitle)<span style=color:#fc6a5d>!&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$user</span>
</span></span><span style=display:flex><span>    } <span style=color:#fc5fa3>elseif</span>(<span style=color:#41a1c0>$resultCount</span> -eq <span style=color:#d0bf69>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Write-Host</span> <span style=color:#fc6a5d>&#34;User exists! </span>$(<span style=color:#41a1c0>$user</span>.UserPrincipalName)<span style=color:#fc6a5d>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$site</span> | <span style=color:#d0a8ff>Add-Member</span> -NotePropertyName <span style=color:#fc6a5d>&#34;UserStillExists&#34;</span> -NotePropertyValue $true -Force
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># check</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$sites</span> | <span style=color:#d0a8ff>ft </span>SiteTitle,UserStillExists
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$sites</span> | <span style=color:#d0a8ff>Where-Object</span> {<span style=color:#41a1c0>$_</span>.UserStillExists -ne $true} | <span style=color:#d0a8ff>Measure-Object</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$sites</span> | <span style=color:#d0a8ff>Where-Object</span> {<span style=color:#41a1c0>$_</span>.UserStillExists -ne $true} | <span style=color:#d0a8ff>Export-Csv</span> -Path C:\temp\<span style=color:#d0a8ff>OneDriveAdditionalManagers-NonExistingUsers</span>.csv -Delimiter <span style=color:#fc6a5d>&#34;;&#34;</span> -Encoding utf8
</span></span></code></pre></td></tr></table></div></div><h2 id=removing-additional-admins-from-onedrive-sites>Removing additional admins from OneDrive sites<a hidden class=anchor aria-hidden=true href=#removing-additional-admins-from-onedrive-sites>#</a></h2><p>After checking that result, I used another script to actually remove the additional SPO site rights. Again I had to add my admin account as a SPO site collection admin. Then I first removed the site admin permissions of the manager user by calling <code>Set-SPOUser -Site $site.SiteURL -LoginName $SPOAdminUsername -IsSiteCollectionAdmin $True</code>. Afterwards I removed the user completely from the site with <code>Remove-SPOUser -Site $site.SiteURL -LoginName $site.AdditionalUserLoginName</code>. After being done with the site, I removed my admin permissions again.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#6c7986># Remove-AdditionalOneDriveOwners.ps1</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Import-Module</span> Microsoft.Online.SharePoint.PowerShell
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># change the SPO tenant name accordingly. For example &#34;demotenant&#34;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$SPOTenantName</span> = <span style=color:#fc6a5d>&#34;&lt;ENTER YOUR SHAREPOINT TENANT NAME HERE&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># set this to your admin user. For example &#34;admin@demotenant.de&#34;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$SPOAdminUsername</span> = <span style=color:#fc6a5d>&#34;&lt;ENTER YOUR SPO ADMIN UPN HERE&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># output log file path</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$outputFile</span> = <span style=color:#fc6a5d>&#34;C:\temp\OneDriveAdditionalManagers-Cleanup-</span>$(<span style=color:#41a1c0>$SPOTenantName</span>)<span style=color:#fc6a5d>-</span>$(<span style=color:#d0a8ff>Get-Date</span> -Format <span style=color:#fc6a5d>&#34;yyyy-MM-dd_HHmmss&#34;</span>)<span style=color:#fc6a5d>.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># insert spo tenant name</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Connect-SPOService</span> -Url <span style=color:#fc6a5d>&#34;https://</span>$(<span style=color:#41a1c0>$SPOTenantName</span>)<span style=color:#fc6a5d>-admin.sharepoint.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># import sites to clean from CSV file</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$SitesToClean</span> = <span style=color:#d0a8ff>Import-Csv</span> -Path <span style=color:#fc6a5d>&#34;C:\temp\OneDriveSitesToCleanPermissions.csv&#34;</span> -Delimiter <span style=color:#fc6a5d>&#34;;&#34;</span> -Encoding utf8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>foreach</span>(<span style=color:#41a1c0>$site</span> <span style=color:#fc5fa3>in</span> <span style=color:#41a1c0>$SitesToClean</span>) {
</span></span><span style=display:flex><span>    <span style=color:#6c7986># temporarily add admin user as SPO site admin; suppress output</span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>        $null = <span style=color:#d0a8ff>Set-SPOUser</span> -Site <span style=color:#41a1c0>$site</span>.SiteURL -LoginName <span style=color:#41a1c0>$SPOAdminUsername</span> -IsSiteCollectionAdmin $True
</span></span><span style=display:flex><span>    } <span style=color:#fc5fa3>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> = <span style=color:#fc6a5d>&#34;Error while trying to add admin user </span>$(<span style=color:#41a1c0>$SPOAdminUsername</span>)<span style=color:#fc6a5d> to site </span>$(<span style=color:#41a1c0>$site</span>.SiteURL)<span style=color:#fc6a5d>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Write-Host</span> <span style=color:#41a1c0>$txt</span>
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> | <span style=color:#d0a8ff>Out-file</span> -FilePath <span style=color:#41a1c0>$outputFile</span> -Append -Encoding utf8
</span></span><span style=display:flex><span>        <span style=color:#6c7986># skip to next loop iteration</span>
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>continue</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986># remove additional user from SPO site according to CSV file</span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#6c7986># first remove admin rights</span>
</span></span><span style=display:flex><span>        $null = <span style=color:#d0a8ff>Set-SPOUser</span> -Site <span style=color:#41a1c0>$site</span>.SiteUrl -LoginName <span style=color:#41a1c0>$site</span>.AdditionalUserLoginName -IsSiteCollectionAdmin $false
</span></span><span style=display:flex><span>        <span style=color:#6c7986># then remove the user from the site</span>
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Remove-SPOUser</span> -Site <span style=color:#41a1c0>$site</span>.SiteURL -LoginName <span style=color:#41a1c0>$site</span>.AdditionalUserLoginName
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> = <span style=color:#fc6a5d>&#34;Removed user </span>$(<span style=color:#41a1c0>$site</span>.AdditionalUserLoginName)<span style=color:#fc6a5d> from site </span>$(<span style=color:#41a1c0>$site</span>.SiteURL)<span style=color:#fc6a5d>.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Write-Host</span> <span style=color:#41a1c0>$txt</span> -ForegroundColor Green
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> | <span style=color:#d0a8ff>Out-file</span> -FilePath <span style=color:#41a1c0>$outputFile</span> -Append -Encoding utf8
</span></span><span style=display:flex><span>    } <span style=color:#fc5fa3>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> = <span style=color:#fc6a5d>&#34;Error while trying to remove user </span>$(<span style=color:#41a1c0>$site</span>.AdditionalUserLoginName)<span style=color:#fc6a5d> from site </span>$(<span style=color:#41a1c0>$site</span>.SiteURL)<span style=color:#fc6a5d>. Error details: </span><span style=color:#41a1c0>$_</span><span style=color:#fc6a5d>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Write-Host</span> <span style=color:#41a1c0>$txt</span> -ForegroundColor Red
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> | <span style=color:#d0a8ff>Out-file</span> -FilePath <span style=color:#41a1c0>$outputFile</span> -Append -Encoding utf8
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986># remove admin user from SPO/Onedrive site (we only added it temporarily)</span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>        $null = <span style=color:#d0a8ff>Set-SPOUser</span> -Site <span style=color:#41a1c0>$site</span>.SiteURL -LoginName <span style=color:#41a1c0>$SPOAdminUsername</span> -IsSiteCollectionAdmin $false
</span></span><span style=display:flex><span>    } <span style=color:#fc5fa3>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> = <span style=color:#fc6a5d>&#34;Error while trying to remove admin user </span>$(<span style=color:#41a1c0>$SPOAdminUsername</span>)<span style=color:#fc6a5d> from site </span>$(<span style=color:#41a1c0>$site</span>.SiteURL)<span style=color:#fc6a5d>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>Write-Host</span> <span style=color:#41a1c0>$txt</span>
</span></span><span style=display:flex><span>        <span style=color:#41a1c0>$txt</span> | <span style=color:#d0a8ff>Out-file</span> -FilePath <span style=color:#41a1c0>$outputFile</span> -Append -Encoding utf8
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://diecknet.de/en/tags/onedrive/>Onedrive</a></li><li><a href=https://diecknet.de/en/tags/onedrive-for-business/>Onedrive for Business</a></li><li><a href=https://diecknet.de/en/tags/sharepoint-online/>Sharepoint Online</a></li><li><a href=https://diecknet.de/en/tags/my-site/>My Site</a></li></ul><div class=share-buttons></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://diecknet.de/en/>diecknet</a></span>
&nbsp;|&nbsp;
<span><a href=https://diecknet.de/en/legal/>Imprint</a>
</span>&nbsp;|&nbsp;<span>
<a href=https://diecknet.de/en/privacy/>Privacy</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript>var _paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="//nc.diecknet.de/mt/",_paq.push(["setTrackerUrl",t+"mdata"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.defer=!0,e.src=t+"m.js",s.parentNode.insertBefore(e,s)}()</script><noscript><p><img src="https://nc.diecknet.de/mt/mdata?idsite=1&amp;rec=1" style=border:0 alt></p></noscript></body></html>