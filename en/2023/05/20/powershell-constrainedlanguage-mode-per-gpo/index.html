<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Set PowerShell ConstrainedLanguage Mode per Group Policy | diecknet</title>
<meta name=keywords content="powershell,language mode,constrained language"><meta name=description content="PowerShell Language Modes are a way to restrict the functionality of PowerShell to increase the security of a system. Of course, this is only one small piece in a larger security strategy, so this alone is not sufficient protection for a system.
At the same time, it&rsquo;s also a double-edged sword:
Advantage: we remove a powerful tool from potential attackers.
Disadvantage: We as administrators can no longer use PowerShell properly on a system either."><meta name=author content="Andreas Dieckmann"><link rel=canonical href=https://diecknet.de/en/2023/05/20/powershell-constrainedlanguage-mode-per-gpo/><link crossorigin=anonymous href=/assets/css/stylesheet.75a517428f403193483801122d6350f6956c3bb6bf5c6504311f8c24e6bab3e7.css integrity="sha256-daUXQo9AMZNIOAESLWNQ9pVsO7a/XGUEMR+MJOa6s+c=" rel="preload stylesheet" as=style><link rel=icon href=https://diecknet.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://diecknet.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://diecknet.de/favicon-32x32.png><link rel=apple-touch-icon href=https://diecknet.de/apple-touch-icon.png><link rel=mask-icon href=https://diecknet.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=de href=https://diecknet.de/de/2023/05/20/powershell-constrainedlanguage-mode-per-gpo/><link rel=alternate hreflang=en href=https://diecknet.de/en/2023/05/20/powershell-constrainedlanguage-mode-per-gpo/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Set PowerShell ConstrainedLanguage Mode per Group Policy"><meta property="og:description" content="PowerShell Language Modes are a way to restrict the functionality of PowerShell to increase the security of a system. Of course, this is only one small piece in a larger security strategy, so this alone is not sufficient protection for a system.
At the same time, it&rsquo;s also a double-edged sword:
Advantage: we remove a powerful tool from potential attackers.
Disadvantage: We as administrators can no longer use PowerShell properly on a system either."><meta property="og:type" content="article"><meta property="og:url" content="https://diecknet.de/en/2023/05/20/powershell-constrainedlanguage-mode-per-gpo/"><meta property="og:image" content="https://diecknet.de/images/2023/2023-05-21-ConstrainedLanguageModePerGPO.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-20T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-20T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://diecknet.de/images/2023/2023-05-21-ConstrainedLanguageModePerGPO.jpg"><meta name=twitter:title content="Set PowerShell ConstrainedLanguage Mode per Group Policy"><meta name=twitter:description content="PowerShell Language Modes are a way to restrict the functionality of PowerShell to increase the security of a system. Of course, this is only one small piece in a larger security strategy, so this alone is not sufficient protection for a system.
At the same time, it&rsquo;s also a double-edged sword:
Advantage: we remove a powerful tool from potential attackers.
Disadvantage: We as administrators can no longer use PowerShell properly on a system either."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://diecknet.de/en/posts/"},{"@type":"ListItem","position":2,"name":"Set PowerShell ConstrainedLanguage Mode per Group Policy","item":"https://diecknet.de/en/2023/05/20/powershell-constrainedlanguage-mode-per-gpo/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Set PowerShell ConstrainedLanguage Mode per Group Policy","name":"Set PowerShell ConstrainedLanguage Mode per Group Policy","description":"PowerShell Language Modes are a way to restrict the functionality of PowerShell to increase the security of a system. Of course, this is only one small piece in a larger security strategy, so this alone is not sufficient protection for a system.\nAt the same time, it\u0026rsquo;s also a double-edged sword:\nAdvantage: we remove a powerful tool from potential attackers.\nDisadvantage: We as administrators can no longer use PowerShell properly on a system either.\n","keywords":["powershell","language mode","constrained language"],"articleBody":"PowerShell Language Modes are a way to restrict the functionality of PowerShell to increase the security of a system. Of course, this is only one small piece in a larger security strategy, so this alone is not sufficient protection for a system.\nAt the same time, it‚Äôs also a double-edged sword:\nAdvantage: we remove a powerful tool from potential attackers.\nDisadvantage: We as administrators can no longer use PowerShell properly on a system either.\nI‚Äôve also created a German video about the basics of PowerShell Language Modes. However, this blog post here is only about how to configure the ConstrainedLanguage Mode via Group Policy. Unfortunately, the other modes cannot be enabled system-wide in a meaningful way.\nNote regarding __PSLockdownPolicy Setting the environment variable __PSLockdownPolicy to the value 4 is by the way NOT a secure or supported way to enable the ConstrainedLanguage Mode.\nConfigure ConstrainedLanguage Mode Note: I evaluated the process using Windows 11 Enterprise Version 22H2 (Build 22621.1702).\nThe ConstrainedLanguage Mode can be configured via Windows Defender Application Control (WDAC) or with the legacy AppLocker. It is best to use a VM for testing, which can be quickly reset to a functional state. It is possible to very quickly break the system with application control policies so that it is no longer bootable.\nTo configure the ConstrainedLanguage Mode via WDAC, we use the sub-feature ‚ÄúCode Integrity‚Äù with ‚ÄúScript Enforcement‚Äù. Script Enforcement affects not only PowerShell, but also some other Script Hosts that Microsoft calls ‚ÄúEnlightened‚Äù. The Windows Based Script Host (wscript.exe) and Microsoft Console Based Script Host (cscript.exe) block the complete execution of scripts in the formats VBScript, cscript and jscript - no matter where they are located. The Microsoft HTML Application Host (mshta.exe) which is responsible for the execution of .hta files acts simarily - the execution of .hta files is blocked across the board. By the way, other scripts like .bat or .cmd in cmd.exe are not blocked by WDAC at all. And also non-Microsoft scripts like e.g. Python are not blocked.\nStep 1: Base Policy For CodeIntegrity, there are some sample policies that we can use as a base. These can be found under the following path: C:\\Windows\\schemas\\CodeIntegrity\\ExamplePolicies.\nTo still allow normal Microsoft applications and system components to run, we copy the AllowMicrosoft.xml to a directory, e.g. C:\\CIPolicy. Then modify it via PowerShell so that the policy gets a new GUID, a new name and a version number:\n1 2 Set-CIPolicyIdInfo -FilePath MyCIPolicy.xml -PolicyName \"diecknet Code Integrity\" -ResetPolicyID Set-CIPolicyVersion -FilePath MyCIPolicy.xml -Version \"1.0.0.0\" Step 2: Exclude a specific path from the rule If a specific folder path should be excluded from the policy, e.g. for administrative scripts, we can create an additional policy rule. This policy rule will be placed in a new policy.\n1 2 $rule = New-CIPolicyRule -FilePathRule \"C:\\AdminSkripte\\*\" New-CIPolicy ‚ÄìFilePath AdminSkripte.xml ‚ÄìRules $rule -UserPEs The -UserPEs ensures that files in user mode are also covered by the policy.\nThen merge to a new policy file:\n1 Merge-CIPolicy -OutputFilePath \"diecknet-Policy.xml\" -PolicyPaths \".\\AllowMicrosoft.xml\",\".\\AdminSkripte.xml\" It is important that only admins are allowed to write to this directory. Otherwise all users could simply create new scripts in the folder and execute them in FullLanguage mode. So check the permissions and change them if necessary. It only recognizes certain default admin SIDs, so if you are using a custom security group and not the local administrators group, you have to enable Option 18. This would go like this, for example:\n1 2 # Only required for custom Permissions Set-RuleOption -FilePath \"diecknet-Policy.xml\" -Option 18 Step 3: Disable Audit Mode By default, the audit mode is active. Since I work with a test system anyway, I leave out the audit mode. For this you can either delete the rule with Enabled:Audit Mode manually from the .xml file, or with Set-RuleOption:\n1 Set-RuleOption -FilePath \"diecknet-Policy.xml\" -Option 3 -Delete Step 4: Convert the Policy to Binary Then we convert the .xml-Policy to a Binary file:\n1 ConvertFrom-CIPolicy -XmlFilePath diecknet-Policy.xml -BinaryFilePath diecknet-Policy.cip Step 5: Testing - Apply the policy locally For testing, the policy can be applied locally. It is best to create a VM snapshot beforehand.\n1 CiTool.exe --update-policy diecknet-Policy.cip When you start a new PowerShell session now, it should run directly in ConstrainedLanguage Mode. To check this, look at the value of the variable $ExecutionContext.SessionState.LanguageMode. Scripts located in C:\\AdminSkripte (or signed by Microsoft) should run in FullLanguage Mode. Scripts in other locations should run in ConstrainedLanguage Mode.\nI used this code for testing in test.ps1:\n1 2 Write-Host \"Hello from $PSScriptRoot\" Write-Host \"The current LanguageMode:\"$ExecutionContext.SessionState.LanguageMode Step 6: Deploy the Policy using GPO If everything works, it can also be rolled out in production. This can be done via Group Policy, Microsoft System Center Configuration Manager or MDM tools like Intune. I will explain how to do it via Group Policy, because the feature wasn‚Äôt greatly documented by Microsoft.\nActually there is a setting under Computer Configuration -\u003e Policies -\u003e Administrative Templates -\u003e System -\u003e Device Guard. However, it doesn‚Äôt work with Multi-Policy Format policies like we just created. Microsoft writes about this:\nGroup Policy-based deployment of Windows Defender Application Control policies only supports single-policy format WDAC policies. To use WDAC on devices running Windows 10 1903 and greater, or Windows 11, we recommend using an alternative method for policy deployment.\nBut instead, we can simply deploy the file directly via Group Policy. This can be done under Computer configuration -\u003e Settings -\u003e Windows settings -\u003e Files. Create a new entry here and specify the .cip source file. To make it available in the network, I simply copied it into the NETLOGON directory of my domain. But of course any fileshare will work.\nThen specify the following path as destination file: C:\\Windows\\System32\\CodeIntegrity\\CiPolicies\\Active\\{Policy-Guid}.cip. Where Policy-Guid must be replaced by the GUID of the policy. But the curly brackets should remain. The PolicyID is in the .xml policy file in the tag . For me it is {82C1BF56-B3BC-40FE-AD21-5FC37EBB5CF9}, so the full target path for me is: C:\\WindowsSystem32\\CodeIntegrity\\CiPolicies\\Active\\{82C1BF56-B3BC-40FE-AD21-5FC37EBB5CF9}.cip\nWith this approach the policy is applied only when the computer is restarted. So I ran gpupdate /force (possibly unnecessary, but I wanted to save myself a possible second reboot) and rebooted the computer. Then the policy was applied as before in step 5.\nConclusion In my opinion, setting up Windows Defender Application Control / CodeIntegrity / PowerShell Language Modes is unnecessarily complicated. I also find it a bit of a headache that the more modern multi-policies are not actually supported via Group Policy.\nRelated Links Here are a few more links and sources that helped me with my research. In particular, I would like to highlight the blog series on airdesk.com about WDAC:\nairdesk.com: WDAC and Intune Blog series airdesk.com: WDAC and File Path Rules And some very good infos from HotCakeX:\nWDAC Wiki on Github by HotCakeX This really verbose and insightful answer on superuser.com A few useful informations are available at Microsoft:\nCreate a WDAC policy for fully managed devices Enlightened script hosts that are part of Windows Windows Defender Application Control policy - policy rule options New-CIPolicy Cmdlet Deployment per GPO Remove a WDAC Policy Multi-Policy local Deployment WDAC EventLogs PowerShell Team: PowerShell Constrained Language Mode ","wordCount":"1193","inLanguage":"en","image":"https://diecknet.de/images/2023/2023-05-21-ConstrainedLanguageModePerGPO.jpg","datePublished":"2023-05-20T00:00:00Z","dateModified":"2023-05-20T00:00:00Z","author":{"@type":"Person","name":"Andreas Dieckmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diecknet.de/en/2023/05/20/powershell-constrainedlanguage-mode-per-gpo/"},"publisher":{"@type":"Organization","name":"diecknet","logo":{"@type":"ImageObject","url":"https://diecknet.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diecknet.de/en/ accesskey=h title="diecknet (Alt + H)">diecknet</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://diecknet.de/de/2023/05/20/powershell-constrainedlanguage-mode-per-gpo/ title=Deutsch aria-label=Deutsch>Deutsch</a></li><li><a href=https://diecknet.de/en/2023/05/20/powershell-constrainedlanguage-mode-per-gpo/ title=English aria-label=English><b>English</b></a></li></ul></div></div><ul id=menu><li><a href=https://diecknet.de/en/ title=Home><span>Home</span></a></li><li><a href=https://diecknet.de/en/services/ title=Services><span>Services</span></a></li><li><a href=https://diecknet.de/en/about/ title=About><span>About</span></a></li><li><a href=https://diecknet.de/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://diecknet.de/en/archive/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://diecknet.de/en/>Home</a>&nbsp;¬ª&nbsp;<a href=https://diecknet.de/en/posts/>Posts</a></div><h1 class=post-title>Set PowerShell ConstrainedLanguage Mode per Group Policy</h1><div class=post-meta><span title='2023-05-20 00:00:00 +0000 UTC'>2023-05-20</span>&nbsp;¬∑&nbsp;6 min&nbsp;¬∑&nbsp;Andreas Dieckmann&nbsp;|&nbsp;<ul class=i18n_list>üåç&nbsp;Dieser Inhalt ist auch verf√ºgbar auf:&nbsp;<li><a href=https://diecknet.de/de/2023/05/20/powershell-constrainedlanguage-mode-per-gpo/>Deutsch</a></li></ul>&nbsp;|&nbsp;<a href=https://github.com/diecknet/diecknet-blog/tree/main/content/en/posts/2023/2023-05-21-PowerShell-ConstrainedLanguage-Mode-per-GPO.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><figure class=entry-cover><img loading=lazy src=https://diecknet.de/images/2023/2023-05-21-ConstrainedLanguageModePerGPO.jpg alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#note-regarding-__pslockdownpolicy aria-label="Note regarding __PSLockdownPolicy">Note regarding <code>__PSLockdownPolicy</code></a></li><li><a href=#configure-constrainedlanguage-mode aria-label="Configure ConstrainedLanguage Mode">Configure ConstrainedLanguage Mode</a><ul><li><a href=#step-1-base-policy aria-label="Step 1: Base Policy">Step 1: Base Policy</a></li><li><a href=#step-2-exclude-a-specific-path-from-the-rule aria-label="Step 2: Exclude a specific path from the rule">Step 2: Exclude a specific path from the rule</a></li><li><a href=#step-3-disable-audit-mode aria-label="Step 3: Disable Audit Mode">Step 3: Disable Audit Mode</a></li><li><a href=#step-4-convert-the-policy-to-binary aria-label="Step 4: Convert the Policy to Binary">Step 4: Convert the Policy to Binary</a></li><li><a href=#step-5-testing---apply-the-policy-locally aria-label="Step 5: Testing - Apply the policy locally">Step 5: Testing - Apply the policy locally</a></li><li><a href=#step-6-deploy-the-policy-using-gpo aria-label="Step 6: Deploy the Policy using GPO">Step 6: Deploy the Policy using GPO</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li><li><a href=#related-links aria-label="Related Links">Related Links</a></li></ul></div></details></div><div class=post-content><p>PowerShell Language Modes are a way to restrict the functionality of PowerShell to increase the security of a system. Of course, this is only one small piece in a larger security strategy, so this alone is not sufficient protection for a system.</p><p>At the same time, it&rsquo;s also a double-edged sword:<br>Advantage: we remove a powerful tool from potential attackers.<br>Disadvantage: We as administrators can no longer use PowerShell properly on a system either.</p><p>I&rsquo;ve also created a <a href="https://www.youtube.com/watch?v=WmgwybaNwjg" target=_blank>German video about the basics of PowerShell Language Modes</a>. However, this blog post here is only about how to configure the <strong>ConstrainedLanguage</strong> Mode via Group Policy. Unfortunately, the other modes cannot be enabled system-wide in a meaningful way.</p><h2 id=note-regarding-__pslockdownpolicy>Note regarding <code>__PSLockdownPolicy</code><a hidden class=anchor aria-hidden=true href=#note-regarding-__pslockdownpolicy>#</a></h2><p>Setting the environment variable <code>__PSLockdownPolicy</code> to the value <code>4</code> <a href=https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/ target=_blank>is by the way <strong>NOT</strong> a secure or supported way to enable the ConstrainedLanguage Mode</a>.</p><h2 id=configure-constrainedlanguage-mode>Configure ConstrainedLanguage Mode<a hidden class=anchor aria-hidden=true href=#configure-constrainedlanguage-mode>#</a></h2><p><strong>Note: I evaluated the process using Windows 11 Enterprise Version 22H2 (Build 22621.1702).</strong></p><p>The ConstrainedLanguage Mode can be configured via Windows Defender Application Control (WDAC) or with the legacy AppLocker.
It is best to use a VM for testing, which can be quickly reset to a functional state. It is possible to very quickly break the system with application control policies so that it is no longer bootable.</p><p>To configure the ConstrainedLanguage Mode via WDAC, we use the sub-feature &ldquo;Code Integrity&rdquo; with &ldquo;Script Enforcement&rdquo;. Script Enforcement affects not only PowerShell, but also some other Script Hosts that Microsoft calls &ldquo;Enlightened&rdquo;. The Windows Based Script Host (<code>wscript.exe</code>) and Microsoft Console Based Script Host (<code>cscript.exe</code>) block the complete execution of scripts in the formats <strong>VBScript</strong>, <strong>cscript</strong> and <strong>jscript</strong> - no matter where they are located.
The Microsoft HTML Application Host (<code>mshta.exe</code>) which is responsible for the execution of <strong>.hta</strong> files acts simarily - the execution of <strong>.hta</strong> files is blocked across the board. By the way, other scripts like <strong>.bat</strong> or <strong>.cmd</strong> in <code>cmd.exe</code> are not blocked by WDAC at all. And also non-Microsoft scripts like e.g. <strong>Python</strong> are <strong>not blocked</strong>.</p><h3 id=step-1-base-policy>Step 1: Base Policy<a hidden class=anchor aria-hidden=true href=#step-1-base-policy>#</a></h3><p>For CodeIntegrity, there are some sample policies that we can use as a base. These can be found under the following path:
<code>C:\Windows\schemas\CodeIntegrity\ExamplePolicies</code>.</p><p>To still allow normal Microsoft applications and system components to run, we copy the <code>AllowMicrosoft.xml</code> to a directory, e.g. <code>C:\CIPolicy</code>. Then modify it via PowerShell so that the policy gets a new GUID, a new name and a version number:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#d0a8ff>Set-CIPolicyIdInfo</span> -FilePath MyCIPolicy.xml -PolicyName <span style=color:#fc6a5d>&#34;diecknet Code Integrity&#34;</span> -ResetPolicyID
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Set-CIPolicyVersion</span> -FilePath MyCIPolicy.xml -Version <span style=color:#fc6a5d>&#34;1.0.0.0&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=step-2-exclude-a-specific-path-from-the-rule>Step 2: Exclude a specific path from the rule<a hidden class=anchor aria-hidden=true href=#step-2-exclude-a-specific-path-from-the-rule>#</a></h3><p>If a specific folder path should be excluded from the policy, e.g. for administrative scripts, we can create an additional policy rule. This policy rule will be placed in a new policy.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#41a1c0>$rule</span> = <span style=color:#d0a8ff>New-CIPolicyRule</span> -FilePathRule <span style=color:#fc6a5d>&#34;C:\AdminSkripte\*&#34;</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>New-CIPolicy</span> <span style=color:#960050>‚Äì</span>FilePath AdminSkripte.xml <span style=color:#960050>‚Äì</span>Rules <span style=color:#41a1c0>$rule</span> -UserPEs
</span></span></code></pre></td></tr></table></div></div><p>The <code>-UserPEs</code> ensures that files in user mode are also covered by the policy.</p><p>Then merge to a new policy file:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#d0a8ff>Merge-CIPolicy</span> -OutputFilePath <span style=color:#fc6a5d>&#34;diecknet-Policy.xml&#34;</span> -PolicyPaths <span style=color:#fc6a5d>&#34;.\AllowMicrosoft.xml&#34;</span>,<span style=color:#fc6a5d>&#34;.\AdminSkripte.xml&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>It is important that only admins are allowed to write to this directory. Otherwise all users could simply create new scripts in the folder and execute them in FullLanguage mode.
So check the permissions and change them if necessary. It only recognizes certain default admin SIDs, so if you are using a custom security group and not the local administrators group, you have to enable <a href=https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/select-types-of-rules-to-create#table-1-windows-defender-application-control-policy---policy-rule-options target=_blank>Option 18</a>. This would go like this, for example:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#6c7986># Only required for custom Permissions</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Set-RuleOption</span> -FilePath <span style=color:#fc6a5d>&#34;diecknet-Policy.xml&#34;</span> -Option <span style=color:#d0bf69>18</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=step-3-disable-audit-mode>Step 3: Disable Audit Mode<a hidden class=anchor aria-hidden=true href=#step-3-disable-audit-mode>#</a></h3><p>By default, the audit mode is active. Since I work with a test system anyway, I leave out the audit mode.
For this you can either delete the rule with <code>Enabled:Audit Mode</code> manually from the <code>.xml</code> file, or with <code>Set-RuleOption</code>:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#d0a8ff>Set-RuleOption</span> -FilePath <span style=color:#fc6a5d>&#34;diecknet-Policy.xml&#34;</span> -Option <span style=color:#d0bf69>3</span> -Delete
</span></span></code></pre></td></tr></table></div></div><h3 id=step-4-convert-the-policy-to-binary>Step 4: Convert the Policy to Binary<a hidden class=anchor aria-hidden=true href=#step-4-convert-the-policy-to-binary>#</a></h3><p>Then we convert the <code>.xml</code>-Policy to a Binary file:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#d0a8ff>ConvertFrom-CIPolicy</span> -XmlFilePath <span style=color:#d0a8ff>diecknet-Policy</span>.xml -BinaryFilePath <span style=color:#d0a8ff>diecknet-Policy</span>.cip
</span></span></code></pre></td></tr></table></div></div><h3 id=step-5-testing---apply-the-policy-locally>Step 5: Testing - Apply the policy locally<a hidden class=anchor aria-hidden=true href=#step-5-testing---apply-the-policy-locally>#</a></h3><p>For testing, the policy can be applied locally. It is best to create a VM snapshot beforehand.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>CiTool.exe --update-policy <span style=color:#d0a8ff>diecknet-Policy</span>.cip
</span></span></code></pre></td></tr></table></div></div><p>When you start a new PowerShell session now, it should run directly in ConstrainedLanguage Mode. To check this, look at the value of the variable <code>$ExecutionContext.SessionState.LanguageMode</code>. Scripts located in <code>C:\AdminSkripte</code> (or signed by Microsoft) should run in FullLanguage Mode. Scripts in other locations should run in ConstrainedLanguage Mode.</p><p><img loading=lazy src=/images/2023/2023-05-20-PSLanguageModeTest.jpg alt="PowerShell Language Mode Test"></p><p>I used this code for testing in <code>test.ps1</code>:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#d0a8ff>Write-Host</span> <span style=color:#fc6a5d>&#34;Hello from </span><span style=color:#41a1c0>$PSScriptRoot</span><span style=color:#fc6a5d>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Write-Host</span> <span style=color:#fc6a5d>&#34;The current LanguageMode:&#34;</span><span style=color:#41a1c0>$ExecutionContext</span>.SessionState.LanguageMode
</span></span></code></pre></td></tr></table></div></div><h3 id=step-6-deploy-the-policy-using-gpo>Step 6: Deploy the Policy using GPO<a hidden class=anchor aria-hidden=true href=#step-6-deploy-the-policy-using-gpo>#</a></h3><p>If everything works, it can also be rolled out in production. This can be done via Group Policy, Microsoft System Center Configuration Manager or MDM tools like Intune. I will explain how to do it via Group Policy, because the feature wasn&rsquo;t greatly documented by Microsoft.</p><p><em>Actually</em> there is a setting under <code>Computer Configuration -> Policies -> Administrative Templates -> System -> Device Guard</code>. However, it doesn&rsquo;t work with Multi-Policy Format policies like we just created. Microsoft writes about this:</p><blockquote><p>Group Policy-based deployment of Windows Defender Application Control policies only supports single-policy format WDAC policies. To use WDAC on devices running Windows 10 1903 and greater, or Windows 11, we recommend using an alternative method for policy deployment.</p></blockquote><p>But instead, we can simply deploy the file directly via Group Policy. This can be done under <code>Computer configuration -> Settings -> Windows settings -> Files</code>. Create a new entry here and specify the <code>.cip</code> source file. To make it available in the network, I simply copied it into the <code>NETLOGON</code> directory of my domain. But of course any fileshare will work.<br>Then specify the following path as destination file: <code>C:\Windows\System32\CodeIntegrity\CiPolicies\Active\{Policy-Guid}.cip</code>.
Where <code>Policy-Guid</code> must be replaced by the GUID of the policy. But the curly brackets should remain. The PolicyID is in the <code>.xml</code> policy file in the tag <code>&lt;PolicyId></code>. For me it is <code>{82C1BF56-B3BC-40FE-AD21-5FC37EBB5CF9}</code>, so the full target path for me is: <code>C:\WindowsSystem32\CodeIntegrity\CiPolicies\Active\{82C1BF56-B3BC-40FE-AD21-5FC37EBB5CF9}.cip</code></p><p><img loading=lazy src=/images/2023/2023-05-20-WDAC-PolicyID.jpg alt="Find out WDAC Policy ID"></p><p><img loading=lazy src=/images/2023/2023-05-20_GPO_File.jpg alt="Deploy WDAC Policy using GPO Files"></p><p>With this approach the policy is applied only when the computer is restarted. So I ran <code>gpupdate /force</code> (possibly unnecessary, but I wanted to save myself a possible second reboot) and rebooted the computer. Then the policy was applied as before in step 5.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>In my opinion, setting up Windows Defender Application Control / CodeIntegrity / PowerShell Language Modes is unnecessarily complicated. I also find it a bit of a headache that the more modern multi-policies are not actually supported via Group Policy.</p><h2 id=related-links>Related Links<a hidden class=anchor aria-hidden=true href=#related-links>#</a></h2><p>Here are a few more links and sources that helped me with my research. In particular, I would like to highlight the blog series on airdesk.com about WDAC:</p><ul><li><a href=https://airdesk.com/2019/11/mdac-and-intune-blog-series/ target=_blank>airdesk.com: WDAC and Intune Blog series</a></li><li><a href=https://airdesk.com/2019/11/mdac-and-path-rules/ target=_blank>airdesk.com: WDAC and File Path Rules</a></li></ul><p>And some very good infos from HotCakeX:</p><ul><li><a href=https://github.com/HotCakeX/Harden-Windows-Security/wiki/Introduction target=_blank>WDAC Wiki on Github by HotCakeX</a></li><li><a href=https://superuser.com/questions/1741554/i-cant-get-windows-defender-application-control-policy-working-in-windows-11/1771065#1771065 target=_blank>This really verbose and insightful answer on superuser.com</a></li></ul><p>A few useful informations are available at Microsoft:</p><ul><li><a href=https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/create-wdac-policy-for-fully-managed-devices target=_blank>Create a WDAC policy for fully managed devices</a></li><li><a href=https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/design/script-enforcement#enlightened-script-hosts-that-are-part-of-windows target=_blank>Enlightened script hosts that are part of Windows</a></li><li><a href=https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/select-types-of-rules-to-create#table-1-windows-defender-application-control-policy---policy-rule-options target=_blank>Windows Defender Application Control policy - policy rule options</a></li><li><a href="https://learn.microsoft.com/en-us/powershell/module/configci/new-cipolicy?view=windowsserver2022-ps" target=_blank>New-CIPolicy Cmdlet</a></li><li><a href=https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/deployment/deploy-windows-defender-application-control-policies-using-group-policy target=_blank>Deployment per GPO</a></li><li><a href=https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/disable-windows-defender-application-control-policies target=_blank>Remove a WDAC Policy</a></li><li><a href=https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/deploy-multiple-windows-defender-application-control-policies target=_blank>Multi-Policy local Deployment</a></li><li><a href=https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/event-id-explanations target=_blank>WDAC EventLogs</a></li><li><a href=https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/ target=_blank>PowerShell Team: PowerShell Constrained Language Mode</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://diecknet.de/en/tags/powershell/>Powershell</a></li><li><a href=https://diecknet.de/en/tags/language-mode/>Language Mode</a></li><li><a href=https://diecknet.de/en/tags/constrained-language/>Constrained Language</a></li></ul><div class=share-buttons></div></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://diecknet.de/en/>diecknet</a></span>
&nbsp;|&nbsp;
<span><a href=https://diecknet.de/en/legal/>Imprint</a>
</span>&nbsp;|&nbsp;<span>
<a href=https://diecknet.de/en/privacy/>Privacy</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript>var _paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="//nc.diecknet.de/mt/",_paq.push(["setTrackerUrl",t+"mdata"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.defer=!0,e.src=t+"m.js",s.parentNode.insertBefore(e,s)}()</script><noscript><p><img src="https://nc.diecknet.de/mt/mdata?idsite=1&amp;rec=1" style=border:0 alt></p></noscript></body></html>