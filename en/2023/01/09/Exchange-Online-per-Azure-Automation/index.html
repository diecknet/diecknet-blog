<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Automate Exchange Online with Azure Automation in 2024 | diecknet</title>
<meta name=keywords content="microsoft365,office365,exchangeonline,powershell,exo,azure,azureautomation"><meta name=description content="If you want to manage Exchange Online via Azure Automation, Managed Identities is what you should use (this statement was last checked in June 2024).
Legacy approach In the past, RunAs Accounts or Plaintext Credentials (ü§¢) were also commonly used for this purpose, but this is now considered deprecated. RunAs accounts will be discontinued by fall 2023. And I don&rsquo;t have to say anything about plaintext passwords, do I? You could still use App Registrations in Entra ID, but if you really just want to automate some Exchange settings via Azure Automation, it&rsquo;s not really necessary."><meta name=author content="Andreas Dieckmann"><link rel=canonical href=https://diecknet.de/en/2023/01/09/Exchange-Online-per-Azure-Automation/><link crossorigin=anonymous href=/assets/css/stylesheet.75a517428f403193483801122d6350f6956c3bb6bf5c6504311f8c24e6bab3e7.css integrity="sha256-daUXQo9AMZNIOAESLWNQ9pVsO7a/XGUEMR+MJOa6s+c=" rel="preload stylesheet" as=style><link rel=icon href=https://diecknet.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://diecknet.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://diecknet.de/favicon-32x32.png><link rel=apple-touch-icon href=https://diecknet.de/apple-touch-icon.png><link rel=mask-icon href=https://diecknet.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=de href=https://diecknet.de/de/2023/01/09/Exchange-Online-per-Azure-Automation/><link rel=alternate hreflang=en href=https://diecknet.de/en/2023/01/09/Exchange-Online-per-Azure-Automation/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Automate Exchange Online with Azure Automation in 2024"><meta property="og:description" content="If you want to manage Exchange Online via Azure Automation, Managed Identities is what you should use (this statement was last checked in June 2024).
Legacy approach In the past, RunAs Accounts or Plaintext Credentials (ü§¢) were also commonly used for this purpose, but this is now considered deprecated. RunAs accounts will be discontinued by fall 2023. And I don&rsquo;t have to say anything about plaintext passwords, do I? You could still use App Registrations in Entra ID, but if you really just want to automate some Exchange settings via Azure Automation, it&rsquo;s not really necessary."><meta property="og:type" content="article"><meta property="og:url" content="https://diecknet.de/en/2023/01/09/Exchange-Online-per-Azure-Automation/"><meta property="og:image" content="https://diecknet.de/images/2023/2023-AA-EXO.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-09T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-25T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://diecknet.de/images/2023/2023-AA-EXO.jpg"><meta name=twitter:title content="Automate Exchange Online with Azure Automation in 2024"><meta name=twitter:description content="If you want to manage Exchange Online via Azure Automation, Managed Identities is what you should use (this statement was last checked in June 2024).
Legacy approach In the past, RunAs Accounts or Plaintext Credentials (ü§¢) were also commonly used for this purpose, but this is now considered deprecated. RunAs accounts will be discontinued by fall 2023. And I don&rsquo;t have to say anything about plaintext passwords, do I? You could still use App Registrations in Entra ID, but if you really just want to automate some Exchange settings via Azure Automation, it&rsquo;s not really necessary."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://diecknet.de/en/posts/"},{"@type":"ListItem","position":2,"name":"Automate Exchange Online with Azure Automation in 2024","item":"https://diecknet.de/en/2023/01/09/Exchange-Online-per-Azure-Automation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Automate Exchange Online with Azure Automation in 2024","name":"Automate Exchange Online with Azure Automation in 2024","description":"If you want to manage Exchange Online via Azure Automation, Managed Identities is what you should use (this statement was last checked in June 2024).\nLegacy approach In the past, RunAs Accounts or Plaintext Credentials (ü§¢) were also commonly used for this purpose, but this is now considered deprecated. RunAs accounts will be discontinued by fall 2023. And I don\u0026rsquo;t have to say anything about plaintext passwords, do I? You could still use App Registrations in Entra ID, but if you really just want to automate some Exchange settings via Azure Automation, it\u0026rsquo;s not really necessary.","keywords":["microsoft365","office365","exchangeonline","powershell","exo","azure","azureautomation"],"articleBody":"If you want to manage Exchange Online via Azure Automation, Managed Identities is what you should use (this statement was last checked in June 2024).\nLegacy approach In the past, RunAs Accounts or Plaintext Credentials (ü§¢) were also commonly used for this purpose, but this is now considered deprecated. RunAs accounts will be discontinued by fall 2023. And I don‚Äôt have to say anything about plaintext passwords, do I? You could still use App Registrations in Entra ID, but if you really just want to automate some Exchange settings via Azure Automation, it‚Äôs not really necessary.\nManaged Identities + Exchange Online PowerShell A System Assigned Managed Identity assigns an identity to an Azure Resource. This identity can be assigned rights, e.g. for the administration of Exchange Online or specific Azure Resources. The management of the identity is done automatically, so there is no need to change a password regularly or anything like that. And if the associated resource (in this case the Azure Automation account) is deleted, the System Assigned Managed Identity is automatically deleted as well. The Exchange Online PowerShell module supports Managed Identities for authentication starting with version 3.\nThat should theoretically also work with a User Assigned Managed Identity. In that case you‚Äôll create the Managed Identity yourself, but you can assign it to multiple Azure resources. Also useful for some scenarios.\nEnable Managed Identity I prefer System Assigned Managed Identities, because then only one resource gets the rights. You can check if the Automation Account has a Managed Identity under ‚ÄúAccount settings‚Äù -\u003e ‚ÄúIdentity‚Äù. Here is a example screenshot with an existing Managed Identity: The status is ‚ÄúOn‚Äù und an Object ID is shown.\nThe actual assignment of the ‚ÄúExchange Administrator‚Äù-role is done via PowerShell/Graph API.\nConfiguration via PowerShell In this section I‚Äôll describe how to configure the permissions using PowerShell. The assignment of the ‚ÄúExchange Administrator‚Äù-role to a Managed Identity needs to be done using a local PowerShell session - the following code shouldn‚Äôt be run as an Azure Automation runbook.\nPrerequisites:\nThe Microsoft.Graph PowerShell module A user account with the admin role ‚ÄúPrivileged Role Administrator‚Äù or ‚ÄúGlobal Administrator‚Äù If you don‚Äôt have the module installed yet, check this article.\n1 Install-Module Microsoft.Graph Then you can use the following code. The code is commented inline, so I don‚Äôt explain it here further.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 Connect-MgGraph -Scopes AppRoleAssignment.ReadWrite.All,Application.Read.All,RoleManagement.ReadWrite.Directory # Put your Managed Identity / Enterprise App registration name here: $MI_Name = \"Mein-Automation-Account\" # there is no need to change any of the code below $MI_SP = Get-MgServicePrincipal -Property \"displayName,appId,id\" -Filter \"servicePrincipalType eq 'ManagedIdentity' and DisplayName eq '$($MI_Name)'\" -ErrorAction Stop if($MI_SP.Count -ne 1) { Write-Error \"Something is wrong, found $($MI_SP.Count) matching Entra Service Principals. Aborting...\" exit 1 } else { $MI_ID = $MI_SP.Id } # try to retrieve the Exchange Online Service Principal (sometimes it's not available) $EXO_SP = Get-MgServicePrincipal -Filter \"AppId eq '00000002-0000-0ff1-ce00-000000000000'\" if(!$EXO_SP) { Write-Error \"No Exchange Online Service Principal found. Check this for troubleshooting: https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps#what-to-do-if-the-office-365-exchange-online-resource-is-not-available-in-microsoft-entra-id\" exit 1 # we can't proceed without the EXO_SP } # Exchange.ManageAsApp API Permission $AppRoleId = \"dc50a0fb-09a3-484d-be87-e023b12c6440\" # the GUID value of the Office 365 Exchange Online resource in Microsoft Entra ID. The AppId value is the same in every organization, but the Id value is different in every organization. $ResourceID = $EXO_SP.Id # the actual assignment of Exchange.ManageAsApp: New-MgServicePrincipalAppRoleAssignment -ServicePrincipalId $MI_ID -PrincipalId $MI_ID -AppRoleId $AppRoleID -ResourceId $ResourceID $ExchangeAdminRoleID = (Get-MgRoleManagementDirectoryRoleDefinition -Filter \"DisplayName eq 'Exchange Administrator'\").Id # the actual assignment of the Exchange Administrator role: New-MgRoleManagementDirectoryRoleAssignment -PrincipalId $MI_ID -RoleDefinitionId $ExchangeAdminRoleID -DirectoryScopeId \"/\" Add the module Regardless of whether you are already using ‚ÄúRuntime Environments‚Äù or the ‚ÄúOld experience‚Äù, you must add the ExchangeOnlineManagement PowerShell module. In the case of the ‚ÄúOld experience‚Äù add it to the Automation account. If you are using Runtime Environments, then add the module to a Runtime Environment instead or create a new Runtime Environment. The module is supported by both Windows PowerShell and PowerShell 7.\nUse Exchange Online PowerShell The following example code for a runbook connects to the Exchange Online administration as a System Managed Managed Identity, executes an Exchange Online PowerShell command and then disconnects from Exchange Online again.\n1 2 3 4 5 6 7 8 # Replace the Organization name with a domain from your tenant Connect-ExchangeOnline -ManagedIdentity -Organization demotenant.de # Example command that uses Exchange Online PowerShell: List all mailboxes Get-ExoMailbox # Disconnect again to free up connections Disconnect-ExchangeOnline -Confirm:$false Howto Video (German) I created a German Video showing how Exchange Online can be controlled via Azure Automation. This involves using a System Assigned Managed Identity for the Azure Automation account and assigning Exchange management rights to this identity. You can probably use the automatic translated Subtitles on YouTube, if you don‚Äôt speak German.\nFurther links The official Microsoft documentation for this can be found here: https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps\n","wordCount":"831","inLanguage":"en","image":"https://diecknet.de/images/2023/2023-AA-EXO.jpg","datePublished":"2023-01-09T00:00:00Z","dateModified":"2024-06-25T00:00:00Z","author":{"@type":"Person","name":"Andreas Dieckmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diecknet.de/en/2023/01/09/Exchange-Online-per-Azure-Automation/"},"publisher":{"@type":"Organization","name":"diecknet","logo":{"@type":"ImageObject","url":"https://diecknet.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diecknet.de/en/ accesskey=h title="diecknet (Alt + H)">diecknet</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://diecknet.de/de/2023/01/09/Exchange-Online-per-Azure-Automation/ title=Deutsch aria-label=Deutsch>Deutsch</a></li><li><a href=https://diecknet.de/en/2023/01/09/Exchange-Online-per-Azure-Automation/ title=English aria-label=English><b>English</b></a></li></ul></div></div><ul id=menu><li><a href=https://diecknet.de/en/ title=Home><span>Home</span></a></li><li><a href=https://diecknet.de/en/services/ title=Services><span>Services</span></a></li><li><a href=https://diecknet.de/en/about/ title=About><span>About</span></a></li><li><a href=https://diecknet.de/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://diecknet.de/en/archive/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://diecknet.de/en/>Home</a>&nbsp;¬ª&nbsp;<a href=https://diecknet.de/en/posts/>Posts</a></div><h1 class=post-title>Automate Exchange Online with Azure Automation in 2024</h1><div class=post-meta><span title='2023-01-09 00:00:00 +0000 UTC'>2023-01-09</span>&nbsp;¬∑&nbsp;4 min&nbsp;¬∑&nbsp;Andreas Dieckmann&nbsp;|&nbsp;<ul class=i18n_list>üåç&nbsp;Dieser Inhalt ist auch verf√ºgbar auf:&nbsp;<li><a href=https://diecknet.de/de/2023/01/09/Exchange-Online-per-Azure-Automation/>Deutsch</a></li></ul>&nbsp;|&nbsp;<a href=https://github.com/diecknet/diecknet-blog/tree/main/content/en/posts/2023/2023-01-09-Exchange-Online-per-Azure-Automation.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><figure class=entry-cover><img loading=lazy src=https://diecknet.de/images/2023/2023-AA-EXO.jpg alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#legacy-approach aria-label="Legacy approach">Legacy approach</a></li><li><a href=#managed-identities--exchange-online-powershell aria-label="Managed Identities + Exchange Online PowerShell">Managed Identities + Exchange Online PowerShell</a><ul><li><a href=#enable-managed-identity aria-label="Enable Managed Identity">Enable Managed Identity</a></li></ul></li><li><a href=#configuration-via-powershell aria-label="Configuration via PowerShell">Configuration via PowerShell</a><ul><li><a href=#add-the-module aria-label="Add the module">Add the module</a></li><li><a href=#use-exchange-online-powershell aria-label="Use Exchange Online PowerShell">Use Exchange Online PowerShell</a></li></ul></li><li><a href=#howto-video-german aria-label="Howto Video (German)">Howto Video (German)</a></li><li><a href=#further-links aria-label="Further links">Further links</a></li></ul></div></details></div><div class=post-content><p>If you want to manage Exchange Online via Azure Automation, <strong>Managed Identities</strong> is what you should use (this statement was last checked in June 2024).</p><h2 id=legacy-approach>Legacy approach<a hidden class=anchor aria-hidden=true href=#legacy-approach>#</a></h2><p>In the past, RunAs Accounts or Plaintext Credentials (ü§¢) were also commonly used for this purpose, but this is now considered deprecated. RunAs accounts will be discontinued by fall 2023. And I don&rsquo;t have to say anything about plaintext passwords, do I?
You could still use App Registrations in Entra ID, but if you really just want to automate some Exchange settings via Azure Automation, it&rsquo;s not really necessary.</p><h2 id=managed-identities--exchange-online-powershell>Managed Identities + Exchange Online PowerShell<a hidden class=anchor aria-hidden=true href=#managed-identities--exchange-online-powershell>#</a></h2><p>A <strong>System Assigned Managed Identity</strong> assigns an <em>identity</em> to an Azure Resource. This identity can be assigned rights, e.g. for the administration of Exchange Online or specific Azure Resources. The management of the identity is done automatically, so there is no need to change a password regularly or anything like that. And if the associated resource (in this case the Azure Automation account) is deleted, the System Assigned Managed Identity is automatically deleted as well.
The Exchange Online PowerShell module supports Managed Identities for authentication starting with version 3.</p><p>That should theoretically also work with a User Assigned Managed Identity. In that case you&rsquo;ll create the Managed Identity yourself, but you can assign it to multiple Azure resources. Also useful for some scenarios.</p><h3 id=enable-managed-identity>Enable Managed Identity<a hidden class=anchor aria-hidden=true href=#enable-managed-identity>#</a></h3><p>I prefer System Assigned Managed Identities, because then only one resource gets the rights. You can check if the Automation Account has a Managed Identity under &ldquo;Account settings&rdquo; -> &ldquo;Identity&rdquo;. Here is a example screenshot with an existing Managed Identity: The status is &ldquo;On&rdquo; und an Object ID is shown.</p><p><a href=/images/2024/2024-06-21_AutomationAccount-Managed-Identity.jpg><img loading=lazy src=/images/2024/2024-06-21_AutomationAccount-Managed-Identity.jpg alt="Example for an Azure Automation Account with a System Assigned Managed Identity" title="Example for an Azure Automation Account with a System Assigned Managed Identity"></a></p><p>The actual assignment of the &ldquo;Exchange Administrator&rdquo;-role is done via <a href=#configuration-via-powershell>PowerShell/Graph API</a>.</p><h2 id=configuration-via-powershell>Configuration via PowerShell<a hidden class=anchor aria-hidden=true href=#configuration-via-powershell>#</a></h2><p>In this section I&rsquo;ll describe how to configure the permissions using PowerShell. The assignment of the &ldquo;Exchange Administrator&rdquo;-role to a Managed Identity needs to be done using a local PowerShell session - the following code shouldn&rsquo;t be run as an Azure Automation runbook.</p><p>Prerequisites:</p><ul><li>The Microsoft.Graph PowerShell module</li><li>A user account with the admin role &ldquo;Privileged Role Administrator&rdquo; or &ldquo;Global Administrator&rdquo;</li></ul><p>If you don&rsquo;t have the module installed yet, <a href="https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation?view=graph-powershell-1.0" target=_blank>check this article</a>.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Install-Module</span> Microsoft.Graph
</span></span></code></pre></td></tr></table></div></div><p>Then you can use the following code. The code is commented inline, so I don&rsquo;t explain it here further.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Connect-MgGraph</span> -Scopes AppRoleAssignment.ReadWrite.All,Application.Read.All,RoleManagement.ReadWrite.Directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Put your Managed Identity / Enterprise App registration name here:</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$MI_Name</span> = <span style=color:#fc6a5d>&#34;Mein-Automation-Account&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># there is no need to change any of the code below</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$MI_SP</span> = <span style=color:#d0a8ff>Get-MgServicePrincipal</span> -Property <span style=color:#fc6a5d>&#34;displayName,appId,id&#34;</span> -Filter <span style=color:#fc6a5d>&#34;servicePrincipalType eq &#39;ManagedIdentity&#39; and DisplayName eq &#39;</span>$(<span style=color:#41a1c0>$MI_Name</span>)<span style=color:#fc6a5d>&#39;&#34;</span> -ErrorAction Stop
</span></span><span style=display:flex><span><span style=color:#fc5fa3>if</span>(<span style=color:#41a1c0>$MI_SP</span>.Count -ne <span style=color:#d0bf69>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#d0a8ff>Write-Error</span> <span style=color:#fc6a5d>&#34;Something is wrong, found </span>$(<span style=color:#41a1c0>$MI_SP</span>.Count)<span style=color:#fc6a5d> matching Entra Service Principals. Aborting...&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#d0bf69>1</span>
</span></span><span style=display:flex><span>} <span style=color:#fc5fa3>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#41a1c0>$MI_ID</span> = <span style=color:#41a1c0>$MI_SP</span>.Id
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># try to retrieve the Exchange Online Service Principal (sometimes it&#39;s not available)</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$EXO_SP</span> = <span style=color:#d0a8ff>Get-MgServicePrincipal</span> -Filter <span style=color:#fc6a5d>&#34;AppId eq &#39;00000002-0000-0ff1-ce00-000000000000&#39;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>if</span>(!<span style=color:#41a1c0>$EXO_SP</span>) {
</span></span><span style=display:flex><span>    <span style=color:#d0a8ff>Write-Error</span> <span style=color:#fc6a5d>&#34;No Exchange Online Service Principal found. Check this for troubleshooting: https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps#what-to-do-if-the-office-365-exchange-online-resource-is-not-available-in-microsoft-entra-id&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#d0bf69>1</span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986># we can&#39;t proceed without the EXO_SP</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Exchange.ManageAsApp API Permission</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$AppRoleId</span> = <span style=color:#fc6a5d>&#34;dc50a0fb-09a3-484d-be87-e023b12c6440&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># the GUID value of the Office 365 Exchange Online resource in Microsoft Entra ID. The AppId value is the same in every organization, but the Id value is different in every organization.</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$ResourceID</span> = <span style=color:#41a1c0>$EXO_SP</span>.Id 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># the actual assignment of Exchange.ManageAsApp:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>New-MgServicePrincipalAppRoleAssignment</span> -ServicePrincipalId <span style=color:#41a1c0>$MI_ID</span> -PrincipalId <span style=color:#41a1c0>$MI_ID</span> -AppRoleId <span style=color:#41a1c0>$AppRoleID</span> -ResourceId <span style=color:#41a1c0>$ResourceID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$ExchangeAdminRoleID</span> = (<span style=color:#d0a8ff>Get-MgRoleManagementDirectoryRoleDefinition</span> -Filter <span style=color:#fc6a5d>&#34;DisplayName eq &#39;Exchange Administrator&#39;&#34;</span>).Id
</span></span><span style=display:flex><span><span style=color:#6c7986># the actual assignment of the Exchange Administrator role:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>New-MgRoleManagementDirectoryRoleAssignment</span> -PrincipalId <span style=color:#41a1c0>$MI_ID</span> -RoleDefinitionId <span style=color:#41a1c0>$ExchangeAdminRoleID</span> -DirectoryScopeId <span style=color:#fc6a5d>&#34;/&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=add-the-module>Add the module<a hidden class=anchor aria-hidden=true href=#add-the-module>#</a></h3><p>Regardless of whether you are already using &ldquo;Runtime Environments&rdquo; or the &ldquo;Old experience&rdquo;, you must add the ExchangeOnlineManagement PowerShell module. In the case of the &ldquo;Old experience&rdquo; add it to the Automation account. If you are using Runtime Environments, then add the module to a Runtime Environment instead or create a new Runtime Environment. The module is supported by both Windows PowerShell and PowerShell 7.</p><h3 id=use-exchange-online-powershell>Use Exchange Online PowerShell<a hidden class=anchor aria-hidden=true href=#use-exchange-online-powershell>#</a></h3><p>The following example code for a runbook connects to the Exchange Online administration as a System Managed Managed Identity, executes an Exchange Online PowerShell command and then disconnects from Exchange Online again.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#6c7986># Replace the Organization name with a domain from your tenant</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Connect-ExchangeOnline</span> -ManagedIdentity -Organization demotenant.de
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Example command that uses Exchange Online PowerShell: List all mailboxes</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Get-ExoMailbox</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Disconnect again to free up connections</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Disconnect-ExchangeOnline</span> -Confirm:$false
</span></span></code></pre></td></tr></table></div></div><h2 id=howto-video-german>Howto Video (German)<a hidden class=anchor aria-hidden=true href=#howto-video-german>#</a></h2><p>I created a <a href="https://www.youtube.com/watch?v=unXf7ma1NR4" target=_blank>German Video</a> showing how Exchange Online can be controlled via Azure Automation. This involves using a System Assigned Managed Identity for the Azure Automation account and assigning Exchange management rights to this identity. You can probably use the automatic translated Subtitles on YouTube, if you don&rsquo;t speak German.</p><p><a href="https://www.youtube.com/watch?v=unXf7ma1NR4" target=_blank><img loading=lazy src=/images/2023/2023-01-09_Azure_Automation_Exchange_online_thumbnail.png alt="German Video: Manage Exchange Online via Azure Automation (YouTube)" title="German Video: Manage Exchange Online via Azure Automation (YouTube)"></a></p><h2 id=further-links>Further links<a hidden class=anchor aria-hidden=true href=#further-links>#</a></h2><p>The official Microsoft documentation for this can be found here: <a href="https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps" target=_blank>https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://diecknet.de/en/tags/microsoft365/>Microsoft365</a></li><li><a href=https://diecknet.de/en/tags/office365/>Office365</a></li><li><a href=https://diecknet.de/en/tags/exchangeonline/>Exchangeonline</a></li><li><a href=https://diecknet.de/en/tags/powershell/>Powershell</a></li><li><a href=https://diecknet.de/en/tags/exo/>Exo</a></li><li><a href=https://diecknet.de/en/tags/azure/>Azure</a></li><li><a href=https://diecknet.de/en/tags/azureautomation/>Azureautomation</a></li></ul><div class=share-buttons></div></footer><script src=https://giscus.diecknet.de/client.js data-repo=diecknet/diecknet-blog data-repo-id="MDEwOlJlcG9zaXRvcnkyMDkzNDUzNzM=" data-category="Blog Discussions" data-category-id=MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyNjMwOTY0 data-mapping=specific data-term=Exchange-Online-per-Azure-Automation data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://diecknet.de/en/>diecknet</a></span>
&nbsp;|&nbsp;
<span><a href=https://diecknet.de/en/legal/>Imprint</a>
</span>&nbsp;|&nbsp;<span>
<a href=https://diecknet.de/en/privacy/>Privacy</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript>var _paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="//nc.diecknet.de/mt/",_paq.push(["setTrackerUrl",t+"mdata"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.defer=!0,e.src=t+"m.js",s.parentNode.insertBefore(e,s)}()</script><noscript><p><img src="https://nc.diecknet.de/mt/mdata?idsite=1&amp;rec=1" style=border:0 alt></p></noscript></body></html>