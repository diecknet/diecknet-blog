<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>My simple serverless journey was not that easy | diecknet</title>
<meta name=keywords content="simpleip,serverless,cloud,vercel,cloudflare,cloudflareworkers,ipaddress"><meta name=description content="Serverless Computing is an interesting concept. You can execute a script or programm without setting up the infrastructure behind it (servers, storage, networks, etc.). You just write your code and it gets executed. But Serverless doesn&rsquo;t mean &ldquo;without any servers&rdquo; - you just don&rsquo;t need to worry about them. That&rsquo;s not that much of a difference to renting classic webspace from any webhosting service and putting your PHP scripts there. Nowadays Serverless usually means some kind of modern architecture that allows you to run your application code."><meta name=author content="Andreas Dieckmann"><link rel=canonical href=https://diecknet.de/en/2021/05/02/My-simple-serverless-journey/><link crossorigin=anonymous href=/assets/css/stylesheet.75a517428f403193483801122d6350f6956c3bb6bf5c6504311f8c24e6bab3e7.css integrity="sha256-daUXQo9AMZNIOAESLWNQ9pVsO7a/XGUEMR+MJOa6s+c=" rel="preload stylesheet" as=style><link rel=icon href=https://diecknet.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://diecknet.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://diecknet.de/favicon-32x32.png><link rel=apple-touch-icon href=https://diecknet.de/apple-touch-icon.png><link rel=mask-icon href=https://diecknet.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://diecknet.de/en/2021/05/02/My-simple-serverless-journey/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="My simple serverless journey was not that easy"><meta property="og:description" content="Serverless Computing is an interesting concept. You can execute a script or programm without setting up the infrastructure behind it (servers, storage, networks, etc.). You just write your code and it gets executed. But Serverless doesn&rsquo;t mean &ldquo;without any servers&rdquo; - you just don&rsquo;t need to worry about them. That&rsquo;s not that much of a difference to renting classic webspace from any webhosting service and putting your PHP scripts there. Nowadays Serverless usually means some kind of modern architecture that allows you to run your application code."><meta property="og:type" content="article"><meta property="og:url" content="https://diecknet.de/en/2021/05/02/My-simple-serverless-journey/"><meta property="og:image" content="https://diecknet.de/images/2021/2021-05-02_SimpleIP.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-02T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-02T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://diecknet.de/images/2021/2021-05-02_SimpleIP.jpg"><meta name=twitter:title content="My simple serverless journey was not that easy"><meta name=twitter:description content="Serverless Computing is an interesting concept. You can execute a script or programm without setting up the infrastructure behind it (servers, storage, networks, etc.). You just write your code and it gets executed. But Serverless doesn&rsquo;t mean &ldquo;without any servers&rdquo; - you just don&rsquo;t need to worry about them. That&rsquo;s not that much of a difference to renting classic webspace from any webhosting service and putting your PHP scripts there. Nowadays Serverless usually means some kind of modern architecture that allows you to run your application code."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://diecknet.de/en/posts/"},{"@type":"ListItem","position":2,"name":"My simple serverless journey was not that easy","item":"https://diecknet.de/en/2021/05/02/My-simple-serverless-journey/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"My simple serverless journey was not that easy","name":"My simple serverless journey was not that easy","description":"Serverless Computing is an interesting concept. You can execute a script or programm without setting up the infrastructure behind it (servers, storage, networks, etc.). You just write your code and it gets executed. But Serverless doesn\u0026rsquo;t mean \u0026ldquo;without any servers\u0026rdquo; - you just don\u0026rsquo;t need to worry about them. That\u0026rsquo;s not that much of a difference to renting classic webspace from any webhosting service and putting your PHP scripts there. Nowadays Serverless usually means some kind of modern architecture that allows you to run your application code.","keywords":["simpleip","serverless","cloud","vercel","cloudflare","cloudflareworkers","ipaddress"],"articleBody":"Serverless Computing is an interesting concept. You can execute a script or programm without setting up the infrastructure behind it (servers, storage, networks, etc.). You just write your code and it gets executed. But Serverless doesn‚Äôt mean ‚Äúwithout any servers‚Äù - you just don‚Äôt need to worry about them. That‚Äôs not that much of a difference to renting classic webspace from any webhosting service and putting your PHP scripts there. Nowadays Serverless usually means some kind of modern architecture that allows you to run your application code. The difference is scaling. The cloud provider handles the logic to run your serverless functions as it‚Äôs needed. When your application is not used, the execution is stopped and no computing resources are consumed.\nMy serverless use case Sometimes I simply need to find out my public IP-Address, without worrying about any specific system caveats. The easiest way to find out that information, is to browse any of the roughly 1.5 billion websites that display the visitor‚Äôs IP-Address.\nThing is - these websites are really annoying, full of ads, tracking and tons of unnecessary informations. I can never be sure if any of these particular sites is actually safe to use. Even if at one point in time a site is usable, I can‚Äôt be sure if it will stay like that. I decided to make my own website to show the IP-Address.\nGoing Serverless with Vercel My first attempt was to use Vercel. I‚Äôm already hosting this blog there as a static site using Jekyll with Github integration. I knew that Vercel also supports Serverless functions. I somehow got the idea to create a static Jamstack site and then fetch the IP-Address using a JavaScript AJAX request to a self-written JSON API which runs as a Serverless function.\nThat was actually pretty easy.\nCreate a new Github repository and connect it with Vercel Create a ‚Äú.js‚Äù-script file in the ‚Äúapi‚Äù subfolder. I used this code to return the visitor‚Äôs IP-Adress as a simple JSON response:\n1 2 3 4 5 6 /*ip.js*/ module.exports = (req, res) =\u003e { res.json({ ip: req.headers[\"x-forwarded-for\"] }); }; Neat! Vercel returns the client IP-Address for every request in req.headers['x-forwarded-for'].\nI then started out to write a simple clientside JavaScript that calls the API URL to retrieve the IP-Address. Wow! That‚Äôs on-point thinking in microservices üòÖ.\nI quickly got to a working frontend site, until I realized: Vercel doesn‚Äôt support IPv6. Woops. Nevermind I can still use my frontend, I‚Äôll just switch my backend provider.\nSwitching to Serverless with Cloudflare Workers So I switched over to Cloudflare Workers. Mainly because they do support IPv6 and IPv4. Since Cloudflare Workers is providing the visitor‚Äôs IP-Address in a different way, I had to rewrite my complete backend ü§≠. I came up with this code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 function getClientIPInfo(request) { /*get clientdata from cloudflare workers*/ /*the ||-comparison is to prevent errors in the workers quick edit mode*/ let location = (request.cf || {}).country; // if we know which city, prepend to location if ((request.cf || {}).city) { location = (request.cf || {}).city + \", \" + location; } const clientIPInfo = { /*get client ip address by Cloudflare header 'CF-Connecting-IP'*/ ipaddress: request.headers.get(\"CF-Connecting-IP\"), /*location of client ip address*/ location: location }; return clientIPInfo; } Eventhough I wanted to keep it simple, I found the location info too cool to leave it out üòÖ. So I‚Äôm also returning an estimated location with city and country. The city-info is often not really accurate, but the country usually works.\nCool.\nThe static site on Cloudflare Pages I‚Äôve then put my static site on Cloudflare Pages. Because I didn‚Äôt want to use any overblown framework, I decided to style the site with W3.CSS and write my own simple code for the AJAX request. Also not really the best-practice JS code, but it worked for me. I even included a method to make it work in Internet Explorer 5 and 6 - eventhough I didn‚Äôt test if that actually works.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 /*Retrieve IP-Address using AJAX request*/ function getIPinfo() { var jsonresult = {}; var locationtext = \"\"; // Create Object for classic AJAX Request var xhttp; //= new XMLHttpRequest(); if (window.XMLHttpRequest) { // AJAX for modern browsers xhttp = new XMLHttpRequest(); } else { // AJAX for IE6, IE5 xhttp = new ActiveXObject(\"Microsoft.XMLHTTP\"); } xhttp.onreadystatechange = function () { // request is technically OK, if the request is \"done\" (readyState == 4) and the HTTP Response Code is \"OK\" (status == 200) if (this.readyState == 4 \u0026\u0026 this.status == 200) { // trying to parse the result as json try { jsonresult = JSON.parse(this.responseText); } catch (e) { // use this placeholder data if parsing was not possible in try{} script block above jsonresult = JSON.parse('{\"ip\":\"ERROR\",\"country\":\"XX\"}'); console.log(\"Error while trying to parse JSON response\"); console.log(e); } // output JSON in console log console.log(jsonresult); // trying to fill in IP address field on site try { document.getElementById(\"ipaddress\").value = jsonresult.ip; } catch (e) { console.log(\"Error while trying to fill in IP address\"); console.log(e); } // gather country info in variable \"locationtext\", if country set and not \"XX\" (Cloudflare placeholder for \"unknown\") if (jsonresult.country \u0026\u0026 jsonresult.country != \"XX\") { locationtext = jsonresult.country; } else { locationtext = \"Unknown\"; } // gather city info in variable \"locationtext\", if city is set if (jsonresult.city) { locationtext = jsonresult.city + \", \" + locationtext; } // trying to set location text on site try { document.getElementById(\"location\").innerText = locationtext; } catch (e) { console.log(\"Error while trying to fill in IP address\"); console.log(e); } } }; xhttp.open(\"GET\", \"https://ip.di1.workers.dev/ip\", true); xhttp.send(); } I then started out to write a function to copy the IP-Address to the user‚Äôs clipboard. There is a legacy way to do it, using document.execCommand(\"copy\"); and a modern way via the Clipboard API navigator.clipboard.writeText();. I decided to implement both, with the modern approach first and the old method as a fallback.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 function copy2Clipboard(whichElement) { // copy the textvalue from the specified element into the clipboard // using the modern clipboard API var copyText = document.getElementById(whichElement); try { navigator.clipboard.writeText(copyText.value).then( function () { console.log(\"success\"); }, function () { console.log(\"fail\"); } ); } catch (e) { console.log(e); copy2ClipboardLegacy(whichElement); } } function copy2ClipboardLegacy(whichElement) { // copy the textvalue from the specified element into the clipboard // using the legacy exec-copy command method // this is used as a fallback, if copy2Clipboard fails. try { var copyText = document.getElementById(whichElement); copyText.select(); copyText.setSelectionRange(0, 999); document.execCommand(\"copy\"); } catch (e) { console.log(\"legacy copy to clipboard failed\"); console.log(e); } } Now I‚Äôm basically done, so let‚Äôs change the architecture again üôÑ.\nNoScript first - Cloudflare Workers Sites I then realized, that I didn‚Äôt like my current approach for two reasons:\nThe website requires clientside JavaScript to work. I‚Äôm using NoScript (or ScriptSafe) myself and I don‚Äôt really like websites that require JS to work properly. To display the IP-Address on the site, the user would initiate another unnecessary GET-request. I can deliver a quicker result when serving all information in one request. So I dug deeper and found Cloudflare Workers Sites. Essentially it combines the capabilities of Cloudflare Pages - to deliver static sites through a global CDN - and Cloudflare Workers. The static portions like .html and .css files are saved in Cloudflare KV and get distributed globally. I‚Äôm then using HTMLRewriter to just inject the IP-Address and location info into my static HTML page before delivering it to the user.\nThe rewriting only happens for index.html and sets the value of the HTML-elements with the ids ‚Äúipaddress‚Äù and ‚Äúlocation‚Äù accordingly.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // if the main page / or /index is requested, we apply a HTMLRewriter to inject the IP-Address and location info if (pathname == \"/\" || pathname == \"/index.html\") { let ipInfo = getClientIPInfo(request); return new HTMLRewriter() .on(\"input\", new ElementHandler(ipInfo)) .transform(response); } // [...] /*handles elements to inject values using HTMLRewriter*/ class ElementHandler { constructor(ipInfo) { this.ipInfo = ipInfo; } element(element) { // get element id const elementid = element.getAttribute(\"id\"); // depending on which element-id we have, put ipaddress or location in switch (elementid) { case \"ipaddress\": // set value of ipaddress-field in HTML element.setAttribute(\"value\", this.ipInfo.ipaddress); break; case \"location\": // set value of location-field in HTML element.setAttribute(\"value\", this.ipInfo.location); break; } } } Conclusion Well, the site is up and running. The source code is available on Github, feel free to check the whole thing out. I‚Äôm 100% sure: It would‚Äôve been way easier to just use a classic shared webspace and some PHP code. But this whole process was not just about the result. It was also really interesting to check out Serverless applications and different providers. I do prefer the Cloudflare approach, because the Serverless Workers are executed globally, not only in the US like with Vercel.\n","wordCount":"1583","inLanguage":"en","image":"https://diecknet.de/images/2021/2021-05-02_SimpleIP.jpg","datePublished":"2021-05-02T00:00:00Z","dateModified":"2021-05-02T00:00:00Z","author":{"@type":"Person","name":"Andreas Dieckmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diecknet.de/en/2021/05/02/My-simple-serverless-journey/"},"publisher":{"@type":"Organization","name":"diecknet","logo":{"@type":"ImageObject","url":"https://diecknet.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diecknet.de/en/ accesskey=h title="diecknet (Alt + H)">diecknet</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://diecknet.de/de/ title=Deutsch aria-label=Deutsch>Deutsch</a></li><li><a href=https://diecknet.de/en/ title=English aria-label=English><b>English</b></a></li></ul></div></div><ul id=menu><li><a href=https://diecknet.de/en/ title=Home><span>Home</span></a></li><li><a href=https://diecknet.de/en/services/ title=Services><span>Services</span></a></li><li><a href=https://diecknet.de/en/about/ title=About><span>About</span></a></li><li><a href=https://diecknet.de/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://diecknet.de/en/archive/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://diecknet.de/en/>Home</a>&nbsp;¬ª&nbsp;<a href=https://diecknet.de/en/posts/>Posts</a></div><h1 class=post-title>My simple serverless journey was not that easy</h1><div class=post-meta><span title='2021-05-02 00:00:00 +0000 UTC'>2021-05-02</span>&nbsp;¬∑&nbsp;8 min&nbsp;¬∑&nbsp;Andreas Dieckmann&nbsp;|&nbsp;<a href=https://github.com/diecknet/diecknet-blog/tree/main/content/en/posts/2021/2021-05-02-My-simple-serverless-journey.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><figure class=entry-cover><img loading=lazy src=https://diecknet.de/images/2021/2021-05-02_SimpleIP.jpg alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#my-serverless-use-case aria-label="My serverless use case">My serverless use case</a></li><li><a href=#going-serverless-with-vercel aria-label="Going Serverless with Vercel">Going Serverless with Vercel</a></li><li><a href=#switching-to-serverless-with-cloudflare-workers aria-label="Switching to Serverless with Cloudflare Workers">Switching to Serverless with Cloudflare Workers</a></li><li><a href=#the-static-site-on-cloudflare-pages aria-label="The static site on Cloudflare Pages">The static site on Cloudflare Pages</a></li><li><a href=#noscript-first---cloudflare-workers-sites aria-label="NoScript first - Cloudflare Workers Sites">NoScript first - Cloudflare Workers Sites</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p>Serverless Computing is an interesting concept. You can execute a script or programm without setting up the infrastructure behind it (servers, storage, networks, etc.). You just write your code and it gets executed. But Serverless doesn&rsquo;t mean &ldquo;without any servers&rdquo; - you just don&rsquo;t need to worry about them. That&rsquo;s not that much of a difference to renting classic webspace from any webhosting service and putting your PHP scripts there.
Nowadays Serverless usually means some kind of modern architecture that allows you to run your application code. The difference is <strong>scaling</strong>. The cloud provider handles the logic to run your serverless functions as it&rsquo;s needed. When your application is not used, the execution is stopped and no computing resources are consumed.</p><h2 id=my-serverless-use-case>My serverless use case<a hidden class=anchor aria-hidden=true href=#my-serverless-use-case>#</a></h2><p>Sometimes I <em>simply</em> need to find out my public IP-Address, without worrying about any specific system caveats. The easiest way to find out that information, is to browse any of the roughly 1.5 billion websites that display the visitor&rsquo;s IP-Address.</p><p>Thing is - these websites are really annoying, full of ads, tracking and tons of unnecessary informations. I can never be sure if any of these particular sites is actually safe to use. Even if at one point in time a site is usable, I can&rsquo;t be sure if it will stay like that. I decided to make my own website to show the IP-Address.</p><h2 id=going-serverless-with-vercel>Going Serverless with Vercel<a hidden class=anchor aria-hidden=true href=#going-serverless-with-vercel>#</a></h2><p>My first attempt was to use <a href=https://vercel.com target=_blank>Vercel</a>. I&rsquo;m already hosting this blog there as a static site using Jekyll with Github integration. I knew that Vercel also supports Serverless functions. I somehow got the idea to create a static Jamstack site and then fetch the IP-Address using a JavaScript AJAX request to a self-written JSON API which runs as a Serverless function.</p><p>That was actually pretty easy.</p><ol><li>Create a new Github repository and <a href=https://vercel.com/docs/git target=_blank>connect it with Vercel</a></li><li>Create a &ldquo;.js&rdquo;-script file in the &ldquo;api&rdquo; subfolder.</li></ol><p>I used this code to return the visitor&rsquo;s IP-Adress as a simple JSON response:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#6c7986>/*ip.js*/</span>
</span></span><span style=display:flex><span>module.exports = (req, res) =&gt; {
</span></span><span style=display:flex><span>    res.json({
</span></span><span style=display:flex><span>        ip: req.headers[<span style=color:#fc6a5d>&#34;x-forwarded-for&#34;</span>]
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>Neat! Vercel returns the client IP-Address for every request in <code>req.headers['x-forwarded-for']</code>.</p><p><img loading=lazy src=/images/2021/2021-05-01_vercel_app_api_ip_js.png alt="My first own Microservice displaying an IP-Address as JSON" title="My first own Microservice displaying an IP-Address as JSON"></p><p>I then started out to write a simple clientside JavaScript that calls the API URL to retrieve the IP-Address. Wow! That&rsquo;s on-point thinking in microservices üòÖ.</p><p>I quickly got to a working frontend site, until I realized: Vercel doesn&rsquo;t support IPv6. Woops. Nevermind I can still use my frontend, I&rsquo;ll just switch my backend provider.</p><h2 id=switching-to-serverless-with-cloudflare-workers>Switching to Serverless with Cloudflare Workers<a hidden class=anchor aria-hidden=true href=#switching-to-serverless-with-cloudflare-workers>#</a></h2><p>So I switched over to Cloudflare Workers. Mainly because they do support IPv6 and IPv4. Since Cloudflare Workers is providing the visitor&rsquo;s IP-Address <a href=https://support.cloudflare.com/hc/en-us/articles/200170986-How-does-Cloudflare-handle-HTTP-Request-headers- target=_blank>in a different way</a>, I had to rewrite my complete backend ü§≠. I came up with this code:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#fc5fa3>function</span> getClientIPInfo(request) {
</span></span><span style=display:flex><span>    <span style=color:#6c7986>/*get clientdata from cloudflare workers*/</span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986>/*the ||-comparison is to prevent errors in the workers quick edit mode*/</span>
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>let</span> location = (request.cf || {}).country;
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// if we know which city, prepend to location
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#fc5fa3>if</span> ((request.cf || {}).city) {
</span></span><span style=display:flex><span>        location = (request.cf || {}).city + <span style=color:#fc6a5d>&#34;, &#34;</span> + location;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>const</span> clientIPInfo = {
</span></span><span style=display:flex><span>        <span style=color:#6c7986>/*get client ip address by Cloudflare header &#39;CF-Connecting-IP&#39;*/</span>
</span></span><span style=display:flex><span>        ipaddress: request.headers.get(<span style=color:#fc6a5d>&#34;CF-Connecting-IP&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#6c7986>/*location of client ip address*/</span>
</span></span><span style=display:flex><span>        location: location
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>return</span> clientIPInfo;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Eventhough I wanted to keep it simple, I found the location info too cool to leave it out üòÖ. So I&rsquo;m also returning an estimated location with city and country. The city-info is often not really accurate, but the country usually works.</p><p>Cool.</p><p><img loading=lazy src=/images/2021/2021-05-01_cloudflare_workers_api_ip_js.png alt="My second own Microservice displaying an IP-Address as JSON - on Cloudflare" title="My second own Microservice displaying an IP-Address as JSON - on Cloudflare"></p><h2 id=the-static-site-on-cloudflare-pages>The static site on Cloudflare Pages<a hidden class=anchor aria-hidden=true href=#the-static-site-on-cloudflare-pages>#</a></h2><p>I&rsquo;ve then put my static site on <a href=https://developers.cloudflare.com/pages/ target=_blank>Cloudflare Pages</a>. Because I didn&rsquo;t want to use any overblown framework, I decided to style the site with <a href=https://www.w3schools.com/w3css/default.asp target=_blank>W3.CSS</a> and write my own simple code for the AJAX request. Also not really the best-practice JS code, but it worked for me. I even included a method to make it work in Internet Explorer 5 and 6 - eventhough I didn&rsquo;t test if that actually works.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#6c7986>/*Retrieve IP-Address using AJAX request*/</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>function</span> getIPinfo() {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>var</span> jsonresult = {};
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>var</span> locationtext = <span style=color:#fc6a5d>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// Create Object for classic AJAX Request
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#fc5fa3>var</span> xhttp; <span style=color:#6c7986>//= new XMLHttpRequest();
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#fc5fa3>if</span> (<span style=color:#d0a8ff>window</span>.XMLHttpRequest) {
</span></span><span style=display:flex><span>        <span style=color:#6c7986>// AJAX for modern browsers
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        xhttp = <span style=color:#fc5fa3>new</span> XMLHttpRequest();
</span></span><span style=display:flex><span>    } <span style=color:#fc5fa3>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#6c7986>// AJAX for IE6, IE5
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        xhttp = <span style=color:#fc5fa3>new</span> ActiveXObject(<span style=color:#fc6a5d>&#34;Microsoft.XMLHTTP&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    xhttp.onreadystatechange = <span style=color:#fc5fa3>function</span> () {
</span></span><span style=display:flex><span>        <span style=color:#6c7986>// request is technically OK, if the request is &#34;done&#34; (readyState == 4) and the HTTP Response Code is &#34;OK&#34; (status == 200)
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#fc5fa3>if</span> (<span style=color:#fc5fa3>this</span>.readyState == <span style=color:#d0bf69>4</span> &amp;&amp; <span style=color:#fc5fa3>this</span>.status == <span style=color:#d0bf69>200</span>) {
</span></span><span style=display:flex><span>            <span style=color:#6c7986>// trying to parse the result as json
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>                jsonresult = JSON.parse(<span style=color:#fc5fa3>this</span>.responseText);
</span></span><span style=display:flex><span>            } <span style=color:#fc5fa3>catch</span> (e) {
</span></span><span style=display:flex><span>                <span style=color:#6c7986>// use this placeholder data if parsing was not possible in try{} script block above
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                jsonresult = JSON.parse(<span style=color:#fc6a5d>&#39;{&#34;ip&#34;:&#34;ERROR&#34;,&#34;country&#34;:&#34;XX&#34;}&#39;</span>);
</span></span><span style=display:flex><span>                console.log(<span style=color:#fc6a5d>&#34;Error while trying to parse JSON response&#34;</span>);
</span></span><span style=display:flex><span>                console.log(e);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#6c7986>// output JSON in console log
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            console.log(jsonresult);
</span></span><span style=display:flex><span>            <span style=color:#6c7986>// trying to fill in IP address field on site
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#d0a8ff>document</span>.getElementById(<span style=color:#fc6a5d>&#34;ipaddress&#34;</span>).value = jsonresult.ip;
</span></span><span style=display:flex><span>            } <span style=color:#fc5fa3>catch</span> (e) {
</span></span><span style=display:flex><span>                console.log(<span style=color:#fc6a5d>&#34;Error while trying to fill in IP address&#34;</span>);
</span></span><span style=display:flex><span>                console.log(e);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6c7986>// gather country info in variable &#34;locationtext&#34;, if country set and not &#34;XX&#34; (Cloudflare placeholder for &#34;unknown&#34;)
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#fc5fa3>if</span> (jsonresult.country &amp;&amp; jsonresult.country != <span style=color:#fc6a5d>&#34;XX&#34;</span>) {
</span></span><span style=display:flex><span>                locationtext = jsonresult.country;
</span></span><span style=display:flex><span>            } <span style=color:#fc5fa3>else</span> {
</span></span><span style=display:flex><span>                locationtext = <span style=color:#fc6a5d>&#34;Unknown&#34;</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6c7986>// gather city info in variable &#34;locationtext&#34;, if city is set
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#fc5fa3>if</span> (jsonresult.city) {
</span></span><span style=display:flex><span>                locationtext = jsonresult.city + <span style=color:#fc6a5d>&#34;, &#34;</span> + locationtext;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6c7986>// trying to set location text on site
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>            <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#d0a8ff>document</span>.getElementById(<span style=color:#fc6a5d>&#34;location&#34;</span>).innerText = locationtext;
</span></span><span style=display:flex><span>            } <span style=color:#fc5fa3>catch</span> (e) {
</span></span><span style=display:flex><span>                console.log(<span style=color:#fc6a5d>&#34;Error while trying to fill in IP address&#34;</span>);
</span></span><span style=display:flex><span>                console.log(e);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    xhttp.open(<span style=color:#fc6a5d>&#34;GET&#34;</span>, <span style=color:#fc6a5d>&#34;https://ip.di1.workers.dev/ip&#34;</span>, <span style=color:#fc5fa3>true</span>);
</span></span><span style=display:flex><span>    xhttp.send();
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>I then started out to write a function to copy the IP-Address to the user&rsquo;s clipboard. There is a legacy way to do it, using <code>document.execCommand("copy");</code> and a modern way via the Clipboard API <code>navigator.clipboard.writeText();</code>. I decided to implement both, with the modern approach first and the old method as a fallback.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#fc5fa3>function</span> copy2Clipboard(whichElement) {
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// copy the textvalue from the specified element into the clipboard
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>// using the modern clipboard API
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#fc5fa3>var</span> copyText = <span style=color:#d0a8ff>document</span>.getElementById(whichElement);
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>        navigator.clipboard.writeText(copyText.value).then(
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>function</span> () {
</span></span><span style=display:flex><span>                console.log(<span style=color:#fc6a5d>&#34;success&#34;</span>);
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>function</span> () {
</span></span><span style=display:flex><span>                console.log(<span style=color:#fc6a5d>&#34;fail&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    } <span style=color:#fc5fa3>catch</span> (e) {
</span></span><span style=display:flex><span>        console.log(e);
</span></span><span style=display:flex><span>        copy2ClipboardLegacy(whichElement);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>function</span> copy2ClipboardLegacy(whichElement) {
</span></span><span style=display:flex><span>    <span style=color:#6c7986>// copy the textvalue from the specified element into the clipboard
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>// using the legacy exec-copy command method
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#6c7986>// this is used as a fallback, if copy2Clipboard fails.
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>    <span style=color:#fc5fa3>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>var</span> copyText = <span style=color:#d0a8ff>document</span>.getElementById(whichElement);
</span></span><span style=display:flex><span>        copyText.select();
</span></span><span style=display:flex><span>        copyText.setSelectionRange(<span style=color:#d0bf69>0</span>, <span style=color:#d0bf69>999</span>);
</span></span><span style=display:flex><span>        <span style=color:#d0a8ff>document</span>.execCommand(<span style=color:#fc6a5d>&#34;copy&#34;</span>);
</span></span><span style=display:flex><span>    } <span style=color:#fc5fa3>catch</span> (e) {
</span></span><span style=display:flex><span>        console.log(<span style=color:#fc6a5d>&#34;legacy copy to clipboard failed&#34;</span>);
</span></span><span style=display:flex><span>        console.log(e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Now I&rsquo;m basically done, so let&rsquo;s change the architecture again üôÑ.</p><h2 id=noscript-first---cloudflare-workers-sites>NoScript first - Cloudflare Workers Sites<a hidden class=anchor aria-hidden=true href=#noscript-first---cloudflare-workers-sites>#</a></h2><p>I then realized, that I didn&rsquo;t like my current approach for two reasons:</p><ol><li>The website requires clientside JavaScript to work. I&rsquo;m using <a href=https://noscript.net/ target=_blank>NoScript</a> (or <a href=https://github.com/andryou/scriptsafe target=_blank>ScriptSafe</a>) myself and I don&rsquo;t really like websites that require JS to work properly.</li><li>To display the IP-Address on the site, the user would initiate another unnecessary GET-request. I can deliver a quicker result when serving all information in one request.</li></ol><p>So I dug deeper and found <a href=https://developers.cloudflare.com/workers/platform/sites target=_blank>Cloudflare Workers Sites</a>. Essentially it combines the capabilities of Cloudflare Pages - to deliver static sites through a global CDN - and Cloudflare Workers. The static portions like .html and .css files are saved in Cloudflare KV and get distributed globally. I&rsquo;m then using <a href=https://developers.cloudflare.com/workers/runtime-apis/html-rewriter target=_blank>HTMLRewriter</a> to just inject the IP-Address and location info into my static HTML page before delivering it to the user.</p><p>The rewriting only happens for index.html and sets the value of the HTML-elements with the ids &ldquo;ipaddress&rdquo; and &ldquo;location&rdquo; accordingly.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#6c7986>// if the main page / or /index is requested, we apply a HTMLRewriter to inject the IP-Address and location info
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span><span style=color:#fc5fa3>if</span> (pathname == <span style=color:#fc6a5d>&#34;/&#34;</span> || pathname == <span style=color:#fc6a5d>&#34;/index.html&#34;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>let</span> ipInfo = getClientIPInfo(request);
</span></span><span style=display:flex><span>    <span style=color:#fc5fa3>return</span> <span style=color:#fc5fa3>new</span> HTMLRewriter()
</span></span><span style=display:flex><span>        .on(<span style=color:#fc6a5d>&#34;input&#34;</span>, <span style=color:#fc5fa3>new</span> ElementHandler(ipInfo))
</span></span><span style=display:flex><span>        .transform(response);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986>// [...]
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>
</span></span><span style=display:flex><span><span style=color:#6c7986>/*handles elements to inject values using HTMLRewriter*/</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>class</span> ElementHandler {
</span></span><span style=display:flex><span>    constructor(ipInfo) {
</span></span><span style=display:flex><span>        <span style=color:#fc5fa3>this</span>.ipInfo = ipInfo;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    element(element) {
</span></span><span style=display:flex><span>        <span style=color:#6c7986>// get element id
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#fc5fa3>const</span> elementid = element.getAttribute(<span style=color:#fc6a5d>&#34;id&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6c7986>// depending on which element-id we have, put ipaddress or location in
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>        <span style=color:#fc5fa3>switch</span> (elementid) {
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>case</span> <span style=color:#fc6a5d>&#34;ipaddress&#34;</span>:
</span></span><span style=display:flex><span>                <span style=color:#6c7986>// set value of ipaddress-field in HTML
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                element.setAttribute(<span style=color:#fc6a5d>&#34;value&#34;</span>, <span style=color:#fc5fa3>this</span>.ipInfo.ipaddress);
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#fc5fa3>case</span> <span style=color:#fc6a5d>&#34;location&#34;</span>:
</span></span><span style=display:flex><span>                <span style=color:#6c7986>// set value of location-field in HTML
</span></span></span><span style=display:flex><span><span style=color:#6c7986></span>                element.setAttribute(<span style=color:#fc6a5d>&#34;value&#34;</span>, <span style=color:#fc5fa3>this</span>.ipInfo.location);
</span></span><span style=display:flex><span>                <span style=color:#fc5fa3>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Well, the <a href=https://simpleip.de target=_blank>site</a> is up and running. The source code is <a href=https://github.com/diecknet/simple-ip-site target=_blank>available on Github</a>, feel free to check the whole thing out. I&rsquo;m 100% sure: It would&rsquo;ve been way easier to just use a classic shared webspace and some PHP code. But this whole process was not just about the result. It was also really interesting to check out Serverless applications and different providers. I do prefer the Cloudflare approach, because the Serverless Workers are executed globally, not only in the US like with Vercel.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://diecknet.de/en/tags/simpleip/>Simpleip</a></li><li><a href=https://diecknet.de/en/tags/serverless/>Serverless</a></li><li><a href=https://diecknet.de/en/tags/cloud/>Cloud</a></li><li><a href=https://diecknet.de/en/tags/vercel/>Vercel</a></li><li><a href=https://diecknet.de/en/tags/cloudflare/>Cloudflare</a></li><li><a href=https://diecknet.de/en/tags/cloudflareworkers/>Cloudflareworkers</a></li><li><a href=https://diecknet.de/en/tags/ipaddress/>Ipaddress</a></li></ul><div class=share-buttons></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://diecknet.de/en/>diecknet</a></span>
&nbsp;|&nbsp;
<span><a href=https://diecknet.de/en/legal/>Imprint</a>
</span>&nbsp;|&nbsp;<span>
<a href=https://diecknet.de/en/privacy/>Privacy</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript>var _paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="//nc.diecknet.de/mt/",_paq.push(["setTrackerUrl",t+"mdata"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.defer=!0,e.src=t+"m.js",s.parentNode.insertBefore(e,s)}()</script><noscript><p><img src="https://nc.diecknet.de/mt/mdata?idsite=1&amp;rec=1" style=border:0 alt></p></noscript></body></html>