<!doctype html><html lang=de dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Entra Connect: Soft Match und Hard Match | diecknet</title>
<meta name=keywords content="microsoft entra,active directory,entra connect"><meta name=description content="In diesem Post geht es darum, wie Entra Connect Identit√§ten zusammenf√ºhrt und dann im Betrieb weiter trackt. Bei einigen Punkten k√∂nnte man bestimmt noch weiter in die Tiefe einsteigen, aber das hier sind meiner Meinung nach die wichtigsten Grundlagen.
Alles was ich jetzt hier in dem Post beschreibe bezieht sich in der Regel sowohl auf das klassische Entra Connect Sync, als auch auf das modernere Entra Cloud Sync. Falls doch etwas nur f√ºr das eine oder andere Sync Tool gilt, dann weise ich explizit darauf hin."><meta name=author content="Andreas Dieckmann"><link rel=canonical href=https://diecknet.de/de/2024/12/16/entra-connect-matching/><link crossorigin=anonymous href=/assets/css/stylesheet.75a517428f403193483801122d6350f6956c3bb6bf5c6504311f8c24e6bab3e7.css integrity="sha256-daUXQo9AMZNIOAESLWNQ9pVsO7a/XGUEMR+MJOa6s+c=" rel="preload stylesheet" as=style><link rel=icon href=https://diecknet.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://diecknet.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://diecknet.de/favicon-32x32.png><link rel=apple-touch-icon href=https://diecknet.de/apple-touch-icon.png><link rel=mask-icon href=https://diecknet.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=de href=https://diecknet.de/de/2024/12/16/entra-connect-matching/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Entra Connect: Soft Match und Hard Match"><meta property="og:description" content="In diesem Post geht es darum, wie Entra Connect Identit√§ten zusammenf√ºhrt und dann im Betrieb weiter trackt. Bei einigen Punkten k√∂nnte man bestimmt noch weiter in die Tiefe einsteigen, aber das hier sind meiner Meinung nach die wichtigsten Grundlagen.
Alles was ich jetzt hier in dem Post beschreibe bezieht sich in der Regel sowohl auf das klassische Entra Connect Sync, als auch auf das modernere Entra Cloud Sync. Falls doch etwas nur f√ºr das eine oder andere Sync Tool gilt, dann weise ich explizit darauf hin."><meta property="og:type" content="article"><meta property="og:url" content="https://diecknet.de/de/2024/12/16/entra-connect-matching/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-16T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-16T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Entra Connect: Soft Match und Hard Match"><meta name=twitter:description content="In diesem Post geht es darum, wie Entra Connect Identit√§ten zusammenf√ºhrt und dann im Betrieb weiter trackt. Bei einigen Punkten k√∂nnte man bestimmt noch weiter in die Tiefe einsteigen, aber das hier sind meiner Meinung nach die wichtigsten Grundlagen.
Alles was ich jetzt hier in dem Post beschreibe bezieht sich in der Regel sowohl auf das klassische Entra Connect Sync, als auch auf das modernere Entra Cloud Sync. Falls doch etwas nur f√ºr das eine oder andere Sync Tool gilt, dann weise ich explizit darauf hin."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://diecknet.de/de/posts/"},{"@type":"ListItem","position":2,"name":"Entra Connect: Soft Match und Hard Match","item":"https://diecknet.de/de/2024/12/16/entra-connect-matching/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Entra Connect: Soft Match und Hard Match","name":"Entra Connect: Soft Match und Hard Match","description":"In diesem Post geht es darum, wie Entra Connect Identit√§ten zusammenf√ºhrt und dann im Betrieb weiter trackt. Bei einigen Punkten k√∂nnte man bestimmt noch weiter in die Tiefe einsteigen, aber das hier sind meiner Meinung nach die wichtigsten Grundlagen.\nAlles was ich jetzt hier in dem Post beschreibe bezieht sich in der Regel sowohl auf das klassische Entra Connect Sync, als auch auf das modernere Entra Cloud Sync. Falls doch etwas nur f√ºr das eine oder andere Sync Tool gilt, dann weise ich explizit darauf hin.","keywords":["microsoft entra","active directory","entra connect"],"articleBody":"In diesem Post geht es darum, wie Entra Connect Identit√§ten zusammenf√ºhrt und dann im Betrieb weiter trackt. Bei einigen Punkten k√∂nnte man bestimmt noch weiter in die Tiefe einsteigen, aber das hier sind meiner Meinung nach die wichtigsten Grundlagen.\nAlles was ich jetzt hier in dem Post beschreibe bezieht sich in der Regel sowohl auf das klassische Entra Connect Sync, als auch auf das modernere Entra Cloud Sync. Falls doch etwas nur f√ºr das eine oder andere Sync Tool gilt, dann weise ich explizit darauf hin. Ansonsten werde ich aber der Einfachheit halber im Folgenden einfach Entra Connect schreiben, wenn ich beides meine.\nDieser Post ist vor allem als Begleitpost zum Video auf meinem YouTube Kanal gedacht, um z.B. die Code-Beispiele zu teilen - darf aber nat√ºrlich auch einzeln gelesen werden üòâ\n√úberblick Funktionsweise Wenn Entra Connect ein User Objekt aus dem On-Premises Active Directory verarbeitet, dann wird dabei erstmal geschaut, ob ein Hard Match (deutsch: ‚Äúharte √úbereinstimmung‚Äù) m√∂glich ist. Zur genauen Funktionsweise vom Hard Match kommen wir weiter unten. Ist erstmal nur wichtig: Es kann in einem Entra Objekt gespeichert werden, dass es zu einem bestimmten Objekt aus dem On-Prem AD geh√∂rt. Wenn diese Info gefunden wird, und zwei Objekte zusammenpassen, dann haben wir ein Hard Match.\nFalls aber kein Hard Match m√∂glich ist, wird versucht ein Soft Match (deutsch: ‚Äúweiche √úbereinstimmung‚Äù) durchzuf√ºhren - auch die Funktionsweise des Soft Match erkl√§re ich sp√§ter noch genauer.\nEgal wie gematched wurde: Das vorherige Cloud-Objekt wird nun als ‚Äúsynchronisiert‚Äù markiert und erh√§lt die Eigenschaften vom On-Prem AD Objekt. Die Objekt ID vom Cloud User, User-Daten (Postfach, OneDrive, Teams-Nachrichten etc.) und eventuell bereits vorhandene Berechtigungen und Cloud-Gruppenmitgliedschaften bleiben aber erhalten.\nFalls weder ein Hard Match noch ein Soft Match m√∂glich ist, dann wird das Objekt neu in Entra angelegt. Und es wird auch abgespeichert, dass das neue Entra Objekt und das On-Prem AD Objekt zusammengeh√∂ren, sodass dann zuk√ºnftig ein Hard Match m√∂glich ist.\nSoft Match Wenn ein neues On-Premises Active Directory Objekt von Entra Connect entdeckt wird, wird gepr√ºft ob es ein passendes Objekt in Entra gibt, welches die gleiche E-Mail-Adresse oder den gleichen UserPrincipalName hat. Bei den E-Mail-Adressen wird in der Dokumentation haupts√§chlich auf die AD-User-Eigenschaft ProxyAddresses verwiesen. Aus den ProxyAddresses wird √ºbrigens nur die Haupt-E-Mail-Adresse ausgewertet, also die bei der das Pr√§fix SMTP: gro√ügeschrieben ist.\nDas Bearbeiten des ProxyAddresses Attributs ist offiziell nur supported, wenn es √ºber die Exchange Management Tools gemacht wird - also Exchange Management Shell oder das Exchange Admin Center. Aber das Matching funktioniert auch √ºber das Feld mit dem Attributnamen mail, welches in der Active Directory Benutzer und Computer Konsole auf der ‚ÄúAllgemein‚Äù Seite in den User-Eigenschaften zu finden ist. Diese Eigenschaft darf einfach hier in der Konsole ge√§ndert werden.\n‚ö†Ô∏è Admin Matching Besonderheit: Wenn ein User in Entra beziehungsweise in Microsoft 365 eine Adminrolle hat, dann funktioniert Soft Matching aus Sicherheitsgr√ºnden nicht.\nUnd wenn ein Soft Match stattgefunden hat, dann wird automatisch eine Info abgespeichert, damit zuk√ºnftig ein Hard Match m√∂glich ist.\nüé¨ Soft Match Beispiele Hier mal 3 Beispiele f√ºr Soft Matches:\nUserPrincipalName Ausgangssituation: Es existiert ein Cloud-Only User mit dem UserPrincipalName SoftMatch1@demotenant.de. Entra Connect st√∂√üt auf einen neuen Active Directory User mit dem gleichen UPN SoftMatch1@demotenant.de. Der Cloud User wird umgewandelt zu einem synchronisierten User und erh√§lt die Attribute vom AD User. ProxyAddresses / PrimarySmtpAddress Ausgangssituation: Es existiert ein Cloud-Only User mit dem UserPrincipalName SoftMatch2@demotenant.de und der PrimarySmtpAddress hallo@demotenant.de. Entra Connect st√∂√üt auf einen neuen Active Directory User mit dem UPN beispiel@demotenant.de und der PrimarySmtpAddress hallo@demotenant.de (Also ProxyAddressAttribut enth√§lt unter anderem den Eintrag SMTP:hallo@demotenant.de). Der Cloud User wird umgewandelt zu einem synchronisierten User und erh√§lt die Attribute vom AD User (inklusive des neuen UPN!). Mail Attribut Ausgangssituation: Es existiert ein Cloud-Only User mit dem UserPrincipalName SoftMatch3@demotenant.de und der PrimarySmtpAddress ZZZ@demotenant.de. Entra Connect st√∂√üt auf einen neuen Active Directory User mit dem UPN AAA@demotenant.de und E-Mail-Adresse ZZZ@demotenant.de (Also das mail Attribut hat den Wert SMTP:ZZZ@demotenant.de). Der Cloud User wird umgewandelt zu einem synchronisierten User und erh√§lt die Attribute vom AD User (inklusive des neuen UPN!). Hard Match Zum Speichern der Hard Match Info am Entra Objekt eine sogenannte ‚ÄúImmutable ID‚Äù (deutsch: ‚Äúunver√§nderliche ID‚Äù) verwendet. Das Attribut wird auch als SourceAnchor (deutsch: ‚ÄúQuellanker‚Äù) bezeichnet. Wenn ihr das klassische Entra Connect Sync verwendet, dann k√∂nnt ihr theoretisch bei der initialen Konfiguration einstellen, welches On-Premises Active Directory Attribut als Source Anchor verwendet werden soll. Der Standardwert ist heutzutage das Attribut ‚Äúms-ds-ConsistencyGuid‚Äù - und Abweichungen sind in der Regel auch nicht empfehlenswert.\nJetzt wird‚Äôs ein bisschen kompliziert: Der eigentliche Wert basiert auf der Objekt GUID des On-Premises AD Objekts. Aber es wird nicht einfach nur die GUID genommen, sondern die GUID wird als Byte Array genommen und dann mit Base64 encoded. Wenn ihr das klassische Entra Connect Sync verwendet und es sich um ein User-Objekt handelt, dann wird die Eigenschaft ‚Äúms-ds-ConsistencyGuid‚Äù auch tats√§chlich durch den Sync Vorgang gesetzt (normalerweise nach 2 Sync Zyklen) und als Byte Array gespeichert. Wenn ihr euch die Eigenschaft ansehen wollt, dann hilft die Active Directory Benutzer und Computer Konsole nicht wirklich weiter. Also da k√∂nnt ihr h√∂chstens sehen, dass das Attribut einen Wert hat, aber der eigentliche Wert ist nicht lesbar. Der Wert l√§sst sich aber per PowerShell auslesen und konvertieren.\n1 2 $User = Get-ADUser alexw -Properties mS-DS-ConsistencyGuid [System.Convert]::ToBase64String($User.'mS-DS-ConsistencyGuid') Den Wert k√∂nnen wir dann mit dem vergleichen, den wir in Entra sehen.\nBeim neueren Entra Cloud Sync k√∂nnt ihr den Source Anchor √ºbrigens nicht ausw√§hlen: Da wird immer ‚Äúms-ds-ConsistencyGuid‚Äù verwendet. Allerdings wird der Wert nur berechnet und die Immutable ID entsprechend in Entra gespeichert. Der Wert wird nicht zur√ºckgeschrieben in die tats√§chliche AD Eigenschaft ‚Äúms-ds-consistencyguid‚Äù. Und wenn ihr andere Objekttypen synchronisiert wie z.B. Gruppen, dann wird ‚Äúms-ds-consistencyguid‚Äù auch nicht zur√ºck ins jeweilige AD Objekt geschrieben - hier ist es dann egal mit welcher Entra Connect Variante. Aber in diesen ganzen F√§llen wo die Eigenschaft nicht durch Entra Connect gesetzt wird, wird sie trotzdem ausgewertet. Nur falls sie leer ist, dann wird stattdessen die GUID als Byte-Array verwendet - also der Wert on-the-fly berechnet.\nSource Anchor im AD anpassen Letztendlich k√∂nnen wir beliebig Objekte zusammenf√ºhren, wenn wir die Eigenschaften an den AD oder Entra Objekten richtig bearbeiten. Es gibt dabei aber ein paar Fallstricke: Wenn ein Objekt in Entra bereits eine Immutable-ID hat und es synchronisiert wird, dann k√∂nnen wir die Immutable ID nicht einfach in Entra anpassen. Meine Empfehlung ist deshalb: Falls m√∂glich ist, sollte der Source Anchor im On-Prem AD angepasst werden.\nNehmen wir mal als Beispiel hier meinen bereits synchronisierten Testuser namens Hard Match #1.\nWenn ich m√∂chte, dass hier stattdessen ein anderer/neuer On-Prem AD User namens ‚ÄúHard Match #1 NEU‚Äù als Quelle verwendet werden soll, dann k√∂nnte ich wie folgt vorgehen:\nSchritt 1: Als erstes lege ich mir meinen neuen On-Prem AD User an, falls das noch nicht geschehen ist. Am besten w√§re es, den User in einer Organisationseinheit anzulegen, die nicht per Entra Connect synchronisiert wird. Dadurch k√∂nnen wir verhindern, dass der User schon in M365 angelegt wird.\n‚ö†Ô∏è Falls der neue User ‚ÄúHard Match #1 NEU‚Äù jetzt aber schon synchronisiert sein sollte, w√§re das keine Vollkatastrophe, aber dann m√ºssten wir das erst bereinigen: Erst den User im On-Prem AD aus dem Sync Scope rausnehmen, und wenn der n√§chste Synchronisations Zyklus durch ist, und der User in Entra dadurch automatisch gel√∂scht wurde, dann m√ºssen wir ihn dort auch noch aus ‚ÄúGel√∂schte User‚Äù herausl√∂schen.\nSchritt 2: m√ºssen wir die Immutable ID vom Cloud Objekt herausfinden. Ich habe die mir einfach im Entra Portal, aus den Eigenschaften des Users rauskopiert. Der Name der Eigenschaft lautet ‚ÄúOn-premises immutable ID‚Äù.\nSchritt 3: Die Immutable ID m√ºssen wir zum On-Premises Objekt hinzuf√ºgen - also bei mir hier der ‚ÄúHard Match #1 NEU‚Äù User. Der einzig sinnvolle Weg ist hier per PowerShell mit dem Active Directory Modul. Die Immutable ID aus Entra ist jetzt aber noch als Base64 kodiert, das m√ºssen wir wieder zur√ºckwandeln in ein Byte Array.\n1 2 $ImmutableID = [System.Convert]::FromBase64String(\"6Ao63cWrYUewgqCMI5Fodw==\") Set-ADUser hardmatch1neu -Replace @{\"mS-DS-ConsistencyGuid\" = $ImmutableID} Schritt 4: Jetzt k√∂nnen wir das neue Objekt in den Entra Sync Scope aufnehmen, also in der Regel in eine entsprechende Organisationseinheit verschieben. Falls es noch ein anderes urspr√ºngliches Objekt geben sollte, was dann ja die gleiche Immutable ID h√§tte, dann sollte dieses andere Objekt gel√∂scht werden.\nDiese Vorgehensweise sollte auch funktionieren, wenn ihr eine andere On-Premises Active Directory Dom√§ne als Quelle einsetzen wollt, und da komplett neu erstellte User-Objekte vorhanden sind - auch wenn die gleich hei√üen, die haben dann ja neue Object GUIDs. Um die dann sinnvoll zusammenf√ºhren zu k√∂nnen, nehmt ihr die Immutable IDs von den Cloud Objekten und schreibt die dann im neuen On-Prem AD in die Objekte rein.\nEs w√§re nat√ºrlich auch m√∂glich, die ‚ÄúMS-DS-ConsistencyGUID‚Äù von einem Active Directory Objekt zu kopieren - wahlweise aus dem gleichen AD oder auch aus einem anderen. Trotzdem m√ºsst ihr nat√ºrlich aufpassen, dass nicht gleichzeitig versucht wird 2 Objekte mit dem gleichen Quellanker zu synchronisieren.\nImmutable ID in Entra √§ndern Falls ihr Cloud User habt, die bereits eine Immutable ID aufweisen und ihr die √§ndern oder leeren wollt, dann werdet ihr h√∂chstwahrscheinlich in einen Fehler laufen. Der Trick ist dann den User zu l√∂schen und anschlie√üend wieder herzustellen. Und selbst mit der Methode funktioniert das nur f√ºr User, und nicht f√ºr andere Objekttypen wie z.B. Gruppen. Die haben n√§mlich √ºberhaupt gar keine Immutable ID Eigenschaft in Entra, die wir manipulieren k√∂nnten.\nAls Beispiel habe ich hier den bereits synchronisierten User ‚Äúhardmatch2‚Äù, aber ich m√∂chte stattdessen einen anderen User namens ‚ÄúHard Match 2 NEU‚Äù als Quelle des Objekts verwenden - allerdings wird dieser andere User leider auch schon synchronisiert.\nDie eigentliche √Ñnderung der Immutable ID m√ºssen wir per Graph API machen, im Entra Portal gibt es keine Option daf√ºr. Ich verwende daf√ºr das Microsoft Graph PowerShell Modul, welches ihr per Install-Module Microsoft.Graph (Windows PowerShell) beziehungsweise Install-PSResource Microsoft.Graph (PowerShell 7) installieren k√∂nnt - falls ihr es noch nicht habt. Das k√∂nnt ihr aber √ºbrigens auf einem beliebigen System machen, also das muss kein Dom√§nencontroller und auch nicht der Entra Connect Server sein.\n1 2 3 4 5 6 7 8 9 10 11 12 # Wenn die Installation durch ist, k√∂nnt ihr zun√§chst die Verbindung aufbauen mit: Connect-MgGraph -Scopes User.ReadWrite.All # Anschlie√üend k√∂nnen wir testweise den User abrufen: Get-MgUser -UserId hardmatch2@demotenant.de # Wir speichern uns die Infos zu dem User in einer Variable ab, damit wir gleich einfach darauf zugreifen k√∂nnen: $User = Get-MgUser -UserId hardmatch2@demotenant.de # Das eigentliche Zur√ºcksetzen der Immutable ID: Update-MgUser -UserId $User.Id -OnPremisesImmutableId $null # =\u003e schl√§gt aber vermutlich fehl Um die Immutable ID doch noch √§ndern zu k√∂nnen, m√ºssen wir den User einmal tempor√§r l√∂schen - keine Angst er landet erstmal in einer Art Papierkorb (‚ÄúGel√∂schte Benutzer‚Äù). Da der User ja noch synchronisiert wird, m√ºssen wir ihn an der Quelle - also im On-Prem AD l√∂schen. Anschlie√üend m√ºssen wir die n√§chste Synchronisierung abwarten, bis der User automatisch in Entra gel√∂scht ist. Anschlie√üend k√∂nnen wir den User wiederherstellen, z.B. √ºber das Entra Portal, oder auch per MS Graph PowerShell:\n1 2 3 4 5 Restore-MgDirectoryDeletedItem -DirectoryObjectId $User.Id # Der vorherige Update-MgUser Befehl sollte sich jetzt erfolgreich ausf√ºhren lassen Update-MgUser -UserId $User.Id -OnPremisesImmutableId $null # Falls das immer noch nicht geht, dann probiert mal statt `Update-MgUser` den Request manuell per \"Invoke-GraphRequest\" abzufeuern: Invoke-MgGraphRequest -Method PATCH -Uri \"https://graph.microsoft.com/v1.0/users/$($User.Id)\" -Body @{OnPremisesImmutableId = $null} Ihr k√∂nntet hier auch eine andere Immutable ID eintragen - je nachdem was ihr erreichen wollt. Wenn ihr die Immutable ID komplett rausnehmt, dann k√∂nntet ihr eventuell jetzt wieder ein Soft Match durchf√ºhren. Ich wollte aber mein Hard Match anpassen, sodass zuk√ºnftig der User ‚ÄúHard Match 2 NEU‚Äù als Quelle verwendet wird. In dem Fall brauche ich den bisherigen ‚ÄúHard Match 2 NEU‚Äù User in der Cloud √ºberhaupt nicht mehr. Das einzige was mich noch interessiert ist seine Immutable ID. Die rufe ich mir einmal ab:\n1 2 $UserNEU = Get-MgUser -UserId hardmatch2NEU@demotenant.de -Property Id,OnPremisesImmutableID $UserNEU | Select-Object OnPremisesImmutableId Und anschlie√üend verschiebe ich das Quell-Objekt im On-Prem AD tempor√§r in eine Organisationseinheit, die nicht mit Entra synchronisiert wird. Nachdem die n√§chste Synchronisierung durch ist, sollte das Objekt in Entra gel√∂scht sein. Allerdings ist es noch in Gel√∂schte User zu finden, und so lange es dort noch vorhanden ist, kann ich die Immutable ID nicht wiederverwenden. Das w√ºrde einen Fehler werfen.\n1 2 3 4 5 6 7 8 # Wirft noch einen Fehler: Update-MgUser -UserId $User.Id -OnPremisesImmutableId $UserNEU.OnPremisesImmutableId # L√∂schen des Users aus \"Gel√∂schte Benutzer\": Remove-MgDirectoryDeletedItem -DirectoryObjectId $UserNEU.Id # Jetzt wirklich den alten User updaten: Update-MgUser -UserId $User.Id -OnPremisesImmutableId $UserNEU.OnPremisesImmutableId Nachdem das erledigt ist, kann ich den User ‚ÄúHard Match 2 NEU‚Äù im On-Prem AD wieder in den Sync Scope aufnehmen. Ich verschiebe das Objekt daf√ºr wieder in eine meiner normalen OUs. Dann nochmal die n√§chste Synchronisierung abwarten und anschlie√üend sollte das alte Entra Objekt vom User ‚ÄúHard Match 2‚Äù mit dem On-Prem AD Objekt ‚ÄúHard Match 2 NEU‚Äù verbunden sein - z.B. ist der Name jetzt anders. Bereits vorhandene Berechtigungen und Gruppenmitgliedschaften in der Cloud sowie die Objekt ID entsprechen aber weiterhin dem alten ‚ÄúHard Match 2‚Äù\nMS-DS-ConsistencyGUID manuell berechnen und Zuweisen Das manuelle Berechnen und Zuweisen der ‚ÄúMS-DS-ConsistencyGUID‚Äù Eigenschaft kann unter anderem verwendet werden, um ein bestehendes Cloud Objekt per Hard Match zu √ºbernehmen. Besonders n√ºtzlich, falls die Eigenschaften vom Cloud Objekt und dem AD Objekt soweit voneinander abweichen, dass kein Soft Match m√∂glich w√§re.\nIch habe z.B. einen User namens ‚ÄúManuel Guido‚Äù, welcher aktuell auch noch in einer Organisationseinheit liegt, die nicht mit Entra synchronisiert wird. Die MS-DS-ConsistencyGUID wird ja wie bereits erw√§hnt aus der GUID des AD-Objekts berechnet. Das selbst zu machen geht mit folgendem Code:\n1 2 3 $User = Get-ADUser -Identity 'Manuel.Guido' -Properties ObjectGUID $GuidBytes = $User.ObjectGUID.ToByteArray() Set-ADUser -Identity $User.SamAccountName -Replace @{\"mS-DS-ConsistencyGuid\" = $GuidBytes} Falls ihr diese berechnete ‚ÄúMS-DS-ConsistencyGuid‚Äù bereits vor der Synchronisierung zu einem Entra Objekt hinzuf√ºgen wollt, dann m√ºsst ihr das Byte Array erstmal noch mit Base64 kodieren: $ImmutableID = [System.Convert]::ToBase64String($GuidBytes)\nUnd anschlie√üend k√∂nnt ihr den Wert mit dem Microsoft Graph PowerShell Modul f√ºr einen Entra User setzen - wie das funktioniert, habe ich ja im vorherigen Abschnitt gezeigt.\nTipp: Das manuelle Berechnen der ‚ÄúMS-DS-ConsistencyGuid‚Äù funktioniert auch f√ºr andere Objekttypen, zum Beispiel f√ºr Gruppen. Da gibt es zwar in der Cloud keine sichtbare Immutable ID als Eigenschaft des Gruppenobjekts, aber f√ºr den Sync wird trotzdem die ‚ÄúMS-DS-ConsistencyGUID‚Äù des On-Prem Objekts beachtet - falls sie vorhanden ist. Das kann vor allem helfen, wenn ihr eine Dom√§nenmigration macht. Dann k√∂nnt ihr anhand der GUIDs von Gruppen in der einen Dom√§ne die korrekte ‚ÄúMS-DS-ConsistencyGUID‚Äù berechnen, die ihr dann in der anderen Dom√§ne zuweist. Die grobe Funktionsweise zum Berechnen ist quasi genauso wie f√ºr User-Objekte, nur verwenden wir hier nat√ºrlich PowerShell Cmdlets f√ºr AD Gruppen, statt f√ºr AD User.\n1 2 3 $Group = Get-ADGroup Lager -Properties ObjectGUID $GuidBytes = $Group.ObjectGUID.ToByteArray() Set-ADGroup -Identity $Group.SamAccountName -Replace @{\"mS-DS-ConsistencyGuid\" = $GuidBytes} Immutable ID zu AD GUID konvertieren Wenn ihr in Entra eine Immutable ID gesehen habt, und herausfinden wollt, welches das richtige Quellobjekt im On-Prem AD ist, dann k√∂nnt ihr diese Berechnungen auch umkehren.\n1 2 $ImmutableID = \"tmFOcfhU+U6EHLPbM/yKyA==\" Get-ADObject ([guid][system.convert]::FromBase64String($ImmutableID)) Das funktioniert aber nur richtig, falls diese Immutable ID aus Entra komplett automatisch gesetzt wurde. Wenn schon an den Zuweisungen etwas ge√§ndert wurde, dann w√§re das nur die Info, f√ºr welches urspr√ºngliche Objekt diese Immutable ID generiert wurde. Aber es ist auch m√∂glich direkt nach dem Wert des Attributs ‚ÄúMS-DS-ConsistencyGUID‚Äù im Active Directory zu suchen. Das wiederum funktioniert nur, wenn das Attribut ‚ÄúMS-DS-ConsistencyGUID‚Äù gesetzt ist - also im Standard nur f√ºr User-Objekte und nur mit dem klassischen Microsoft Entra Connect Sync.\nF√ºr die Suche im AD per Immutable ID habe ich eine kleine Funktion gebaut, die auf GitHub zu finden ist. Wenn ihr die importiert habt, dann k√∂nnt ihr z.B. folgendes ausf√ºhren:\n1 Get-ADObjectByImmutableID -ImmutableId \"tmFOcfhU+U6EHLPbM/yKyA==\" Empfohlene Sync Optionen Es wird √ºbrigens von Microsoft empfohlen, dass man zwei bestimmte Standardoptionen f√ºr Entra Connect ab√§ndert, falls sie nicht ben√∂tigt werden. Einmal die Option ‚ÄúBlockCloudObjectTakeoverThroughHardMatchEnabled‚Äù - die bei Aktivierung daf√ºr sorgt, dass keine Objekte per Hard Match √ºbernommen werden k√∂nnen. Bereits bestehende Hard Matches funktionieren aber weiter - nur die √úbernahme von weiteren Objekten durch den Syncvorgang wird verhindert. Und die Option ‚ÄúBlockSoftMatchEnabled‚Äù - die w√ºrde entsprechend daf√ºr sorgen, dass Cloud Only Objekte auch per Soft Match nicht √ºbernommen werden k√∂nnen. Das kann ein bisschen die Sicherheit erh√∂hen, und nat√ºrlich auch verhindern, dass versehentlich Cloud Objekte √ºbernommen werden, wenn ein passendes Objekt im On-Premises AD angelegt wurde.\nAnpassen k√∂nnt ihr die Optionen ebenfalls per Microsoft Graph PowerShell Modul:\n1 2 3 4 5 6 7 Connect-MgGraph -Scopes \"OnPremDirectorySynchronization.ReadWrite.All\" $OnPremSync = Get-MgDirectoryOnPremiseSynchronization $OnPremSync.Features # erstmal gucken wie es jetzt konfiguriert ist $OnPremSync.Features.BlockCloudObjectTakeoverThroughHardMatchEnabled = $true $OnPremSync.Features.BlockSoftMatchEnabled = $true Update-MgDirectoryOnPremiseSynchronization -OnPremisesDirectorySynchronizationId $OnPremSync.Id -Features $OnPremSync.Features Falls ihr also die verschiedenen Punkte zu Soft Match und Hard Match in diesem Post ausprobiert und sie nicht funktionieren, dann pr√ºft einmal, ob die Block Option eventuell aktiviert ist. Falls ja, m√ºsst ihr die jeweilige Option zumindest tempor√§r deaktivieren, damit Soft Match oder die √úbernahme von Objekten per Hard Match funktionieren kann.\nWeiterf√ºhrende Links Mein YouTube Video zu dem Thema: https://youtu.be/yxIHnydUytE Microsoft Entra Connect: When you have an existing tenant: https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-install-existing-tenant Sander Berkouwer: Explained: User Hard Matching and Soft Matching in Azure AD Connect: https://dirteam.com/sander/2020/03/27/explained-user-hard-matching-and-soft-matching-in-azure-ad-connect/ MSXFAQ / Frank Carius: ADSync User Matching: https://www.msxfaq.de/cloud/identity/adsync_matching.htm Understanding errors during Microsoft Entra synchronization: https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/tshoot-connect-sync-errors MSXFAQ / Frank Carius: Source Anchor: https://www.msxfaq.de/cloud/identity/sourceanchor.htm MSXFAQ / Frank Carius: Source Anchor User: https://www.msxfaq.de/cloud/identity/sourceanchor_user.htm MSXFAQ / Frank Carius: Source Anchor Gruppen: https://www.msxfaq.de/cloud/identity/sourceanchor_gruppen.htm ","wordCount":"2892","inLanguage":"de","datePublished":"2024-12-16T00:00:00Z","dateModified":"2024-12-16T00:00:00Z","author":{"@type":"Person","name":"Andreas Dieckmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diecknet.de/de/2024/12/16/entra-connect-matching/"},"publisher":{"@type":"Organization","name":"diecknet","logo":{"@type":"ImageObject","url":"https://diecknet.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diecknet.de/de/ accesskey=h title="diecknet (Alt + H)">diecknet</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://diecknet.de/de/ title=Deutsch aria-label=Deutsch><b>Deutsch</b></a></li><li><a href=https://diecknet.de/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://diecknet.de/de/ title=Home><span>Home</span></a></li><li><a href=https://diecknet.de/de/services/ title=Services><span>Services</span></a></li><li><a href=https://diecknet.de/de/about/ title=About><span>About</span></a></li><li><a href=https://diecknet.de/de/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://diecknet.de/de/archive/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://diecknet.de/de/>Home</a>&nbsp;¬ª&nbsp;<a href=https://diecknet.de/de/posts/>Posts</a></div><h1 class=post-title>Entra Connect: Soft Match und Hard Match</h1><div class=post-meta><span title='2024-12-16 00:00:00 +0000 UTC'>2024-12-16</span>&nbsp;¬∑&nbsp;14 Minuten&nbsp;¬∑&nbsp;Andreas Dieckmann&nbsp;|&nbsp;<a href=https://github.com/diecknet/diecknet-blog/tree/main/content/de/posts/2024/2024-12-16-Entra-Connect-Matching.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Inhaltsverzeichnis</span></summary><div class=inner><ul><li><a href=#%c3%bcberblick-funktionsweise aria-label="√úberblick Funktionsweise">√úberblick Funktionsweise</a></li><li><a href=#soft-match aria-label="Soft Match">Soft Match</a><ul><li><a href=#-soft-match-beispiele aria-label="üé¨ Soft Match Beispiele">üé¨ Soft Match Beispiele</a><ul><li><a href=#userprincipalname aria-label=UserPrincipalName>UserPrincipalName</a></li><li><a href=#proxyaddresses--primarysmtpaddress aria-label="ProxyAddresses / PrimarySmtpAddress">ProxyAddresses / PrimarySmtpAddress</a></li><li><a href=#mail-attribut aria-label="Mail Attribut">Mail Attribut</a></li></ul></li></ul></li><li><a href=#hard-match aria-label="Hard Match">Hard Match</a><ul><li><a href=#source-anchor-im-ad-anpassen aria-label="Source Anchor im AD anpassen">Source Anchor im AD anpassen</a></li><li><a href=#immutable-id-in-entra-%c3%a4ndern aria-label="Immutable ID in Entra √§ndern">Immutable ID in Entra √§ndern</a></li><li><a href=#ms-ds-consistencyguid-manuell-berechnen-und-zuweisen aria-label="MS-DS-ConsistencyGUID manuell berechnen und Zuweisen">MS-DS-ConsistencyGUID manuell berechnen und Zuweisen</a></li><li><a href=#immutable-id-zu-ad-guid-konvertieren aria-label="Immutable ID zu AD GUID konvertieren">Immutable ID zu AD GUID konvertieren</a></li></ul></li><li><a href=#empfohlene-sync-optionen aria-label="Empfohlene Sync Optionen">Empfohlene Sync Optionen</a></li><li><a href=#weiterf%c3%bchrende-links aria-label="Weiterf√ºhrende Links">Weiterf√ºhrende Links</a></li></ul></div></details></div><div class=post-content><p>In diesem Post geht es darum, wie Entra Connect Identit√§ten zusammenf√ºhrt und dann im Betrieb weiter trackt. Bei einigen Punkten k√∂nnte man bestimmt noch weiter in die Tiefe einsteigen, aber das hier sind meiner Meinung nach die wichtigsten Grundlagen.</p><p>Alles was ich jetzt hier in dem Post beschreibe bezieht sich in der Regel sowohl auf das klassische Entra Connect Sync, als auch auf das modernere Entra Cloud Sync. Falls doch etwas nur f√ºr das eine oder andere Sync Tool gilt, dann weise ich explizit darauf hin. Ansonsten werde ich aber der Einfachheit halber im Folgenden einfach Entra Connect schreiben, wenn ich beides meine.</p><p>Dieser Post ist vor allem als Begleitpost zum <a href=https://youtu.be/yxIHnydUytE target=_blank>Video auf meinem YouTube Kanal</a> gedacht, um z.B. die Code-Beispiele zu teilen - darf aber nat√ºrlich auch einzeln gelesen werden üòâ</p><h2 id=√ºberblick-funktionsweise>√úberblick Funktionsweise<a hidden class=anchor aria-hidden=true href=#√ºberblick-funktionsweise>#</a></h2><p>Wenn Entra Connect ein User Objekt aus dem On-Premises Active Directory verarbeitet, dann wird dabei erstmal geschaut, ob ein Hard Match (deutsch: &ldquo;harte √úbereinstimmung&rdquo;) m√∂glich ist. Zur genauen Funktionsweise vom Hard Match kommen wir weiter unten. Ist erstmal nur wichtig: Es kann in einem Entra Objekt gespeichert werden, dass es zu einem bestimmten Objekt aus dem On-Prem AD geh√∂rt. Wenn diese Info gefunden wird, und zwei Objekte zusammenpassen, dann haben wir ein Hard Match.</p><p>Falls aber kein Hard Match m√∂glich ist, wird versucht ein Soft Match (deutsch: &ldquo;weiche √úbereinstimmung&rdquo;) durchzuf√ºhren - auch die Funktionsweise des Soft Match erkl√§re ich sp√§ter noch genauer.</p><p>Egal wie gematched wurde: Das vorherige Cloud-Objekt wird nun als &ldquo;synchronisiert&rdquo; markiert und erh√§lt die Eigenschaften vom On-Prem AD Objekt. Die Objekt ID vom Cloud User, User-Daten (Postfach, OneDrive, Teams-Nachrichten etc.) und eventuell bereits vorhandene Berechtigungen und Cloud-Gruppenmitgliedschaften bleiben aber erhalten.</p><p>Falls weder ein Hard Match noch ein Soft Match m√∂glich ist, dann wird das Objekt neu in Entra angelegt. Und es wird auch abgespeichert, dass das neue Entra Objekt und das On-Prem AD Objekt zusammengeh√∂ren, sodass dann zuk√ºnftig ein Hard Match m√∂glich ist.</p><h2 id=soft-match>Soft Match<a hidden class=anchor aria-hidden=true href=#soft-match>#</a></h2><p>Wenn ein neues On-Premises Active Directory Objekt von Entra Connect entdeckt wird, wird gepr√ºft ob es ein passendes Objekt in Entra gibt, welches die gleiche <strong>E-Mail-Adresse</strong> oder den gleichen <strong>UserPrincipalName</strong> hat. Bei den E-Mail-Adressen wird in der Dokumentation haupts√§chlich auf die AD-User-Eigenschaft <strong>ProxyAddresses</strong> verwiesen. Aus den ProxyAddresses wird √ºbrigens nur die Haupt-E-Mail-Adresse ausgewertet, also die bei der das Pr√§fix <code>SMTP:</code> gro√ügeschrieben ist.</p><p><a href=/images/2024/2024-12-16_AD-User-ProxyAddresses.jpg><img loading=lazy src=/images/2024/2024-12-16_AD-User-ProxyAddresses.jpg alt="Active Directory ProxyAddresses eines Users" title="Active Directory ProxyAddresses eines Users"></a></p><p>Das Bearbeiten des ProxyAddresses Attributs ist offiziell nur supported, wenn es √ºber die Exchange Management Tools gemacht wird - also Exchange Management Shell oder das Exchange Admin Center. Aber das Matching funktioniert auch √ºber das Feld mit dem Attributnamen <strong>mail</strong>, welches in der Active Directory Benutzer und Computer Konsole auf der &ldquo;Allgemein&rdquo; Seite in den User-Eigenschaften zu finden ist. Diese Eigenschaft darf einfach hier in der Konsole ge√§ndert werden.</p><p><a href=/images/2024/2024-12-16_AD-User-Mail-Attribute.jpg><img loading=lazy src=/images/2024/2024-12-16_AD-User-Mail-Attribute.jpg alt="Active Directory Mail Attribut eines Users" title="Active Directory Mail Attribut eines Users"></a></p><p>‚ö†Ô∏è <strong>Admin Matching Besonderheit:</strong> Wenn ein User in Entra beziehungsweise in Microsoft 365 eine Adminrolle hat, dann funktioniert Soft Matching aus Sicherheitsgr√ºnden nicht.</p><p>Und wenn ein Soft Match stattgefunden hat, dann wird automatisch eine Info abgespeichert, damit zuk√ºnftig ein Hard Match m√∂glich ist.</p><h3 id=-soft-match-beispiele>üé¨ Soft Match Beispiele<a hidden class=anchor aria-hidden=true href=#-soft-match-beispiele>#</a></h3><p>Hier mal 3 Beispiele f√ºr Soft Matches:</p><h4 id=userprincipalname>UserPrincipalName<a hidden class=anchor aria-hidden=true href=#userprincipalname>#</a></h4><ol><li>Ausgangssituation: Es existiert ein Cloud-Only User mit dem UserPrincipalName <code>SoftMatch1@demotenant.de</code>.</li><li>Entra Connect st√∂√üt auf einen neuen Active Directory User mit dem gleichen UPN <code>SoftMatch1@demotenant.de</code>.</li><li>Der Cloud User wird umgewandelt zu einem synchronisierten User und erh√§lt die Attribute vom AD User.</li></ol><h4 id=proxyaddresses--primarysmtpaddress>ProxyAddresses / PrimarySmtpAddress<a hidden class=anchor aria-hidden=true href=#proxyaddresses--primarysmtpaddress>#</a></h4><ol><li>Ausgangssituation: Es existiert ein Cloud-Only User mit dem UserPrincipalName <code>SoftMatch2@demotenant.de</code> und der PrimarySmtpAddress <code>hallo@demotenant.de</code>.</li><li>Entra Connect st√∂√üt auf einen neuen Active Directory User mit dem UPN <code>beispiel@demotenant.de</code> und der PrimarySmtpAddress <code>hallo@demotenant.de</code> (Also ProxyAddressAttribut enth√§lt unter anderem den Eintrag <code>SMTP:hallo@demotenant.de</code>).</li><li>Der Cloud User wird umgewandelt zu einem synchronisierten User und erh√§lt die Attribute vom AD User (inklusive des neuen UPN!).</li></ol><h4 id=mail-attribut>Mail Attribut<a hidden class=anchor aria-hidden=true href=#mail-attribut>#</a></h4><ol><li>Ausgangssituation: Es existiert ein Cloud-Only User mit dem UserPrincipalName <code>SoftMatch3@demotenant.de</code> und der PrimarySmtpAddress <code>ZZZ@demotenant.de</code>.</li><li>Entra Connect st√∂√üt auf einen neuen Active Directory User mit dem UPN <code>AAA@demotenant.de</code> und E-Mail-Adresse <code>ZZZ@demotenant.de</code> (Also das mail Attribut hat den Wert <code>SMTP:ZZZ@demotenant.de</code>).</li><li>Der Cloud User wird umgewandelt zu einem synchronisierten User und erh√§lt die Attribute vom AD User (inklusive des neuen UPN!).</li></ol><h2 id=hard-match>Hard Match<a hidden class=anchor aria-hidden=true href=#hard-match>#</a></h2><p>Zum Speichern der Hard Match Info am Entra Objekt eine sogenannte &ldquo;Immutable ID&rdquo; (deutsch: &ldquo;unver√§nderliche ID&rdquo;) verwendet. Das Attribut wird auch als SourceAnchor (deutsch: &ldquo;Quellanker&rdquo;) bezeichnet.
Wenn ihr das klassische Entra Connect Sync verwendet, dann k√∂nnt ihr theoretisch bei der initialen Konfiguration einstellen, welches On-Premises Active Directory Attribut als Source Anchor verwendet werden soll. Der Standardwert ist heutzutage das Attribut &ldquo;ms-ds-ConsistencyGuid&rdquo; - und Abweichungen sind in der Regel auch nicht empfehlenswert.</p><p><a href=/images/2024/2024-12-16-Entra-Connect-Source-Anchor.jpg><img loading=lazy src=/images/2024/2024-12-16-Entra-Connect-Source-Anchor.jpg alt="Konfiguration des Source Anchors in Entra Connect Sync" title="Konfiguration des Source Anchors in Entra Connect Sync"></a></p><p>Jetzt wird&rsquo;s ein bisschen kompliziert: Der eigentliche Wert basiert auf der Objekt GUID des On-Premises AD Objekts. Aber es wird nicht einfach nur die GUID genommen, sondern die GUID wird als Byte Array genommen und dann mit Base64 encoded.
Wenn ihr das klassische Entra Connect Sync verwendet <strong>und es sich um ein User-Objekt handelt</strong>, dann wird die Eigenschaft &ldquo;ms-ds-ConsistencyGuid&rdquo; auch tats√§chlich durch den Sync Vorgang gesetzt (normalerweise nach 2 Sync Zyklen) und als Byte Array gespeichert. Wenn ihr euch die Eigenschaft ansehen wollt, dann hilft die Active Directory Benutzer und Computer Konsole nicht wirklich weiter. Also da k√∂nnt ihr h√∂chstens sehen, dass das Attribut einen Wert hat, aber der eigentliche Wert ist nicht lesbar. Der Wert l√§sst sich aber per PowerShell auslesen und konvertieren.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$User</span> = <span style=color:#d0a8ff>Get-ADUser</span> alexw -Properties <span style=color:#d0a8ff>mS-DS</span>-ConsistencyGuid
</span></span><span style=display:flex><span>[System.Convert]::ToBase64String(<span style=color:#41a1c0>$User</span>.<span style=color:#fc6a5d>&#39;mS-DS-ConsistencyGuid&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><p>Den Wert k√∂nnen wir dann mit dem vergleichen, den wir in Entra sehen.</p><p><a href=/images/2024/2024-12-16_ImmutableID.jpg><img loading=lazy src=/images/2024/2024-12-16_ImmutableID.jpg alt="Immutable ID eines Users in Entra und im Active Directory" title="Immutable ID eines Users in Entra und im Active Directory"></a></p><p>Beim neueren Entra Cloud Sync k√∂nnt ihr den Source Anchor √ºbrigens <strong>nicht</strong> ausw√§hlen: Da wird immer &ldquo;ms-ds-ConsistencyGuid&rdquo; verwendet. Allerdings wird der Wert nur berechnet und die Immutable ID entsprechend in Entra gespeichert. Der Wert wird <strong>nicht</strong> zur√ºckgeschrieben in die tats√§chliche AD Eigenschaft &ldquo;ms-ds-consistencyguid&rdquo;.
Und wenn ihr andere Objekttypen synchronisiert wie z.B. Gruppen, dann wird &ldquo;ms-ds-consistencyguid&rdquo; auch nicht zur√ºck ins jeweilige AD Objekt geschrieben - hier ist es dann egal mit welcher Entra Connect Variante. Aber in diesen ganzen F√§llen wo die Eigenschaft nicht durch Entra Connect gesetzt wird, wird sie trotzdem <em>ausgewertet</em>. Nur falls sie leer ist, dann wird stattdessen die GUID als Byte-Array verwendet - also der Wert on-the-fly berechnet.</p><h3 id=source-anchor-im-ad-anpassen>Source Anchor im AD anpassen<a hidden class=anchor aria-hidden=true href=#source-anchor-im-ad-anpassen>#</a></h3><p>Letztendlich k√∂nnen wir beliebig Objekte zusammenf√ºhren, wenn wir die Eigenschaften an den AD oder Entra Objekten richtig bearbeiten. Es gibt dabei aber ein paar Fallstricke:
Wenn ein Objekt in Entra bereits eine Immutable-ID hat und es synchronisiert wird, dann k√∂nnen wir die Immutable ID nicht <em>einfach</em> in Entra anpassen. Meine Empfehlung ist deshalb: <strong>Falls m√∂glich ist, sollte der Source Anchor im On-Prem AD angepasst werden.</strong></p><p>Nehmen wir mal als Beispiel hier meinen bereits synchronisierten Testuser namens Hard Match #1.</p><p><a href=/images/2024/2024-12-16-Hard-Match-User-1a.jpg><img loading=lazy src=/images/2024/2024-12-16-Hard-Match-User-1a.jpg alt="Beispiel User Hard Match 1" title="Beispiel User Hard Match 1"></a></p><p>Wenn ich m√∂chte, dass hier stattdessen ein anderer/neuer On-Prem AD User namens &ldquo;Hard Match #1 NEU&rdquo; als Quelle verwendet werden soll, dann k√∂nnte ich wie folgt vorgehen:</p><p><strong>Schritt 1:</strong> Als erstes lege ich mir meinen neuen On-Prem AD User an, falls das noch nicht geschehen ist. Am besten w√§re es, den User in einer Organisationseinheit anzulegen, die nicht per Entra Connect synchronisiert wird. Dadurch k√∂nnen wir verhindern, dass der User schon in M365 angelegt wird.</p><p>‚ö†Ô∏è <strong>Falls der neue User &ldquo;Hard Match #1 NEU&rdquo; jetzt aber schon synchronisiert sein sollte</strong>, w√§re das keine Vollkatastrophe, aber dann m√ºssten wir das erst bereinigen: Erst den User im On-Prem AD aus dem Sync Scope rausnehmen, und wenn der n√§chste Synchronisations Zyklus durch ist, und der User in Entra dadurch automatisch gel√∂scht wurde, dann m√ºssen wir ihn dort auch noch aus &ldquo;Gel√∂schte User&rdquo; herausl√∂schen.</p><p><strong>Schritt 2:</strong> m√ºssen wir die Immutable ID vom Cloud Objekt herausfinden. Ich habe die mir einfach <a href=/images/2024/2024-12-16_ImmutableID.jpg>im Entra Portal, aus den Eigenschaften des Users rauskopiert</a>. Der Name der Eigenschaft lautet &ldquo;On-premises immutable ID&rdquo;.</p><p><strong>Schritt 3:</strong> Die Immutable ID m√ºssen wir zum On-Premises Objekt hinzuf√ºgen - also bei mir hier der &ldquo;Hard Match #1 NEU&rdquo; User. Der einzig sinnvolle Weg ist hier per PowerShell mit dem Active Directory Modul. Die Immutable ID aus Entra ist jetzt aber noch als Base64 kodiert, das m√ºssen wir wieder zur√ºckwandeln in ein Byte Array.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$ImmutableID</span> = [System.Convert]::FromBase64String(<span style=color:#fc6a5d>&#34;6Ao63cWrYUewgqCMI5Fodw==&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Set-ADUser</span> hardmatch1neu -Replace @{<span style=color:#fc6a5d>&#34;mS-DS-ConsistencyGuid&#34;</span> = <span style=color:#41a1c0>$ImmutableID</span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>Schritt 4:</strong> Jetzt k√∂nnen wir das <strong>neue Objekt</strong> in den Entra Sync Scope aufnehmen, also in der Regel in eine entsprechende Organisationseinheit verschieben. Falls es noch ein anderes urspr√ºngliches Objekt geben sollte, was dann ja die gleiche Immutable ID h√§tte, dann sollte dieses andere Objekt gel√∂scht werden.</p><p>Diese Vorgehensweise sollte auch funktionieren, wenn ihr eine andere On-Premises Active Directory Dom√§ne als Quelle einsetzen wollt, und da komplett neu erstellte User-Objekte vorhanden sind - auch wenn die gleich hei√üen, die haben dann ja neue Object GUIDs. Um die dann sinnvoll zusammenf√ºhren zu k√∂nnen, nehmt ihr die Immutable IDs von den Cloud Objekten und schreibt die dann im neuen On-Prem AD in die Objekte rein.</p><p>Es w√§re nat√ºrlich auch m√∂glich, die &ldquo;MS-DS-ConsistencyGUID&rdquo; von einem Active Directory Objekt zu kopieren - wahlweise aus dem gleichen AD oder auch aus einem anderen. Trotzdem m√ºsst ihr nat√ºrlich aufpassen, dass nicht gleichzeitig versucht wird 2 Objekte mit dem gleichen Quellanker zu synchronisieren.</p><h3 id=immutable-id-in-entra-√§ndern>Immutable ID in Entra √§ndern<a hidden class=anchor aria-hidden=true href=#immutable-id-in-entra-√§ndern>#</a></h3><p>Falls ihr Cloud User habt, die bereits eine Immutable ID aufweisen und ihr die √§ndern oder leeren wollt, dann werdet ihr h√∂chstwahrscheinlich in einen Fehler laufen. Der Trick ist dann den User zu l√∂schen und anschlie√üend wieder herzustellen. Und selbst mit der Methode funktioniert das nur f√ºr User, und <strong>nicht f√ºr andere Objekttypen wie z.B. Gruppen</strong>. Die haben n√§mlich √ºberhaupt gar keine Immutable ID Eigenschaft in Entra, die wir manipulieren k√∂nnten.</p><p>Als Beispiel habe ich hier den bereits synchronisierten User &ldquo;hardmatch2&rdquo;, aber ich m√∂chte stattdessen einen anderen User namens &ldquo;Hard Match 2 NEU&rdquo; als Quelle des Objekts verwenden - allerdings wird dieser andere User leider auch schon synchronisiert.</p><p><a href=/images/2024/2024-12-16-Hard-Match-User-2.jpg><img loading=lazy src=/images/2024/2024-12-16-Hard-Match-User-2.jpg alt="Beispiel User Hard Match 2" title="Beispiel User Hard Match 2"></a></p><p>Die eigentliche √Ñnderung der Immutable ID m√ºssen wir per Graph API machen, im Entra Portal gibt es keine Option daf√ºr.
Ich verwende daf√ºr das Microsoft Graph PowerShell Modul, welches ihr per <code>Install-Module Microsoft.Graph</code> (Windows PowerShell) beziehungsweise <code>Install-PSResource Microsoft.Graph</code> (PowerShell 7) installieren k√∂nnt - falls ihr es noch nicht habt.
Das k√∂nnt ihr aber √ºbrigens auf einem beliebigen System machen, also das muss kein Dom√§nencontroller und auch nicht der Entra Connect Server sein.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#6c7986># Wenn die Installation durch ist, k√∂nnt ihr zun√§chst die Verbindung aufbauen mit:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Connect-MgGraph</span> -Scopes User.ReadWrite.All
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Anschlie√üend k√∂nnen wir testweise den User abrufen:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Get-MgUser</span> -UserId hardmatch2<span style=color:#41a1c0>@demotenant</span>.de
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Wir speichern uns die Infos zu dem User in einer Variable ab, damit wir gleich einfach darauf zugreifen k√∂nnen:</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$User</span> = <span style=color:#d0a8ff>Get-MgUser</span> -UserId hardmatch2<span style=color:#41a1c0>@demotenant</span>.de
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Das eigentliche Zur√ºcksetzen der Immutable ID:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Update-MgUser</span> -UserId <span style=color:#41a1c0>$User</span>.Id -OnPremisesImmutableId $null
</span></span><span style=display:flex><span><span style=color:#6c7986># =&gt; schl√§gt aber vermutlich fehl</span>
</span></span></code></pre></td></tr></table></div></div><p>Um die Immutable ID doch noch √§ndern zu k√∂nnen, m√ºssen wir den User einmal tempor√§r l√∂schen - keine Angst er landet erstmal in einer Art Papierkorb (&ldquo;Gel√∂schte Benutzer&rdquo;).
Da der User ja noch synchronisiert wird, m√ºssen wir ihn an der Quelle - also im On-Prem AD l√∂schen. Anschlie√üend m√ºssen wir die n√§chste Synchronisierung abwarten, bis der User automatisch in Entra gel√∂scht ist.
Anschlie√üend k√∂nnen wir den User wiederherstellen, z.B. √ºber das Entra Portal, oder auch per MS Graph PowerShell:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Restore-MgDirectoryDeletedItem</span> -DirectoryObjectId <span style=color:#41a1c0>$User</span>.Id
</span></span><span style=display:flex><span><span style=color:#6c7986># Der vorherige Update-MgUser Befehl sollte sich jetzt erfolgreich ausf√ºhren lassen</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Update-MgUser</span> -UserId <span style=color:#41a1c0>$User</span>.Id -OnPremisesImmutableId $null
</span></span><span style=display:flex><span><span style=color:#6c7986># Falls das immer noch nicht geht, dann probiert mal statt `Update-MgUser` den Request manuell per &#34;Invoke-GraphRequest&#34; abzufeuern:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Invoke-MgGraphRequest</span> -Method PATCH -Uri <span style=color:#fc6a5d>&#34;https://graph.microsoft.com/v1.0/users/</span>$(<span style=color:#41a1c0>$User</span>.Id)<span style=color:#fc6a5d>&#34;</span> -Body @{OnPremisesImmutableId = $null}
</span></span></code></pre></td></tr></table></div></div><p>Ihr k√∂nntet hier auch eine andere Immutable ID eintragen - je nachdem was ihr erreichen wollt. Wenn ihr die Immutable ID komplett rausnehmt, dann k√∂nntet ihr <em>eventuell</em> jetzt wieder ein Soft Match durchf√ºhren.
Ich wollte aber mein Hard Match anpassen, sodass zuk√ºnftig der User &ldquo;Hard Match 2 NEU&rdquo; als Quelle verwendet wird.
In dem Fall brauche ich den bisherigen &ldquo;Hard Match 2 NEU&rdquo; User in der Cloud √ºberhaupt nicht mehr. Das einzige was mich noch interessiert ist seine Immutable ID. Die rufe ich mir einmal ab:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$UserNEU</span> = <span style=color:#d0a8ff>Get-MgUser</span> -UserId hardmatch2NEU<span style=color:#41a1c0>@demotenant</span>.de -Property Id,OnPremisesImmutableID
</span></span><span style=display:flex><span><span style=color:#41a1c0>$UserNEU</span> | <span style=color:#d0a8ff>Select-Object</span> OnPremisesImmutableId
</span></span></code></pre></td></tr></table></div></div><p>Und anschlie√üend verschiebe ich das Quell-Objekt im On-Prem AD tempor√§r in eine Organisationseinheit, die nicht mit Entra synchronisiert wird. Nachdem die n√§chste Synchronisierung durch ist, sollte das Objekt in Entra gel√∂scht sein. Allerdings ist es noch in Gel√∂schte User zu finden, und so lange es dort noch vorhanden ist, kann ich die Immutable ID nicht wiederverwenden. Das w√ºrde einen Fehler werfen.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#6c7986># Wirft noch einen Fehler:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Update-MgUser</span> -UserId <span style=color:#41a1c0>$User</span>.Id -OnPremisesImmutableId <span style=color:#41a1c0>$UserNEU</span>.OnPremisesImmutableId
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># L√∂schen des Users aus &#34;Gel√∂schte Benutzer&#34;:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Remove-MgDirectoryDeletedItem</span> -DirectoryObjectId <span style=color:#41a1c0>$UserNEU</span>.Id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Jetzt wirklich den alten User updaten:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Update-MgUser</span> -UserId <span style=color:#41a1c0>$User</span>.Id -OnPremisesImmutableId <span style=color:#41a1c0>$UserNEU</span>.OnPremisesImmutableId
</span></span></code></pre></td></tr></table></div></div><p>Nachdem das erledigt ist, kann ich den User &ldquo;Hard Match 2 NEU&rdquo; im On-Prem AD wieder in den Sync Scope aufnehmen. Ich verschiebe das Objekt daf√ºr wieder in eine meiner normalen OUs.
Dann nochmal die n√§chste Synchronisierung abwarten und anschlie√üend sollte das alte Entra Objekt vom User &ldquo;Hard Match 2&rdquo; mit dem On-Prem AD Objekt &ldquo;Hard Match 2 NEU&rdquo; verbunden sein - z.B. ist der Name jetzt anders. Bereits vorhandene Berechtigungen und Gruppenmitgliedschaften in der Cloud sowie die Objekt ID entsprechen aber weiterhin dem alten &ldquo;Hard Match 2&rdquo;</p><p><a href=/images/2024/2024-12-16-Hard-Match-User-2b.jpg><img loading=lazy src=/images/2024/2024-12-16-Hard-Match-User-2b.jpg alt="Beispiel User Hard Match 2 - nach Zusammenf√ºhrung" title="Beispiel User Hard Match 2  - nach Zusammenf√ºhrung"></a></p><h3 id=ms-ds-consistencyguid-manuell-berechnen-und-zuweisen>MS-DS-ConsistencyGUID manuell berechnen und Zuweisen<a hidden class=anchor aria-hidden=true href=#ms-ds-consistencyguid-manuell-berechnen-und-zuweisen>#</a></h3><p>Das manuelle Berechnen und Zuweisen der &ldquo;MS-DS-ConsistencyGUID&rdquo; Eigenschaft kann unter anderem verwendet werden, um ein bestehendes Cloud Objekt per Hard Match zu √ºbernehmen. Besonders n√ºtzlich, falls die Eigenschaften vom Cloud Objekt und dem AD Objekt soweit voneinander abweichen, dass kein Soft Match m√∂glich w√§re.</p><p>Ich habe z.B. einen User namens &ldquo;Manuel Guido&rdquo;, welcher aktuell auch noch in einer Organisationseinheit liegt, die nicht mit Entra synchronisiert wird. Die MS-DS-ConsistencyGUID wird ja wie bereits erw√§hnt aus der GUID des AD-Objekts berechnet. Das selbst zu machen geht mit folgendem Code:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$User</span> = <span style=color:#d0a8ff>Get-ADUser</span> -Identity <span style=color:#fc6a5d>&#39;Manuel.Guido&#39;</span> -Properties ObjectGUID
</span></span><span style=display:flex><span><span style=color:#41a1c0>$GuidBytes</span> = <span style=color:#41a1c0>$User</span>.ObjectGUID.ToByteArray()
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Set-ADUser</span> -Identity <span style=color:#41a1c0>$User</span>.SamAccountName -Replace @{<span style=color:#fc6a5d>&#34;mS-DS-ConsistencyGuid&#34;</span> = <span style=color:#41a1c0>$GuidBytes</span>}
</span></span></code></pre></td></tr></table></div></div><p>Falls ihr diese berechnete &ldquo;MS-DS-ConsistencyGuid&rdquo; bereits vor der Synchronisierung zu einem Entra Objekt hinzuf√ºgen wollt, dann m√ºsst ihr das Byte Array erstmal noch mit Base64 kodieren:
<code>$ImmutableID = [System.Convert]::ToBase64String($GuidBytes)</code></p><p>Und anschlie√üend k√∂nnt ihr den Wert mit dem Microsoft Graph PowerShell Modul f√ºr einen Entra User setzen - wie das funktioniert, habe ich ja im <a href=#immutable-id-in-entra-%c3%a4ndern>vorherigen Abschnitt</a> gezeigt.</p><p><strong>Tipp:</strong> Das manuelle Berechnen der &ldquo;MS-DS-ConsistencyGuid&rdquo; funktioniert auch f√ºr andere Objekttypen, zum Beispiel f√ºr Gruppen. Da gibt es zwar in der Cloud keine sichtbare Immutable ID als Eigenschaft des Gruppenobjekts, aber f√ºr den Sync wird trotzdem die &ldquo;MS-DS-ConsistencyGUID&rdquo; des On-Prem Objekts beachtet - falls sie vorhanden ist. Das kann vor allem helfen, wenn ihr eine Dom√§nenmigration macht. Dann k√∂nnt ihr anhand der GUIDs von Gruppen in der einen Dom√§ne die korrekte &ldquo;MS-DS-ConsistencyGUID&rdquo; berechnen, die ihr dann in der anderen Dom√§ne zuweist. Die grobe Funktionsweise zum Berechnen ist quasi genauso wie f√ºr User-Objekte, nur verwenden wir hier nat√ºrlich PowerShell Cmdlets f√ºr AD Gruppen, statt f√ºr AD User.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$Group</span> = <span style=color:#d0a8ff>Get-ADGroup</span> Lager -Properties ObjectGUID
</span></span><span style=display:flex><span><span style=color:#41a1c0>$GuidBytes</span> = <span style=color:#41a1c0>$Group</span>.ObjectGUID.ToByteArray()
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Set-ADGroup</span> -Identity <span style=color:#41a1c0>$Group</span>.SamAccountName -Replace @{<span style=color:#fc6a5d>&#34;mS-DS-ConsistencyGuid&#34;</span> = <span style=color:#41a1c0>$GuidBytes</span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=immutable-id-zu-ad-guid-konvertieren>Immutable ID zu AD GUID konvertieren<a hidden class=anchor aria-hidden=true href=#immutable-id-zu-ad-guid-konvertieren>#</a></h3><p>Wenn ihr in Entra eine Immutable ID gesehen habt, und herausfinden wollt, welches das richtige Quellobjekt im On-Prem AD ist, dann k√∂nnt ihr diese Berechnungen auch umkehren.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$ImmutableID</span> = <span style=color:#fc6a5d>&#34;tmFOcfhU+U6EHLPbM/yKyA==&#34;</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Get-ADObject</span> ([guid][system.convert]::FromBase64String(<span style=color:#41a1c0>$ImmutableID</span>))
</span></span></code></pre></td></tr></table></div></div><p>Das funktioniert aber nur richtig, falls diese Immutable ID aus Entra komplett automatisch gesetzt wurde. Wenn schon an den Zuweisungen etwas ge√§ndert wurde, dann w√§re das nur die Info, f√ºr welches urspr√ºngliche Objekt diese Immutable ID generiert wurde. Aber es ist auch m√∂glich direkt nach dem Wert des Attributs &ldquo;MS-DS-ConsistencyGUID&rdquo; im Active Directory zu suchen. Das wiederum funktioniert nur, wenn das Attribut &ldquo;MS-DS-ConsistencyGUID&rdquo; gesetzt ist - also im Standard nur f√ºr User-Objekte und nur mit dem klassischen Microsoft Entra Connect Sync.</p><p>F√ºr die Suche im AD per Immutable ID habe ich eine kleine Funktion gebaut, <a href=https://github.com/diecknet/diecknet-scripts/blob/main/Active%20Directory%20Domain%20Services/Get-ADObjectByImmutableID.ps1 target=_blank>die auf GitHub zu finden ist</a>. Wenn ihr die importiert habt, dann k√∂nnt ihr z.B. folgendes ausf√ºhren:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Get-ADObjectByImmutableID</span> -ImmutableId <span style=color:#fc6a5d>&#34;tmFOcfhU+U6EHLPbM/yKyA==&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><a href=/images/2024/2024-12-16_Get-ADObjectByImmutableID.jpg><img loading=lazy src=/images/2024/2024-12-16_Get-ADObjectByImmutableID.jpg alt="Beispiel f√ºr Get-ADObjectByImmutableID" title="Beispiel f√ºr Get-ADObjectByImmutableID"></a></p><h2 id=empfohlene-sync-optionen>Empfohlene Sync Optionen<a hidden class=anchor aria-hidden=true href=#empfohlene-sync-optionen>#</a></h2><p>Es wird √ºbrigens von Microsoft empfohlen, dass man zwei bestimmte Standardoptionen f√ºr Entra Connect ab√§ndert, falls sie nicht ben√∂tigt werden.
Einmal die Option &ldquo;BlockCloudObjectTakeoverThroughHardMatchEnabled&rdquo; - die bei Aktivierung daf√ºr sorgt, dass keine Objekte per Hard Match √ºbernommen werden k√∂nnen. Bereits bestehende Hard Matches funktionieren aber weiter - nur die √úbernahme von weiteren Objekten durch den Syncvorgang wird verhindert.
Und die Option &ldquo;BlockSoftMatchEnabled&rdquo; - die w√ºrde entsprechend daf√ºr sorgen, dass Cloud Only Objekte auch per Soft Match nicht √ºbernommen werden k√∂nnen.
Das kann ein bisschen die Sicherheit erh√∂hen, und nat√ºrlich auch verhindern, dass versehentlich Cloud Objekte √ºbernommen werden, wenn ein passendes Objekt im On-Premises AD angelegt wurde.</p><p>Anpassen k√∂nnt ihr die Optionen ebenfalls per Microsoft Graph PowerShell Modul:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Connect-MgGraph</span> -Scopes <span style=color:#fc6a5d>&#34;OnPremDirectorySynchronization.ReadWrite.All&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$OnPremSync</span> = <span style=color:#d0a8ff>Get-MgDirectoryOnPremiseSynchronization</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$OnPremSync</span>.Features <span style=color:#6c7986># erstmal gucken wie es jetzt konfiguriert ist</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$OnPremSync</span>.Features.BlockCloudObjectTakeoverThroughHardMatchEnabled = $true
</span></span><span style=display:flex><span><span style=color:#41a1c0>$OnPremSync</span>.Features.BlockSoftMatchEnabled = $true
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Update-MgDirectoryOnPremiseSynchronization</span> -OnPremisesDirectorySynchronizationId <span style=color:#41a1c0>$OnPremSync</span>.Id -Features <span style=color:#41a1c0>$OnPremSync</span>.Features
</span></span></code></pre></td></tr></table></div></div><p>Falls ihr also die verschiedenen Punkte zu Soft Match und Hard Match in diesem Post ausprobiert und sie nicht funktionieren, dann pr√ºft einmal, ob die Block Option eventuell aktiviert ist. Falls ja, m√ºsst ihr die jeweilige Option zumindest tempor√§r deaktivieren, damit Soft Match oder die √úbernahme von Objekten per Hard Match funktionieren kann.</p><h2 id=weiterf√ºhrende-links>Weiterf√ºhrende Links<a hidden class=anchor aria-hidden=true href=#weiterf√ºhrende-links>#</a></h2><ul><li>Mein YouTube Video zu dem Thema: <a href=https://youtu.be/yxIHnydUytE target=_blank>https://youtu.be/yxIHnydUytE</a></li><li>Microsoft Entra Connect: When you have an existing tenant: <a href=https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-install-existing-tenant target=_blank>https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-install-existing-tenant</a></li><li>Sander Berkouwer: Explained: User Hard Matching and Soft Matching in Azure AD Connect: <a href=https://dirteam.com/sander/2020/03/27/explained-user-hard-matching-and-soft-matching-in-azure-ad-connect/ target=_blank>https://dirteam.com/sander/2020/03/27/explained-user-hard-matching-and-soft-matching-in-azure-ad-connect/</a></li><li>MSXFAQ / Frank Carius: ADSync User Matching: <a href=https://www.msxfaq.de/cloud/identity/adsync_matching.htm target=_blank>https://www.msxfaq.de/cloud/identity/adsync_matching.htm</a></li><li>Understanding errors during Microsoft Entra synchronization: <a href=https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/tshoot-connect-sync-errors target=_blank>https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/tshoot-connect-sync-errors</a></li><li>MSXFAQ / Frank Carius: Source Anchor: <a href=https://www.msxfaq.de/cloud/identity/sourceanchor.htm target=_blank>https://www.msxfaq.de/cloud/identity/sourceanchor.htm</a></li><li>MSXFAQ / Frank Carius: Source Anchor User: <a href=https://www.msxfaq.de/cloud/identity/sourceanchor_user.htm target=_blank>https://www.msxfaq.de/cloud/identity/sourceanchor_user.htm</a></li><li>MSXFAQ / Frank Carius: Source Anchor Gruppen: <a href=https://www.msxfaq.de/cloud/identity/sourceanchor_gruppen.htm target=_blank>https://www.msxfaq.de/cloud/identity/sourceanchor_gruppen.htm</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://diecknet.de/de/tags/microsoft-entra/>Microsoft Entra</a></li><li><a href=https://diecknet.de/de/tags/Active-Directory/>Active Directory</a></li><li><a href=https://diecknet.de/de/tags/entra-connect/>Entra Connect</a></li></ul><div class=share-buttons></div></footer><script src=https://giscus.diecknet.de/client.js data-repo=diecknet/diecknet-blog data-repo-id="MDEwOlJlcG9zaXRvcnkyMDkzNDUzNzM=" data-category="Blog Discussions" data-category-id=MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyNjMwOTY0 data-mapping=specific data-term=entra-connect-matching data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://diecknet.de/de/>diecknet</a></span>
&nbsp;|&nbsp;
<span><a href=https://diecknet.de/de/legal/>Impressum</a>
</span>&nbsp;|&nbsp;<span>
<a href=https://diecknet.de/de/privacy/>Datenschutz</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Kopieren";function s(){t.innerHTML="Kopiert!",setTimeout(()=>{t.innerHTML="Kopieren"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript>var _paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="//nc.diecknet.de/mt/",_paq.push(["setTrackerUrl",t+"mdata"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.defer=!0,e.src=t+"m.js",s.parentNode.insertBefore(e,s)}()</script><noscript><p><img src="https://nc.diecknet.de/mt/mdata?idsite=1&amp;rec=1" style=border:0 alt></p></noscript></body></html>