<!doctype html><html lang=de dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>E-Mails per PowerShell und Microsoft Graph verschicken | diecknet</title>
<meta name=keywords content="powershell,microsoft graph,exchange"><meta name=description content="E-Mails via Powershell und Microsoft Graph API zu verschicken, ist leider nicht so einfach wie mit dem klassischen Send-MailMessage Cmdlet. Zu dem klassischen Weg hatte ich ja auch k√ºrzlich einen Blog-Post ver√∂ffentlicht.
Trotzdem gibt es einige Gr√ºnde, die f√ºr den Versand per Microsoft Graph sprechen. Im Oktober 2025 wird voraussichtlich die Plaintext Authentifizierung (&ldquo;Basic Authentifizierung&rdquo;) f√ºr den SMTP-Versand bei Exchange Online abgeschaltet. Falls also Exchange Online euer einziges E-Mail-System ist, aber ihr automatisiert E-Mails verschicken wollt, dann ist MS Graph die richtige Wahl. Alternativ k√∂nntet ihr nat√ºrlich auch ein zus√§tzliches E-Mail-System anschaffen (anmieten oder selbst betreiben)."><meta name=author content="Andreas Dieckmann"><link rel=canonical href=https://diecknet.de/de/2025/04/10/powershell-send-mails-via-ms-graph/><link crossorigin=anonymous href=/assets/css/stylesheet.75a517428f403193483801122d6350f6956c3bb6bf5c6504311f8c24e6bab3e7.css integrity="sha256-daUXQo9AMZNIOAESLWNQ9pVsO7a/XGUEMR+MJOa6s+c=" rel="preload stylesheet" as=style><link rel=icon href=https://diecknet.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://diecknet.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://diecknet.de/favicon-32x32.png><link rel=apple-touch-icon href=https://diecknet.de/apple-touch-icon.png><link rel=mask-icon href=https://diecknet.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=de href=https://diecknet.de/de/2025/04/10/powershell-send-mails-via-ms-graph/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="E-Mails per PowerShell und Microsoft Graph verschicken"><meta property="og:description" content="E-Mails via Powershell und Microsoft Graph API zu verschicken, ist leider nicht so einfach wie mit dem klassischen Send-MailMessage Cmdlet. Zu dem klassischen Weg hatte ich ja auch k√ºrzlich einen Blog-Post ver√∂ffentlicht.
Trotzdem gibt es einige Gr√ºnde, die f√ºr den Versand per Microsoft Graph sprechen. Im Oktober 2025 wird voraussichtlich die Plaintext Authentifizierung (&ldquo;Basic Authentifizierung&rdquo;) f√ºr den SMTP-Versand bei Exchange Online abgeschaltet. Falls also Exchange Online euer einziges E-Mail-System ist, aber ihr automatisiert E-Mails verschicken wollt, dann ist MS Graph die richtige Wahl. Alternativ k√∂nntet ihr nat√ºrlich auch ein zus√§tzliches E-Mail-System anschaffen (anmieten oder selbst betreiben)."><meta property="og:type" content="article"><meta property="og:url" content="https://diecknet.de/de/2025/04/10/powershell-send-mails-via-ms-graph/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-10T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-10T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="E-Mails per PowerShell und Microsoft Graph verschicken"><meta name=twitter:description content="E-Mails via Powershell und Microsoft Graph API zu verschicken, ist leider nicht so einfach wie mit dem klassischen Send-MailMessage Cmdlet. Zu dem klassischen Weg hatte ich ja auch k√ºrzlich einen Blog-Post ver√∂ffentlicht.
Trotzdem gibt es einige Gr√ºnde, die f√ºr den Versand per Microsoft Graph sprechen. Im Oktober 2025 wird voraussichtlich die Plaintext Authentifizierung (&ldquo;Basic Authentifizierung&rdquo;) f√ºr den SMTP-Versand bei Exchange Online abgeschaltet. Falls also Exchange Online euer einziges E-Mail-System ist, aber ihr automatisiert E-Mails verschicken wollt, dann ist MS Graph die richtige Wahl. Alternativ k√∂nntet ihr nat√ºrlich auch ein zus√§tzliches E-Mail-System anschaffen (anmieten oder selbst betreiben)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://diecknet.de/de/posts/"},{"@type":"ListItem","position":2,"name":"E-Mails per PowerShell und Microsoft Graph verschicken","item":"https://diecknet.de/de/2025/04/10/powershell-send-mails-via-ms-graph/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"E-Mails per PowerShell und Microsoft Graph verschicken","name":"E-Mails per PowerShell und Microsoft Graph verschicken","description":"E-Mails via Powershell und Microsoft Graph API zu verschicken, ist leider nicht so einfach wie mit dem klassischen Send-MailMessage Cmdlet. Zu dem klassischen Weg hatte ich ja auch k√ºrzlich einen Blog-Post ver√∂ffentlicht.\nTrotzdem gibt es einige Gr√ºnde, die f√ºr den Versand per Microsoft Graph sprechen. Im Oktober 2025 wird voraussichtlich die Plaintext Authentifizierung (\u0026ldquo;Basic Authentifizierung\u0026rdquo;) f√ºr den SMTP-Versand bei Exchange Online abgeschaltet. Falls also Exchange Online euer einziges E-Mail-System ist, aber ihr automatisiert E-Mails verschicken wollt, dann ist MS Graph die richtige Wahl. Alternativ k√∂nntet ihr nat√ºrlich auch ein zus√§tzliches E-Mail-System anschaffen (anmieten oder selbst betreiben).\n","keywords":["powershell","microsoft graph","exchange"],"articleBody":"E-Mails via Powershell und Microsoft Graph API zu verschicken, ist leider nicht so einfach wie mit dem klassischen Send-MailMessage Cmdlet. Zu dem klassischen Weg hatte ich ja auch k√ºrzlich einen Blog-Post ver√∂ffentlicht.\nTrotzdem gibt es einige Gr√ºnde, die f√ºr den Versand per Microsoft Graph sprechen. Im Oktober 2025 wird voraussichtlich die Plaintext Authentifizierung (‚ÄúBasic Authentifizierung‚Äù) f√ºr den SMTP-Versand bei Exchange Online abgeschaltet. Falls also Exchange Online euer einziges E-Mail-System ist, aber ihr automatisiert E-Mails verschicken wollt, dann ist MS Graph die richtige Wahl. Alternativ k√∂nntet ihr nat√ºrlich auch ein zus√§tzliches E-Mail-System anschaffen (anmieten oder selbst betreiben).\nIch finde es ganz charmant, wenn wir per PowerShell E-Mails verschicken und dabei die Exchange Online Infrastruktur nutzen k√∂nnen (inklusive eventueller Transportregeln, bestehendem DKIM/DMARC/SPF Setup usw.).\nIch habe auch ein Video zum Versand von E-Mails per MS Graph gemacht: https://youtu.be/0kgKD3XsEXU\nDie Herausforderung Komplexer als beim einfachen Send-MailMessage ist beim Versand per Microsoft Graph:\nAuthentifizierung Authentifizierung ‚Äúals App‚Äù m√∂glich per Managed Identity, Zertifikat oder Client Secret in der Regel ohne Einschr√§nkungen durch Conditional Access Policies Eher f√ºr Testzwecke: Authentifizierung auch als User m√∂glich Syntax Das Microsoft Graph PowerShell SDK bietet zwar das Cmdlet Send-MgUserMail, allerdings m√ºssen selbst einfachste Parameter als komische Hashtable angegeben werden, anstatt dass es einfach PowerShell Cmdlet Parameter sind üòì PowerShell Module‚Ä¶ Es w√§re auch m√∂glich komplett ohne Zusatzmodule die Microsoft Graph API in PowerShell zu verwenden. Daf√ºr m√ºssten dann die HTTP Requests selbst konstruiert werden und dann per Invoke-RestMethod gesendet werden. Die Authentifizierung ist dann aber noch mal ein bisschen kniffliger.\nDas PowerShell Graph SDK ist das offizielle Toolkit von Microsoft f√ºr die Verwendung der Microsoft Graph API in der PowerShell. Leider ist es nicht besonders gut. Es ist automatisch aus den API Spezifikationen generiert. Dadurch sind die Cmdlet-Namen teilweise lang und komisch, und die Parameter m√ºssen oftmals komplex per Hashtable/JSON √ºbergeben werden (anstatt das es einfach PowerShell Cmdlet Parameter sind). Es gibt auch Drittanbieter-Module f√ºr die Graph API, die Vorteile wie z.B. eine erh√∂hte Geschwindigkeit haben. Aber daf√ºr ist das PowerShell Graph SDK von Microsoft. Ist also ein First-Party-Modul, dem ich ein h√∂heres Vertrauen entgegenbringen w√ºrde. Man k√∂nnte es auch als den Standard-Weg bezeichnen.\nIch pers√∂nlich habe nicht grunds√§tzlich etwas gegen PowerShell Module, die nicht von Microsoft kommen. Aber f√ºr manche Organisationen ist das wichtig.\n‚Ä¶ f√ºr den E-Mail Versand Am Automatisierungshost ben√∂tigt ihr f√ºr den E-Mail-Versand das Microsoft.Graph.Users.Actions Modul.\n1 2 3 4 5 # Mit PowerShell 7 bzw. mit PSResourceGet Install-PSResource Microsoft.Graph.Users.Actions # Mit Windows PowerShell 5.1 bzw. mit PowerShellGet Install-Module Microsoft.Graph.Users.Actions ‚Ä¶ f√ºr die Einrichtung Diese Module m√ºssen nicht unbedingt auf dem System installiert werden, auf dem dann die Automatisierung (also der E-Mail-Versand) l√§uft. Sie werden nur f√ºr die Einrichtung von Berechtigungen ben√∂tigt und k√∂nnten z.B. auf einer Admin-Workstation installiert werden.\nMicrosoft.Graph.Applications - um der App Registrierung bzw. Managed Identity grunds√§tzlich die Rechte zum E-Mail-Versand zu erteilen ExchangeOnlineManagement - um den Versand von E-Mails auf einzelne Absender zu beschr√§nken 1 2 3 4 5 6 7 # Mit PowerShell 7 bzw. mit PSResourceGet Install-PSResource Microsoft.Graph.Applications Install-PSResource ExchangeOnlineManagement # Mit Windows PowerShell 5.1 bzw. mit PowerShellGet Install-Module Microsoft.Graph.Applications Install-Module ExchangeOnlineManagement Authentifizierung und Berechtigungen Bevor wir E-Mails verschicken k√∂nnen, m√ºssen wir uns authentifizieren.\nF√ºr einfache Tests: Als User F√ºr einfache Testzwecke k√∂nnen wir uns als User authentifizieren und dann im eigenen Namen E-Mails versenden. Falls das PowerShell Skript aber regelm√§√üig unbeaufsichtigt laufen soll, ist das hier nicht daf√ºr geeignet.\n1 Connect-MgGraph -Scopes \"Mail.Send\" Nachdem ihr euch grunds√§tzlich authentifiziert habt, kommt vermutlich noch eine Abfrage ob ihr den Berechtigungen zustimmt. Eventuell sind die Rechte daf√ºr in eurem Tenant eingeschr√§nkt, dann d√ºrft ihr das als normaler User gar nicht best√§tigen.\nFalls ihr euch gerade als Administrator authentifiziert habt, dann gibt es noch die Checkbox zum ‚ÄúZustimmen im Namen der Organisation‚Äù (‚ÄúConsent on behalf of your organization‚Äù). Den Haken solltet ihr normalerweise nicht setzen - falls ihr die Option aktiviert, dann d√ºrften ab jetzt alle User in eurem Tenant das PowerShell Graph SDK verwenden um E-Mails zu verschicken.\nSicher und einfach: Managed Identity Die beste Option f√ºr produktive Zwecke ist meiner Meinung nach per ‚ÄúManaged Identity‚Äù. Dabei werden die Zugangsdaten automatisch durch Microsoft Entra ID verwaltet. Das funktioniert aber nur f√ºr Azure Ressourcen wie z.B. Azure VMs, Azure Automation Accounts oder an Azure angebundene Systeme (per Azure Arc).\nDaf√ºr m√ºsst ihr zun√§chst eurer Azure Ressource eine Managed Identity zuweisen. Das geht oft direkt bei der Erstellung, aber nat√ºrlich auch im Nachhinein.\nDie Managed Identity hat dann einen Service Principal mit Objekt ID und kann dar√ºber Berechtigungen erhalten. Die Zuweisung der Berechtigung zum E-Mail-Versand k√∂nnt ihr mit folgendem PowerShell Code machen. Diese Einrichtung muss nicht am Automatisierungs-Host erfolgen, sondern kann z.B. auf einem Admin-System gemacht werden (siehe auch: PowerShell Module f√ºr die Einrichtung).\nDie Werte f√ºr die Variablen $TenantId und $managedIdentityObjectId solltet ihr nat√ºrlich passend f√ºr eure Umgebung setzen. Bei Bedarf k√∂nntet ihr der App auch noch weitere Graph Berechtigungen zuweisen, daf√ºr das Array $appRoleNames mit weiteren Eintr√§gen bef√ºllen.\n‚ö†Ô∏è Wichtig: Im Standard darf die Managed Identity erstmal von allen Exchange-Absendern aus eurer Umgebung aus versenden. Ihr solltet die Berechtigungen einschr√§nken - wie das geht erkl√§re ich im Abschnitt E-Mail-Versand nur auf bestimmte Absender einschr√§nken.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # The tenant ID $TenantId = \"\" # The name of the app role that the managed identity should be assigned to. $appRoleNames = @(\"Mail.Send\") # Set the managed identity's object ID. $managedIdentityObjectId = \"\" Connect-MgGraph -TenantId $TenantId -Scopes 'Application.Read.All', 'AppRoleAssignment.ReadWrite.All' # Get Microsoft Graph app's service principal and app role. $serverApplicationName = \"Microsoft Graph\" $serverServicePrincipal = (Get-MgServicePrincipal -Filter \"DisplayName eq '$serverApplicationName'\") $serverServicePrincipalObjectId = $serverServicePrincipal.Id # Assign the managed identity access to the app role. foreach ($appRoleName in $appRoleNames) { $currAppRoleId = ($serverServicePrincipal.AppRoles | Where-Object { $_.Value -eq $appRoleName }).Id New-MgServicePrincipalAppRoleAssignment ` -ServicePrincipalId $managedIdentityObjectId ` -PrincipalId $managedIdentityObjectId ` -ResourceId $serverServicePrincipalObjectId ` -AppRoleId $currAppRoleId } Es kann manchmal einige Zeit dauern bis die Berechtigung aktiv wird. Ich hatte es am n√§chsten Morgen dann wieder probiert (10-12h sp√§ter) und dann ging es. Ich w√ºrde aber eigentlich eher mit 1h rechnen.\nDie eigentliche Authentifizierung in eurem PowerShell Skript (welches E-Mails versenden soll) erfolgt ganz einfach so:\n1 Connect-MgGraph -Identity Es m√ºssen also √ºberhaupt keine Zugangsdaten im Code referenziert werden üëç\nApp Registration und Zertifikat oder Client Secret Falls Managed Identities bei euch nicht infrage kommen, dann gibt es auch die M√∂glichkeit eine App Registration in Entra ID anzulegen und dann wahlweise per Zertifikat (besser) oder per Client-Secret (schlechter) zu authentifizieren. Die Anlage erfolgt z.B. im Entra Admin Center unter ‚ÄúApplications‚Äù - ‚ÄúApp Registrations‚Äù per Button ‚ÄúNew registration‚Äù.\n‚ö†Ô∏è Wichtig: Im Standard darf die App/der Service Principal (nach der nachfolgenden Konfiguration) erstmal von allen Exchange-Absendern aus eurer Umgebung aus versenden. Ihr solltet die Berechtigungen einschr√§nken - wie das geht erkl√§re ich im Abschnitt E-Mail-Versand nur auf bestimmte Absender einschr√§nken.\nDer Name der App ist im Grunde frei w√§hlbar. Bei ‚ÄúSupported Account Types‚Äù den Standard ‚ÄúAccounts in this organizational directory only [‚Ä¶]‚Äù beibehalten. Eine Redirect URI m√ºsst ihr nicht eintragen.\nNach der Anlage der App muss sie noch Berechtigungen erhalten. F√ºr die Managed Identity im vorherigen Abschnitt hatten wir ja PowerShell verwendet. Hier mal wie es per GUI gehen w√ºrde:\nUnter ‚ÄúAPI Permissions‚Äù auf ‚ÄúAdd a permission‚Äù klicken.\nBei der Auswahl ‚ÄúSelect an API‚Äù die Option ‚ÄúMicrosoft Graph‚Äù ausw√§hlen.\nBei der Auswahl ‚ÄúWhat type of permissions does your application require?‚Äù die Option ‚ÄúApplication permissions‚Äù w√§hlen.\nBei der Auswahl ‚ÄúSelect permission‚Äù die Berechtigung ‚ÄúMail.Send‚Äù raussuchen und ausw√§hlen.\nDie Standard-Berechtigung ‚ÄúUser.Read‚Äù vom Type ‚ÄúDelegated‚Äù kann √ºbrigens gel√∂scht werden - sie wird f√ºr den E-Mail-Versand nicht ben√∂tigt.\nAnschlie√üend der neuen API Berechtigung im Namen der Organisation zustimmen per ‚ÄúGrant admin consent for TENANTNAME‚Äù und per ‚ÄúYes‚Äù best√§tigen.\nZertifikat Wenn ihr euch per Zertifikat authentifizieren m√∂chtet, dann schaut euch die Dokumentation bei Microsoft an: https://learn.microsoft.com/en-us/entra/identity-platform/howto-create-self-signed-certificate\nClient Secret Wenn ihr euch per Client Secret authentifizieren m√∂chtet, dann m√ºsst ihr zun√§chst ein Secret erstellen. Das geht unter ‚ÄúCertificates \u0026 Secrets‚Äù - dort dann unter ‚ÄúClient secrets‚Äù auf ‚ÄúNew client secret‚Äù klicken.\nTendenziell ist es aus Sicherheitsgr√ºnden empfehlenswert keine allzu lange G√ºltigkeitsdauer auszuw√§hlen. Ich habe deshalb den Standardwert 180 Tage beibehalten.\nDer Secret Value wird euch nur einmalig angezeigt. Ihr solltet ihn also sofort kopieren. Wenn ihr sp√§ter zu der Seite zur√ºck kommt, dann wird er nicht mehr vollst√§ndig angezeigt. Das Secret ist mit einem Passwort gleich zu setzen - sollte also auch nicht in Klartext in Dokumentationen aufgenommen werden und auch nicht im Klartext im PowerShell Code abgelegt werden.\nDas Secret hier im Screenshot ist nat√ºrlich nicht mehr g√ºltig üòâ\nEine M√∂glichkeit das Secret einigerma√üen sicher abzuspeichern w√§re als exportieres PowerShell Credential Objekt. Das kann nur durch den User (am gleichen Computer) entschl√ºsselt werden, der es auch verschl√ºsselt hat. Alternativ ist das PowerShell Modul SecretManagement auch noch ein interessanter Ansatz.\nSo k√∂nnt ihr die Credentials abfragen abspeichern - als Username die Application ID von der Hauptseite der App Registration angeben.\n1 2 $Credential = Get-Credential $Credential | Export-CliXml Credential.xml Und dann sp√§ter in eurem Skript k√∂nnt ihr es so importieren und euch damit bei MS Graph authentifizieren. Bitte auch daran denken die TenantID einzutragen:\n1 2 $Credential = Import-Clixml .\\Credential.xml Connect-MgGraph -ClientSecretCredential $Credential -TenantId \"hier eure TenantID eintragen\" E-Mail-Versand nur auf bestimmte Absender einschr√§nken Wie bereits erw√§hnt darf ein Service Principal/Managed Identity mit der Mail.Send Berechtigung erstmal alle Exchange-Objekte aus eurer Umgebung als Absender verwenden. Ich w√ºrde empfehlen diese Rechte immer einzuschr√§nken, sodass nur durch bestimmte Absender verschickt werden darf.\nDie Konfiguration so einer Einschr√§nkung erfolgt per Exchange Online PowerShell. Das muss nicht am Automatisierungshost gemacht werden, sondern kann auch von einer Admin-VM o.√§. erfolgen (siehe auch: PowerShell Module f√ºr die Einrichtung).\nZu den Parameterwerten f√ºr New-ApplicationAccessPolicy:\n-AppId die Application ID (auch ‚ÄúClient ID‚Äù genannt) von eurer App Registration bzw. eurer Managed Identity* -PolicyGroupScopeId wahlweise ein einzelnes Postfach (auch Shared Mailboxes werden unterst√ºtzt) oder eine Mail-Enabled Security Group, die die Exchange Objekte enth√§lt von denen aus gesendet werden soll -Description die Beschreibung ist frei w√§hlbar -AccessRight der Wert RestrictAccess sorgt daf√ºr, dass die App nur auf die bei -PolicyGroupScopeId genannten Mailboxen zugreifen darf 1 2 3 Connect-ExchangeOnline New-ApplicationAccessPolicy -AppId \"Hier App ID eintragen\" -PolicyScopeGroupId \"hier Gruppe oder Postfach eintragen von dem verschickt werden darf\" -AccessRight RestrictAccess -Description \"Beschreibung ist auch frei w√§hlbar\" *Die Application ID eurer Managed Identity ist √ºbrigens nicht die Object ID. Falls ihr die Application ID herausfinden m√∂chtet, dann schaut im Entra Portal unter ‚ÄúEnterprise Applications‚Äù und √§ndert den Filter ‚ÄúApplication type‚Äù auf ‚ÄúManaged Identities‚Äù.\nBeispiele f√ºr den E-Mail Versand Puh‚Ä¶ Die Authentifizierung und Einschr√§nkung auf bestimmte Absender-Adressen haben wir jetzt also. Hier ein paar Beispiele f√ºr den eigentlichen Versand von E-Mails.\nEs gibt noch zahlreiche weitere Optionen, f√ºr die ihr die $params Hashtable anpassen k√∂nnt. Diese ‚Äúcomplex Parameters‚Äù werden in der Dokumentation zum Cmdlet Send-MgUserMail im Abschnitt ‚ÄúNotes‚Äù aufgef√ºhrt.\nBeispiel 1: Plain-Text E-Mail 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $params = @{ message = @{ subject = \"Test E-Mail per MS Graph\" body = @{ contentType = \"Text\" content = \"Gr√º√üe aus der PowerShell (per Graph)\" } toRecipients = @( @{ emailAddress = @{ address = \"hans.maulwurf@demotenant.de\" } } ) } } Send-MgUserMail -UserId \"diecknet-adm@diecknetdemotenant.onmicrosoft.com\" -BodyParameter $params Beispiel 2: HTML E-Mail 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $params = @{ message = @{ subject = \"Test HTML E-Mail per MS Graph\" body = @{ contentType = \"html\" content = @\" Gr√º√üe aus der PowerShell (per Graph) Kanal abonnieren :)\nDanke! \"@ } toRecipients = @( @{ emailAddress = @{ address = \"hans.maulwurf@demotenant.de\" } } ) } } Send-MgUserMail -UserId \"abteilungspostfach@demotenant.de\" -BodyParameter $params Beispiel 3: Mehrere Empf√§nger Die Syntax f√ºr mehrere Empf√§nger ist ein wenig eigen. Hier mal ein Beispiel f√ºr zwei Empf√§nger:\nDie Eigenschaft toRecipients ist ein Array, welches wiederum zwei Hashtables enth√§lt (eine pro Empf√§nger), die jeweils eine Hashtable enthalten. Cool üòê\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $params = @{ message = @{ subject = \"Test E-Mail an mehrere Leute\" body = @{ contentType = \"html\" content = @\" Gr√º√üe aus der PowerShell (per Graph) Jetzt mal an mehrere Empf√§nger :) \"@ } toRecipients = @( @{ emailAddress = @{ address = \"hans.maulwurf@demotenant.de\" } }, @{ emailAddress = @{ address = \"alexw@demotenant.de\" } } ) } } Send-MgUserMail -UserId \"abteilungspostfach@demotenant.de\" -BodyParameter $params Alternativen Da das Rumhantieren mit den Hashtables etwas umst√§ndlich ist, gibt es einige alternative Module aus der Community.\nZum Beispiel Mailozaurr von Microsoft MVP Przemys≈Çaw K≈Çys finde ich ganz cool. Das Modul stellt das neue Cmdlet Send-EmailMessage bereit (also statt dem Standard Send-MailMessage). Es werden auch noch andere Protokolle und Authentifizierungen unterst√ºtzt (nicht nur MS Graph). Leider werden zurzeit keine Managed Identities unterst√ºtzt, deshalb habe ich es nur einmal kurz zu Testzwecken verwendet.\n","wordCount":"2155","inLanguage":"de","datePublished":"2025-04-10T00:00:00Z","dateModified":"2025-04-10T00:00:00Z","author":{"@type":"Person","name":"Andreas Dieckmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diecknet.de/de/2025/04/10/powershell-send-mails-via-ms-graph/"},"publisher":{"@type":"Organization","name":"diecknet","logo":{"@type":"ImageObject","url":"https://diecknet.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diecknet.de/de/ accesskey=h title="diecknet (Alt + H)">diecknet</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://diecknet.de/de/ title=Deutsch aria-label=Deutsch><b>Deutsch</b></a></li><li><a href=https://diecknet.de/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://diecknet.de/de/ title=Home><span>Home</span></a></li><li><a href=https://diecknet.de/de/services/ title=Services><span>Services</span></a></li><li><a href=https://diecknet.de/de/about/ title=About><span>About</span></a></li><li><a href=https://diecknet.de/de/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://diecknet.de/de/archive/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://diecknet.de/de/>Home</a>&nbsp;¬ª&nbsp;<a href=https://diecknet.de/de/posts/>Posts</a></div><h1 class=post-title>E-Mails per PowerShell und Microsoft Graph verschicken</h1><div class=post-meta><span title='2025-04-10 00:00:00 +0000 UTC'>2025-04-10</span>&nbsp;¬∑&nbsp;11 Minuten&nbsp;¬∑&nbsp;Andreas Dieckmann&nbsp;|&nbsp;<a href=https://github.com/diecknet/diecknet-blog/tree/main/content/de/posts/2025/2025-04-10-PowerShell-Send-Mails-via-MS-Graph.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Inhaltsverzeichnis</span></summary><div class=inner><ul><li><a href=#die-herausforderung aria-label="Die Herausforderung">Die Herausforderung</a></li><li><a href=#powershell-module aria-label="PowerShell Module&mldr;">PowerShell Module&mldr;</a><ul><li><a href=#-f%c3%bcr-den-e-mail-versand aria-label="&mldr; f√ºr den E-Mail Versand">&mldr; f√ºr den E-Mail Versand</a></li><li><a href=#-f%c3%bcr-die-einrichtung aria-label="&mldr; f√ºr die Einrichtung">&mldr; f√ºr die Einrichtung</a></li></ul></li><li><a href=#authentifizierung-und-berechtigungen aria-label="Authentifizierung und Berechtigungen">Authentifizierung und Berechtigungen</a><ul><li><a href=#f%c3%bcr-einfache-tests-als-user aria-label="F√ºr einfache Tests: Als User">F√ºr einfache Tests: Als User</a></li><li><a href=#sicher-und-einfach-managed-identity aria-label="Sicher und einfach: Managed Identity">Sicher und einfach: Managed Identity</a></li><li><a href=#app-registration-und-zertifikat-oder-client-secret aria-label="App Registration und Zertifikat oder Client Secret">App Registration und Zertifikat oder Client Secret</a><ul><li><a href=#zertifikat aria-label=Zertifikat>Zertifikat</a></li><li><a href=#client-secret aria-label="Client Secret">Client Secret</a></li></ul></li><li><a href=#e-mail-versand-nur-auf-bestimmte-absender-einschr%c3%a4nken aria-label="E-Mail-Versand nur auf bestimmte Absender einschr√§nken">E-Mail-Versand nur auf bestimmte Absender einschr√§nken</a></li></ul></li><li><a href=#beispiele-f%c3%bcr-den-e-mail-versand aria-label="Beispiele f√ºr den E-Mail Versand">Beispiele f√ºr den E-Mail Versand</a><ul><li><a href=#beispiel-1-plain-text-e-mail aria-label="Beispiel 1: Plain-Text E-Mail">Beispiel 1: Plain-Text E-Mail</a></li><li><a href=#beispiel-2-html-e-mail aria-label="Beispiel 2: HTML E-Mail">Beispiel 2: HTML E-Mail</a></li><li><a href=#beispiel-3-mehrere-empf%c3%a4nger aria-label="Beispiel 3: Mehrere Empf√§nger">Beispiel 3: Mehrere Empf√§nger</a></li></ul></li><li><a href=#alternativen aria-label=Alternativen>Alternativen</a></li></ul></div></details></div><div class=post-content><p>E-Mails via Powershell und Microsoft Graph API zu verschicken, ist leider nicht so einfach wie mit dem klassischen <code>Send-MailMessage</code> Cmdlet. Zu dem klassischen Weg hatte ich ja auch k√ºrzlich <a href=https://diecknet.de/de/2025/03/23/powershell-send-mailmessage/>einen Blog-Post ver√∂ffentlicht</a>.</p><p>Trotzdem gibt es einige Gr√ºnde, die f√ºr den Versand per Microsoft Graph sprechen. Im Oktober 2025 wird voraussichtlich die Plaintext Authentifizierung (&ldquo;Basic Authentifizierung&rdquo;) f√ºr den SMTP-Versand bei Exchange Online abgeschaltet. Falls also Exchange Online euer einziges E-Mail-System ist, aber ihr automatisiert E-Mails verschicken wollt, dann ist MS Graph die richtige Wahl. Alternativ k√∂nntet ihr nat√ºrlich auch ein zus√§tzliches E-Mail-System anschaffen (anmieten oder selbst betreiben).</p><p>Ich finde es ganz charmant, wenn wir per PowerShell E-Mails verschicken und dabei die Exchange Online Infrastruktur nutzen k√∂nnen (inklusive eventueller Transportregeln, bestehendem DKIM/DMARC/SPF Setup usw.).</p><p>Ich habe auch ein Video zum Versand von E-Mails per MS Graph gemacht: <a href=https://youtu.be/0kgKD3XsEXU target=_blank>https://youtu.be/0kgKD3XsEXU</a></p><h2 id=die-herausforderung>Die Herausforderung<a hidden class=anchor aria-hidden=true href=#die-herausforderung>#</a></h2><p>Komplexer als beim einfachen <code>Send-MailMessage</code> ist beim Versand per Microsoft Graph:</p><ol><li>Authentifizierung<ul><li>Authentifizierung &ldquo;als App&rdquo; m√∂glich<ul><li>per Managed Identity, Zertifikat oder Client Secret</li><li>in der Regel ohne Einschr√§nkungen durch Conditional Access Policies</li></ul></li><li>Eher f√ºr Testzwecke: Authentifizierung auch als User m√∂glich</li></ul></li><li>Syntax<ul><li>Das Microsoft Graph PowerShell SDK bietet zwar das Cmdlet <code>Send-MgUserMail</code>, allerdings m√ºssen selbst einfachste Parameter als komische Hashtable angegeben werden, anstatt dass es einfach PowerShell Cmdlet Parameter sind üòì</li></ul></li></ol><h2 id=powershell-module>PowerShell Module&mldr;<a hidden class=anchor aria-hidden=true href=#powershell-module>#</a></h2><p>Es w√§re auch m√∂glich komplett ohne Zusatzmodule die Microsoft Graph API in PowerShell zu verwenden. Daf√ºr m√ºssten dann die HTTP Requests selbst konstruiert werden und dann per <code>Invoke-RestMethod</code> gesendet werden. Die Authentifizierung ist dann aber noch mal ein bisschen kniffliger.</p><p>Das PowerShell Graph SDK ist das offizielle Toolkit von Microsoft f√ºr die Verwendung der Microsoft Graph API in der PowerShell. Leider ist es nicht besonders gut. Es ist automatisch aus den API Spezifikationen generiert. Dadurch sind die Cmdlet-Namen teilweise lang und komisch, und die Parameter m√ºssen oftmals komplex per Hashtable/JSON √ºbergeben werden (anstatt das es einfach PowerShell Cmdlet Parameter sind). Es gibt auch Drittanbieter-Module f√ºr die Graph API, die Vorteile wie z.B. eine erh√∂hte Geschwindigkeit haben.
<strong>Aber</strong> daf√ºr ist das PowerShell Graph SDK <em>von Microsoft</em>. Ist also ein First-Party-Modul, dem ich ein h√∂heres Vertrauen entgegenbringen w√ºrde. Man k√∂nnte es auch als den Standard-Weg bezeichnen.</p><p>Ich pers√∂nlich habe nicht grunds√§tzlich etwas gegen PowerShell Module, die nicht von Microsoft kommen. Aber f√ºr manche Organisationen ist das wichtig.</p><h3 id=-f√ºr-den-e-mail-versand>&mldr; f√ºr den E-Mail Versand<a hidden class=anchor aria-hidden=true href=#-f√ºr-den-e-mail-versand>#</a></h3><p>Am Automatisierungshost ben√∂tigt ihr f√ºr den E-Mail-Versand das <code>Microsoft.Graph.Users.Actions</code> Modul.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#6c7986># Mit PowerShell 7 bzw. mit PSResourceGet</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Install-PSResource</span> Microsoft.Graph.Users.Actions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Mit Windows PowerShell 5.1 bzw. mit PowerShellGet</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Install-Module</span> Microsoft.Graph.Users.Actions
</span></span></code></pre></td></tr></table></div></div><h3 id=-f√ºr-die-einrichtung>&mldr; f√ºr die Einrichtung<a hidden class=anchor aria-hidden=true href=#-f√ºr-die-einrichtung>#</a></h3><p>Diese Module m√ºssen nicht unbedingt <em>auf</em> dem System installiert werden, auf dem dann die Automatisierung (also der E-Mail-Versand) l√§uft. Sie werden nur f√ºr die Einrichtung von Berechtigungen ben√∂tigt und k√∂nnten z.B. auf einer Admin-Workstation installiert werden.</p><ul><li><code>Microsoft.Graph.Applications</code> - um der App Registrierung bzw. Managed Identity grunds√§tzlich die Rechte zum E-Mail-Versand zu erteilen</li><li><code>ExchangeOnlineManagement</code> - um den Versand von E-Mails auf einzelne Absender zu beschr√§nken</li></ul><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#6c7986># Mit PowerShell 7 bzw. mit PSResourceGet</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Install-PSResource</span> Microsoft.Graph.Applications
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Install-PSResource</span> ExchangeOnlineManagement
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Mit Windows PowerShell 5.1 bzw. mit PowerShellGet</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Install-Module</span> Microsoft.Graph.Applications
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Install-Module</span> ExchangeOnlineManagement
</span></span></code></pre></td></tr></table></div></div><h2 id=authentifizierung-und-berechtigungen>Authentifizierung und Berechtigungen<a hidden class=anchor aria-hidden=true href=#authentifizierung-und-berechtigungen>#</a></h2><p>Bevor wir E-Mails verschicken k√∂nnen, m√ºssen wir uns authentifizieren.</p><h3 id=f√ºr-einfache-tests-als-user>F√ºr einfache Tests: Als User<a hidden class=anchor aria-hidden=true href=#f√ºr-einfache-tests-als-user>#</a></h3><p>F√ºr einfache Testzwecke k√∂nnen wir uns als User authentifizieren und dann im eigenen Namen E-Mails versenden. Falls das PowerShell Skript aber regelm√§√üig unbeaufsichtigt laufen soll, ist das hier nicht daf√ºr geeignet.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Connect-MgGraph</span> -Scopes <span style=color:#fc6a5d>&#34;Mail.Send&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Nachdem ihr euch grunds√§tzlich authentifiziert habt, kommt vermutlich noch eine Abfrage ob ihr den Berechtigungen zustimmt. Eventuell sind die Rechte daf√ºr in eurem Tenant eingeschr√§nkt, dann d√ºrft ihr das als normaler User gar nicht best√§tigen.</p><p>Falls ihr euch gerade als Administrator authentifiziert habt, dann gibt es noch die Checkbox zum &ldquo;Zustimmen im Namen der Organisation&rdquo; (&ldquo;Consent on behalf of your organization&rdquo;). Den Haken solltet ihr normalerweise nicht setzen - falls ihr die Option aktiviert, dann d√ºrften ab jetzt <strong>alle User</strong> in eurem Tenant das PowerShell Graph SDK verwenden um E-Mails zu verschicken.</p><p><a href=/images/2025/2025-04-10_MSGraphPermissions.jpg><img loading=lazy src=/images/2025/2025-04-10_MSGraphPermissions.jpg alt="Permissions Requested for Microsoft Graph Mail Versand" title="Permissions Requested for Microsoft Graph Mail Versand"></a></p><h3 id=sicher-und-einfach-managed-identity>Sicher und einfach: Managed Identity<a hidden class=anchor aria-hidden=true href=#sicher-und-einfach-managed-identity>#</a></h3><p>Die <strong>beste Option f√ºr produktive Zwecke ist meiner Meinung nach per &ldquo;Managed Identity&rdquo;</strong>. Dabei werden die Zugangsdaten automatisch durch Microsoft Entra ID verwaltet. Das funktioniert aber nur f√ºr Azure Ressourcen wie z.B. Azure VMs, Azure Automation Accounts oder an Azure angebundene Systeme (per Azure Arc).</p><p>Daf√ºr m√ºsst ihr zun√§chst eurer Azure Ressource eine Managed Identity zuweisen. Das geht oft direkt bei der Erstellung, aber nat√ºrlich auch im Nachhinein.</p><p><a href=/images/2025/2025-04-10_ManagedIdentityForVM.jpg><img loading=lazy src=/images/2025/2025-04-10_ManagedIdentityForVM.jpg alt="Beispiel: Aktivieren einer System Assigned Managed Identity f√ºr eine Azure Virtual Machine unter Security - Identity den Status auf On setzen. Anschlie√üend wird eine Objekt ID f√ºr die Managed Identity angezeigt." title="Beispiel: Aktivieren einer System Assigned Managed Identity f√ºr eine Azure Virtual Machine unter Security - Identity den Status auf On setzen. Anschlie√üend wird eine Objekt ID f√ºr die Managed Identity angezeigt."></a></p><p>Die Managed Identity hat dann einen Service Principal mit Objekt ID und kann dar√ºber Berechtigungen erhalten. Die Zuweisung der Berechtigung zum E-Mail-Versand k√∂nnt ihr mit folgendem PowerShell Code machen. Diese Einrichtung muss nicht am Automatisierungs-Host erfolgen, sondern kann z.B. auf einem Admin-System gemacht werden (siehe auch: <a href=#-f%c3%bcr-die-einrichtung>PowerShell Module f√ºr die Einrichtung</a>).</p><p>Die Werte f√ºr die Variablen <code>$TenantId</code> und <code>$managedIdentityObjectId</code> solltet ihr nat√ºrlich passend f√ºr eure Umgebung setzen. Bei Bedarf k√∂nntet ihr der App auch noch weitere Graph Berechtigungen zuweisen, daf√ºr das Array <code>$appRoleNames</code> mit weiteren Eintr√§gen bef√ºllen.</p><p><strong>‚ö†Ô∏è Wichtig:</strong> Im Standard darf die Managed Identity erstmal von allen Exchange-Absendern aus eurer Umgebung aus versenden. Ihr solltet die Berechtigungen einschr√§nken - wie das geht erkl√§re ich im Abschnitt <a href=#e-mail-versand-nur-auf-bestimmte-absender-einschr%c3%a4nken>E-Mail-Versand nur auf bestimmte Absender einschr√§nken</a>.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#6c7986># The tenant ID</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$TenantId</span> = <span style=color:#fc6a5d>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># The name of the app role that the managed identity should be assigned to.</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$appRoleNames</span> = @(<span style=color:#fc6a5d>&#34;Mail.Send&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Set the managed identity&#39;s object ID.</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$managedIdentityObjectId</span> = <span style=color:#fc6a5d>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Connect-MgGraph</span> -TenantId <span style=color:#41a1c0>$TenantId</span> -Scopes <span style=color:#fc6a5d>&#39;Application.Read.All&#39;</span>, <span style=color:#fc6a5d>&#39;AppRoleAssignment.ReadWrite.All&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Get Microsoft Graph app&#39;s service principal and app role.</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$serverApplicationName</span> = <span style=color:#fc6a5d>&#34;Microsoft Graph&#34;</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$serverServicePrincipal</span> = (<span style=color:#d0a8ff>Get-MgServicePrincipal</span> -Filter <span style=color:#fc6a5d>&#34;DisplayName eq &#39;</span><span style=color:#41a1c0>$serverApplicationName</span><span style=color:#fc6a5d>&#39;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#41a1c0>$serverServicePrincipalObjectId</span> = <span style=color:#41a1c0>$serverServicePrincipal</span>.Id
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Assign the managed identity access to the app role.</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>foreach</span> (<span style=color:#41a1c0>$appRoleName</span> <span style=color:#fc5fa3>in</span> <span style=color:#41a1c0>$appRoleNames</span>) {
</span></span><span style=display:flex><span>    <span style=color:#41a1c0>$currAppRoleId</span> = (<span style=color:#41a1c0>$serverServicePrincipal</span>.AppRoles | <span style=color:#d0a8ff>Where-Object</span> { <span style=color:#41a1c0>$_</span>.Value -eq <span style=color:#41a1c0>$appRoleName</span> }).Id
</span></span><span style=display:flex><span>    <span style=color:#d0a8ff>New-MgServicePrincipalAppRoleAssignment</span> `
</span></span><span style=display:flex><span>        -ServicePrincipalId <span style=color:#41a1c0>$managedIdentityObjectId</span> `
</span></span><span style=display:flex><span>        -PrincipalId <span style=color:#41a1c0>$managedIdentityObjectId</span> `
</span></span><span style=display:flex><span>        -ResourceId <span style=color:#41a1c0>$serverServicePrincipalObjectId</span> `
</span></span><span style=display:flex><span>        -AppRoleId <span style=color:#41a1c0>$currAppRoleId</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Es kann manchmal einige Zeit dauern bis die Berechtigung aktiv wird. Ich hatte es am n√§chsten Morgen dann wieder probiert (10-12h sp√§ter) und dann ging es. Ich w√ºrde aber eigentlich eher mit 1h rechnen.</p><p>Die eigentliche Authentifizierung in eurem PowerShell Skript (welches E-Mails versenden soll) erfolgt ganz einfach so:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Connect-MgGraph</span> -Identity
</span></span></code></pre></td></tr></table></div></div><p>Es m√ºssen also √ºberhaupt keine Zugangsdaten im Code referenziert werden üëç</p><h3 id=app-registration-und-zertifikat-oder-client-secret>App Registration und Zertifikat oder Client Secret<a hidden class=anchor aria-hidden=true href=#app-registration-und-zertifikat-oder-client-secret>#</a></h3><p>Falls Managed Identities bei euch nicht infrage kommen, dann gibt es auch die M√∂glichkeit eine App Registration in Entra ID anzulegen und dann wahlweise per Zertifikat (besser) oder per Client-Secret (schlechter) zu authentifizieren. Die Anlage erfolgt z.B. im Entra Admin Center unter &ldquo;Applications&rdquo; - &ldquo;App Registrations&rdquo; per Button &ldquo;New registration&rdquo;.</p><p><strong>‚ö†Ô∏è Wichtig:</strong> Im Standard darf die App/der Service Principal (nach der nachfolgenden Konfiguration) erstmal von allen Exchange-Absendern aus eurer Umgebung aus versenden. Ihr solltet die Berechtigungen einschr√§nken - wie das geht erkl√§re ich im Abschnitt <a href=#e-mail-versand-nur-auf-bestimmte-absender-einschr%c3%a4nken>E-Mail-Versand nur auf bestimmte Absender einschr√§nken</a>.</p><p><a href=/images/2025/2025-04-10_NewAppRegistration.jpg><img loading=lazy src=/images/2025/2025-04-10_NewAppRegistration.jpg alt="Neue App Registration im Entra Portal anlegen unter Applications - App Registrations" title="Neue App Registration im Entra Portal anlegen unter Applications - App Registrations"></a></p><p>Der Name der App ist im Grunde frei w√§hlbar. Bei &ldquo;Supported Account Types&rdquo; den Standard &ldquo;Accounts in this organizational directory only [&mldr;]&rdquo; beibehalten. Eine Redirect URI m√ºsst ihr nicht eintragen.</p><p><a href=/images/2025/2025-04-10_AppRegistrationSettings.jpg><img loading=lazy src=/images/2025/2025-04-10_AppRegistrationSettings.jpg alt="Der Name der App ist im Grunde frei w√§hlbar. Bei &ldquo;Supported Account Types&rdquo; den Standard &ldquo;Accounts in this organizational directory only [&mldr;]&rdquo; beibehalten. Eine Redirect URI m√ºsst ihr nicht eintragen." title="Der Name der App ist im Grunde frei w√§hlbar. Bei Supported Account Types den Standard Accounts in this organizational directory only beibehalten. Eine Redirect URI m√ºsst ihr nicht eintragen."></a></p><p>Nach der Anlage der App muss sie noch Berechtigungen erhalten. F√ºr die Managed Identity im vorherigen Abschnitt hatten wir ja PowerShell verwendet. Hier mal wie es per GUI gehen w√ºrde:</p><p>Unter &ldquo;API Permissions&rdquo; auf &ldquo;Add a permission&rdquo; klicken.</p><p><a href=/images/2025/2025-04-10_AppRegistrationApiPermissions.jpg><img loading=lazy src=/images/2025/2025-04-10_AppRegistrationApiPermissions.jpg alt="Nach der Anlage der App: Add a Permission unter API Permissions" title="Nach der Anlage der App: Add a Permission unter API Permissions"></a></p><p>Bei der Auswahl &ldquo;Select an API&rdquo; die Option &ldquo;Microsoft Graph&rdquo; ausw√§hlen.</p><p><a href=/images/2025/2025-04-10_AppRegistrationApiPermissionsSelectAnApi.jpg><img loading=lazy src=/images/2025/2025-04-10_AppRegistrationApiPermissionsSelectAnApi.jpg alt="Bei der Auswahl &ldquo;Select an API&rdquo; die Option &ldquo;Microsoft Graph&rdquo; ausw√§hlen." title="Bei der Auswahl Select an API die Option Microsoft Graph ausw√§hlen."></a></p><p>Bei der Auswahl &ldquo;What type of permissions does your application require?&rdquo; die Option &ldquo;Application permissions&rdquo; w√§hlen.</p><p><a href=/images/2025/2025-04-10_AppRegistrationApiPermissionsRequestApiPermissions.jpg><img loading=lazy src=/images/2025/2025-04-10_AppRegistrationApiPermissionsRequestApiPermissions.jpg alt="Bei der Auswahl &ldquo;What type of permissions does your application require?&rdquo; die Option &ldquo;Application permissions&rdquo; w√§hlen." title="Bei der Auswahl What type of permissions does your application require? die Option Application permissions w√§hlen."></a></p><p>Bei der Auswahl &ldquo;Select permission&rdquo; die Berechtigung &ldquo;Mail.Send&rdquo; raussuchen und ausw√§hlen.</p><p><a href=/images/2025/2025-04-10_AppRegistrationApiPermissionsSelectPermissions.jpg><img loading=lazy src=/images/2025/2025-04-10_AppRegistrationApiPermissionsSelectPermissions.jpg alt="Bei der Auswahl &ldquo;Select permission&rdquo; die Berechtigung &ldquo;Mail.Send&rdquo; raussuchen und ausw√§hlen.." title="Bei der Auswahl Select permission die Berechtigung Mail.Send raussuchen und ausw√§hlen.."></a></p><p>Die Standard-Berechtigung &ldquo;User.Read&rdquo; vom Type &ldquo;Delegated&rdquo; kann √ºbrigens gel√∂scht werden - sie wird f√ºr den E-Mail-Versand nicht ben√∂tigt.</p><p><a href=/images/2025/2025-04-10_AppRegistrationApiPermissionsRemoveUserRead.jpg><img loading=lazy src=/images/2025/2025-04-10_AppRegistrationApiPermissionsRemoveUserRead.jpg alt="Die Standard-Berechtigung &ldquo;User.Read&rdquo; vom Type &ldquo;Delegated&rdquo; kann √ºbrigens gel√∂scht werden - sie wird f√ºr den E-Mail-Versand nicht ben√∂tigt." title="Die Standard-Berechtigung User.Read vom Type Delegated kann √ºbrigens gel√∂scht werden - sie wird f√ºr den E-Mail-Versand nicht ben√∂tigt."></a></p><p>Anschlie√üend der neuen API Berechtigung im Namen der Organisation zustimmen per &ldquo;Grant admin consent for TENANTNAME&rdquo; und per &ldquo;Yes&rdquo; best√§tigen.</p><p><a href=/images/2025/2025-04-10_AppRegistrationApiPermissionsGrantConsent.jpg><img loading=lazy src=/images/2025/2025-04-10_AppRegistrationApiPermissionsGrantConsent.jpg alt="Bei der Auswahl &ldquo;Select permission&rdquo; die Berechtigung &ldquo;Mail.Send&rdquo; raussuchen und ausw√§hlen." title="Bei der Auswahl Select permission die Berechtigung Mail.Send raussuchen und ausw√§hlen."></a></p><h4 id=zertifikat>Zertifikat<a hidden class=anchor aria-hidden=true href=#zertifikat>#</a></h4><p>Wenn ihr euch per Zertifikat authentifizieren m√∂chtet, dann schaut euch die Dokumentation bei Microsoft an: <a href=https://learn.microsoft.com/en-us/entra/identity-platform/howto-create-self-signed-certificate target=_blank>https://learn.microsoft.com/en-us/entra/identity-platform/howto-create-self-signed-certificate</a></p><h4 id=client-secret>Client Secret<a hidden class=anchor aria-hidden=true href=#client-secret>#</a></h4><p>Wenn ihr euch per Client Secret authentifizieren m√∂chtet, dann m√ºsst ihr zun√§chst ein Secret erstellen. Das geht unter &ldquo;Certificates & Secrets&rdquo; - dort dann unter &ldquo;Client secrets&rdquo; auf &ldquo;New client secret&rdquo; klicken.</p><p><a href=/images/2025/2025-04-10_NewAppRegistrationClientSecret1.jpg><img loading=lazy src=/images/2025/2025-04-10_NewAppRegistrationClientSecret1.jpg alt="Neues Secret hinzuf√ºgen: &ldquo;Certificates & secrets&rdquo; - &ldquo;Client secrets&rdquo; - &ldquo;New client secret&rdquo;." title="Neues Secret hinzuf√ºgen: Certificates & secrets - Client secrets - new client secret."></a></p><p>Tendenziell ist es aus Sicherheitsgr√ºnden empfehlenswert keine allzu lange G√ºltigkeitsdauer auszuw√§hlen. Ich habe deshalb den Standardwert 180 Tage beibehalten.</p><p><a href=/images/2025/2025-04-10_NewAppRegistrationClientSecret2.jpg><img loading=lazy src=/images/2025/2025-04-10_NewAppRegistrationClientSecret2.jpg alt="Description ist frei w√§hlbar, Ablaufdatum sollte nicht zu weit in der Zukunft sein" title="Description ist frei w√§hlbar, Ablaufdatum sollte nicht zu weit in der Zukunft sein"></a></p><p>Der Secret Value wird euch nur einmalig angezeigt. Ihr solltet ihn also sofort kopieren. Wenn ihr sp√§ter zu der Seite zur√ºck kommt, dann wird er nicht mehr vollst√§ndig angezeigt. Das Secret ist mit einem Passwort gleich zu setzen - sollte also auch nicht in Klartext in Dokumentationen aufgenommen werden und auch nicht im Klartext im PowerShell Code abgelegt werden.</p><p>Das Secret hier im Screenshot ist nat√ºrlich nicht mehr g√ºltig üòâ</p><p><a href=/images/2025/2025-04-10_NewAppRegistrationClientSecret3.jpg><img loading=lazy src=/images/2025/2025-04-10_NewAppRegistrationClientSecret3.jpg alt="Secret sollte sofort kopiert werden und wie ein Passwort behandelt werden" title="Secret sollte sofort kopiert werden und wie ein Passwort behandelt werden"></a></p><p>Eine M√∂glichkeit das Secret einigerma√üen sicher abzuspeichern w√§re als exportieres PowerShell Credential Objekt. Das kann nur durch den User (am gleichen Computer) entschl√ºsselt werden, der es auch verschl√ºsselt hat.
Alternativ ist das <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.secretmanagement/?view=ps-modules" target=_blank>PowerShell Modul SecretManagement</a> auch noch ein interessanter Ansatz.</p><p>So k√∂nnt ihr die Credentials abfragen abspeichern - als Username die Application ID von der Hauptseite der App Registration angeben.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$Credential</span> = <span style=color:#d0a8ff>Get-Credential</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$Credential</span> | <span style=color:#d0a8ff>Export-CliXml</span> Credential.xml
</span></span></code></pre></td></tr></table></div></div><p>Und dann sp√§ter in eurem Skript k√∂nnt ihr es so importieren und euch damit bei MS Graph authentifizieren. Bitte auch daran denken die TenantID einzutragen:</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$Credential</span> = <span style=color:#d0a8ff>Import-Clixml</span> .\Credential.xml
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Connect-MgGraph</span> -ClientSecretCredential <span style=color:#41a1c0>$Credential</span> -TenantId <span style=color:#fc6a5d>&#34;hier eure TenantID eintragen&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=e-mail-versand-nur-auf-bestimmte-absender-einschr√§nken>E-Mail-Versand nur auf bestimmte Absender einschr√§nken<a hidden class=anchor aria-hidden=true href=#e-mail-versand-nur-auf-bestimmte-absender-einschr√§nken>#</a></h3><p>Wie bereits erw√§hnt darf ein Service Principal/Managed Identity mit der <code>Mail.Send</code> Berechtigung erstmal alle Exchange-Objekte aus eurer Umgebung als Absender verwenden. Ich w√ºrde empfehlen diese Rechte immer <a href=https://learn.microsoft.com/en-us/graph/auth-limit-mailbox-access target=_blank>einzuschr√§nken</a>, sodass nur durch bestimmte Absender verschickt werden darf.</p><p>Die Konfiguration so einer Einschr√§nkung erfolgt per Exchange Online PowerShell. Das muss nicht am Automatisierungshost gemacht werden, sondern kann auch von einer Admin-VM o.√§. erfolgen (siehe auch: <a href=#-f%c3%bcr-die-einrichtung>PowerShell Module f√ºr die Einrichtung</a>).</p><p>Zu den Parameterwerten f√ºr <a href="https://learn.microsoft.com/en-us/powershell/module/exchange/new-applicationaccesspolicy?view=exchange-ps" target=_blank><code>New-ApplicationAccessPolicy</code></a>:</p><ul><li><code>-AppId</code> die Application ID (auch &ldquo;Client ID&rdquo; genannt) von eurer App Registration bzw. eurer Managed Identity*</li><li><code>-PolicyGroupScopeId</code> wahlweise ein einzelnes Postfach (auch Shared Mailboxes werden unterst√ºtzt) oder eine Mail-Enabled Security Group, die die Exchange Objekte enth√§lt von denen aus gesendet werden soll</li><li><code>-Description</code> die Beschreibung ist frei w√§hlbar</li><li><code>-AccessRight</code> der Wert <code>RestrictAccess</code> sorgt daf√ºr, dass die App nur auf die bei <code>-PolicyGroupScopeId</code> genannten Mailboxen zugreifen darf</li></ul><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Connect-ExchangeOnline</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>New-ApplicationAccessPolicy</span> -AppId <span style=color:#fc6a5d>&#34;Hier App ID eintragen&#34;</span> -PolicyScopeGroupId <span style=color:#fc6a5d>&#34;hier Gruppe oder Postfach eintragen von dem verschickt werden darf&#34;</span> -AccessRight RestrictAccess -Description <span style=color:#fc6a5d>&#34;Beschreibung ist auch frei w√§hlbar&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>*Die Application ID eurer Managed Identity ist √ºbrigens nicht die Object ID. Falls ihr die Application ID herausfinden m√∂chtet, dann schaut im Entra Portal unter &ldquo;Enterprise Applications&rdquo; und √§ndert den Filter &ldquo;Application type&rdquo; auf &ldquo;Managed Identities&rdquo;.</p><p><a href=/images/2025/2025-04-10_ManagedIdentityApplicationID.jpg><img loading=lazy src=/images/2025/2025-04-10_ManagedIdentityApplicationID.jpg alt="√Ñnderung des Filters Application Type auf Managed Identities unter Enterprise Applications in Entra ID um die Application ID einer Managed Identity herauszufinden" title="√Ñnderung des Filters Application Type auf Managed Identities unter Enterprise Applications in Entra ID um die Application ID einer Managed Identity herauszufinden"></a></p><h2 id=beispiele-f√ºr-den-e-mail-versand>Beispiele f√ºr den E-Mail Versand<a hidden class=anchor aria-hidden=true href=#beispiele-f√ºr-den-e-mail-versand>#</a></h2><p>Puh&mldr; Die Authentifizierung und Einschr√§nkung auf bestimmte Absender-Adressen haben wir jetzt also. Hier ein paar Beispiele f√ºr den eigentlichen Versand von E-Mails.</p><p>Es gibt noch zahlreiche weitere Optionen, f√ºr die ihr die <code>$params</code> Hashtable anpassen k√∂nnt. Diese &ldquo;complex Parameters&rdquo; werden in der Dokumentation zum Cmdlet <code>Send-MgUserMail</code> <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.users.actions/send-mgusermail?view=graph-powershell-1.0#notes" target=_blank>im Abschnitt &ldquo;Notes&rdquo; aufgef√ºhrt</a>.</p><h3 id=beispiel-1-plain-text-e-mail>Beispiel 1: Plain-Text E-Mail<a hidden class=anchor aria-hidden=true href=#beispiel-1-plain-text-e-mail>#</a></h3><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$params</span> = @{
</span></span><span style=display:flex><span>	message = @{
</span></span><span style=display:flex><span>		subject = <span style=color:#fc6a5d>&#34;Test E-Mail per MS Graph&#34;</span>
</span></span><span style=display:flex><span>		body = @{
</span></span><span style=display:flex><span>			contentType = <span style=color:#fc6a5d>&#34;Text&#34;</span>
</span></span><span style=display:flex><span>			content = <span style=color:#fc6a5d>&#34;Gr√º√üe aus der PowerShell (per Graph)&#34;</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		toRecipients = @(
</span></span><span style=display:flex><span>			@{
</span></span><span style=display:flex><span>				emailAddress = @{
</span></span><span style=display:flex><span>					address = <span style=color:#fc6a5d>&#34;hans.maulwurf@demotenant.de&#34;</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Send-MgUserMail</span> -UserId <span style=color:#fc6a5d>&#34;diecknet-adm@diecknetdemotenant.onmicrosoft.com&#34;</span> -BodyParameter <span style=color:#41a1c0>$params</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=beispiel-2-html-e-mail>Beispiel 2: HTML E-Mail<a hidden class=anchor aria-hidden=true href=#beispiel-2-html-e-mail>#</a></h3><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$params</span> = @{
</span></span><span style=display:flex><span>	message = @{
</span></span><span style=display:flex><span>		subject = <span style=color:#fc6a5d>&#34;Test HTML E-Mail per MS Graph&#34;</span>
</span></span><span style=display:flex><span>		body = @{
</span></span><span style=display:flex><span>			contentType = <span style=color:#fc6a5d>&#34;html&#34;</span>
</span></span><span style=display:flex><span>			content = <span style=color:#fc6a5d>@&#34;
</span></span></span><span style=display:flex><span><span style=color:#fc6a5d>				&lt;h1&gt;Gr√º√üe aus der PowerShell (per Graph)&lt;/h1&gt;
</span></span></span><span style=display:flex><span><span style=color:#fc6a5d>				&lt;a href=&#34;https://youtube.com/@diecknet&#34;&gt;Kanal abonnieren :)&lt;/a&gt;&lt;br&gt;
</span></span></span><span style=display:flex><span><span style=color:#fc6a5d>				&lt;b&gt;Danke!&lt;/b&gt;
</span></span></span><span style=display:flex><span><span style=color:#fc6a5d>&#34;@</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		toRecipients = @(
</span></span><span style=display:flex><span>			@{
</span></span><span style=display:flex><span>				emailAddress = @{
</span></span><span style=display:flex><span>					address = <span style=color:#fc6a5d>&#34;hans.maulwurf@demotenant.de&#34;</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Send-MgUserMail</span> -UserId <span style=color:#fc6a5d>&#34;abteilungspostfach@demotenant.de&#34;</span> -BodyParameter <span style=color:#41a1c0>$params</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=beispiel-3-mehrere-empf√§nger>Beispiel 3: Mehrere Empf√§nger<a hidden class=anchor aria-hidden=true href=#beispiel-3-mehrere-empf√§nger>#</a></h3><p>Die Syntax f√ºr mehrere Empf√§nger ist ein wenig eigen. Hier mal ein Beispiel f√ºr zwei Empf√§nger:</p><p>Die Eigenschaft <code>toRecipients</code> ist ein Array, welches wiederum zwei Hashtables enth√§lt (eine pro Empf√§nger), die jeweils eine Hashtable enthalten. Cool üòê</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#41a1c0>$params</span> = @{
</span></span><span style=display:flex><span>	message = @{
</span></span><span style=display:flex><span>		subject = <span style=color:#fc6a5d>&#34;Test E-Mail an mehrere Leute&#34;</span>
</span></span><span style=display:flex><span>		body = @{
</span></span><span style=display:flex><span>			contentType = <span style=color:#fc6a5d>&#34;html&#34;</span>
</span></span><span style=display:flex><span>			content = <span style=color:#fc6a5d>@&#34;
</span></span></span><span style=display:flex><span><span style=color:#fc6a5d>				&lt;h1&gt;Gr√º√üe aus der PowerShell (per Graph)&lt;/h1&gt;
</span></span></span><span style=display:flex><span><span style=color:#fc6a5d>				Jetzt mal an mehrere Empf√§nger :)
</span></span></span><span style=display:flex><span><span style=color:#fc6a5d>&#34;@</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		toRecipients = @(
</span></span><span style=display:flex><span>			@{
</span></span><span style=display:flex><span>				emailAddress = @{
</span></span><span style=display:flex><span>					address = <span style=color:#fc6a5d>&#34;hans.maulwurf@demotenant.de&#34;</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>			@{
</span></span><span style=display:flex><span>				emailAddress = @{
</span></span><span style=display:flex><span>					address = <span style=color:#fc6a5d>&#34;alexw@demotenant.de&#34;</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Send-MgUserMail</span> -UserId <span style=color:#fc6a5d>&#34;abteilungspostfach@demotenant.de&#34;</span> -BodyParameter <span style=color:#41a1c0>$params</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=alternativen>Alternativen<a hidden class=anchor aria-hidden=true href=#alternativen>#</a></h2><p>Da das Rumhantieren mit den Hashtables etwas umst√§ndlich ist, gibt es einige alternative Module aus der Community.</p><p>Zum Beispiel <a href=https://github.com/EvotecIT/Mailozaurr target=_blank>Mailozaurr von Microsoft MVP Przemys≈Çaw K≈Çys</a> finde ich ganz cool. Das Modul stellt das neue Cmdlet <code>Send-EmailMessage</code> bereit (also statt dem Standard <code>Send-MailMessage</code>). Es werden auch noch andere Protokolle und Authentifizierungen unterst√ºtzt (nicht nur MS Graph). Leider werden zurzeit keine Managed Identities unterst√ºtzt, deshalb habe ich es nur einmal kurz zu Testzwecken verwendet.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://diecknet.de/de/tags/powershell/>Powershell</a></li><li><a href=https://diecknet.de/de/tags/microsoft-graph/>Microsoft Graph</a></li><li><a href=https://diecknet.de/de/tags/exchange/>Exchange</a></li></ul><div class=share-buttons></div></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://diecknet.de/de/>diecknet</a></span>
&nbsp;|&nbsp;
<span><a href=https://diecknet.de/de/legal/>Impressum</a>
</span>&nbsp;|&nbsp;<span>
<a href=https://diecknet.de/de/privacy/>Datenschutz</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Kopieren";function s(){t.innerHTML="Kopiert!",setTimeout(()=>{t.innerHTML="Kopieren"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript>var _paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="//nc.diecknet.de/mt/",_paq.push(["setTrackerUrl",t+"mdata"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.defer=!0,e.src=t+"m.js",s.parentNode.insertBefore(e,s)}()</script><noscript><p><img src="https://nc.diecknet.de/mt/mdata?idsite=1&amp;rec=1" style=border:0 alt></p></noscript></body></html>