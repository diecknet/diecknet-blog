<!doctype html><html lang=de dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Exchange Online per Azure Automation steuern im Jahr 2024 | diecknet</title>
<meta name=keywords content="microsoft365,office365,exchangeonline,powershell,exo,azure,azureautomation"><meta name=description content="Wenn ihr Exchange Online per Azure Automation steuern wollt, dann ist Managed Identities was ihr benutzen solltet (diese Aussage wurde zuletzt gepr√ºft im Juni 2024).
Legacy Ansatz Fr√ºher wurden daf√ºr auch gerne RunAs Accounts oder Plaintext Credentials (ü§¢) verwendet, aber das gilt mittlerweile als veraltet. RunAs Accounts sind zum Herbst 2023 abgek√ºndigt und zu Klartext-Kennw√∂rtern muss ich nix sagen, oder? Eventuell bieten sich noch App Registrierungen in Entra ID an, aber wenn ihr wirklich einfach nur per Azure Automation ein paar Exchange Online Einstellungen automatisieren wollt, ist das eigentlich nicht notwendig."><meta name=author content="Andreas Dieckmann"><link rel=canonical href=https://diecknet.de/de/2023/01/09/Exchange-Online-per-Azure-Automation/><link crossorigin=anonymous href=/assets/css/stylesheet.75a517428f403193483801122d6350f6956c3bb6bf5c6504311f8c24e6bab3e7.css integrity="sha256-daUXQo9AMZNIOAESLWNQ9pVsO7a/XGUEMR+MJOa6s+c=" rel="preload stylesheet" as=style><link rel=icon href=https://diecknet.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://diecknet.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://diecknet.de/favicon-32x32.png><link rel=apple-touch-icon href=https://diecknet.de/apple-touch-icon.png><link rel=mask-icon href=https://diecknet.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=de href=https://diecknet.de/de/2023/01/09/Exchange-Online-per-Azure-Automation/><link rel=alternate hreflang=en href=https://diecknet.de/en/2023/01/09/Exchange-Online-per-Azure-Automation/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Exchange Online per Azure Automation steuern im Jahr 2024"><meta property="og:description" content="Wenn ihr Exchange Online per Azure Automation steuern wollt, dann ist Managed Identities was ihr benutzen solltet (diese Aussage wurde zuletzt gepr√ºft im Juni 2024).
Legacy Ansatz Fr√ºher wurden daf√ºr auch gerne RunAs Accounts oder Plaintext Credentials (ü§¢) verwendet, aber das gilt mittlerweile als veraltet. RunAs Accounts sind zum Herbst 2023 abgek√ºndigt und zu Klartext-Kennw√∂rtern muss ich nix sagen, oder? Eventuell bieten sich noch App Registrierungen in Entra ID an, aber wenn ihr wirklich einfach nur per Azure Automation ein paar Exchange Online Einstellungen automatisieren wollt, ist das eigentlich nicht notwendig."><meta property="og:type" content="article"><meta property="og:url" content="https://diecknet.de/de/2023/01/09/Exchange-Online-per-Azure-Automation/"><meta property="og:image" content="https://diecknet.de/images/2023/2023-AA-EXO.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-09T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-25T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://diecknet.de/images/2023/2023-AA-EXO.jpg"><meta name=twitter:title content="Exchange Online per Azure Automation steuern im Jahr 2024"><meta name=twitter:description content="Wenn ihr Exchange Online per Azure Automation steuern wollt, dann ist Managed Identities was ihr benutzen solltet (diese Aussage wurde zuletzt gepr√ºft im Juni 2024).
Legacy Ansatz Fr√ºher wurden daf√ºr auch gerne RunAs Accounts oder Plaintext Credentials (ü§¢) verwendet, aber das gilt mittlerweile als veraltet. RunAs Accounts sind zum Herbst 2023 abgek√ºndigt und zu Klartext-Kennw√∂rtern muss ich nix sagen, oder? Eventuell bieten sich noch App Registrierungen in Entra ID an, aber wenn ihr wirklich einfach nur per Azure Automation ein paar Exchange Online Einstellungen automatisieren wollt, ist das eigentlich nicht notwendig."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://diecknet.de/de/posts/"},{"@type":"ListItem","position":2,"name":"Exchange Online per Azure Automation steuern im Jahr 2024","item":"https://diecknet.de/de/2023/01/09/Exchange-Online-per-Azure-Automation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Exchange Online per Azure Automation steuern im Jahr 2024","name":"Exchange Online per Azure Automation steuern im Jahr 2024","description":"Wenn ihr Exchange Online per Azure Automation steuern wollt, dann ist Managed Identities was ihr benutzen solltet (diese Aussage wurde zuletzt gepr√ºft im Juni 2024).\nLegacy Ansatz Fr√ºher wurden daf√ºr auch gerne RunAs Accounts oder Plaintext Credentials (ü§¢) verwendet, aber das gilt mittlerweile als veraltet. RunAs Accounts sind zum Herbst 2023 abgek√ºndigt und zu Klartext-Kennw√∂rtern muss ich nix sagen, oder? Eventuell bieten sich noch App Registrierungen in Entra ID an, aber wenn ihr wirklich einfach nur per Azure Automation ein paar Exchange Online Einstellungen automatisieren wollt, ist das eigentlich nicht notwendig.","keywords":["microsoft365","office365","exchangeonline","powershell","exo","azure","azureautomation"],"articleBody":"Wenn ihr Exchange Online per Azure Automation steuern wollt, dann ist Managed Identities was ihr benutzen solltet (diese Aussage wurde zuletzt gepr√ºft im Juni 2024).\nLegacy Ansatz Fr√ºher wurden daf√ºr auch gerne RunAs Accounts oder Plaintext Credentials (ü§¢) verwendet, aber das gilt mittlerweile als veraltet. RunAs Accounts sind zum Herbst 2023 abgek√ºndigt und zu Klartext-Kennw√∂rtern muss ich nix sagen, oder? Eventuell bieten sich noch App Registrierungen in Entra ID an, aber wenn ihr wirklich einfach nur per Azure Automation ein paar Exchange Online Einstellungen automatisieren wollt, ist das eigentlich nicht notwendig.\nManaged Identities + Exchange Online PowerShell Eine System Assigned Managed Identity weist einer Azure Resource eine Identit√§t zu. Dieser Identit√§t k√∂nnen Rechte zugewiesen werden, z.B. f√ºr die Administration von Exchange Online oder bestimmten Azure Ressourcen. Die Verwaltung der Identit√§t erfolgt automatisch, es muss also kein Passwort regelm√§√üig ge√§ndert werden oder √§hnliches. Und wenn die dazugeh√∂rige Ressource (in dem Fall das Azure Automation Konto) gel√∂scht wird, wird die System Assigned Managed Identity automatisch mitgel√∂scht. Das Exchange Online PowerShell Modul unterst√ºtzt ab Version 3 Managed Identities f√ºr die Authentifizierung.\nTheoretisch sollte das ganze auch mit einer User Assigned Managed Identities funktionieren. Dabei wird die Managed Identity selbst erzeugt und kann dann mehreren Azure Ressourcen zugewiesen werden. F√ºr manche Szenarien sicher auch praktisch.\nManaged Identity aktivieren Ich bevorzuge es System Assigned Managed Identities zu verwenden, da so effektiv nur eine Ressource die Rechte erh√§lt. Ihr k√∂nnt im Automation Account unter ‚ÄúAccount Settings‚Äù -\u003e ‚ÄúIdentity‚Äù pr√ºfen, ob eine Managed Identity verwendet wird. Hier ein Beispiel-Screenshot mit einer vorhandenen Managed Identity: Der Status steht auf ‚ÄúOn‚Äù und es wird eine Object ID aufgef√ºhrt.\nDie Zuweisung der ‚ÄúExchange Administrator‚Äù-Rolle an die Managed Identity erfolgt dann anschlie√üend per PowerShell/Graph API.\nKonfiguration per PowerShell In diesem Abschnitt wird beschrieben, wie ihr die Konfiguration per PowerShell durchf√ºhren k√∂nnt. Die Zuweisung der ‚ÄúExchange Administrator‚Äù-Rolle an eine Managed Identity erfolgt einmalig per lokaler PowerShell - der nachfolgende Code wird also nicht in Azure Automation als Runbook ausgef√ºhrt.\nVoraussetzungen:\nDas Microsoft.Graph PowerShell Modul Ein Benutzeraccount mit der Admin-Rolle ‚ÄúPrivileged Role Administrator‚Äù oder ‚ÄúGlobaler Administrator‚Äù Falls ihr das Modul noch nicht installiert habt, k√∂nnt ihr es wie folgt installieren (mehr Infos hier):\n1 Install-Module Microsoft.Graph Anschlie√üend k√∂nnt ihr den nachfolgenden Code verwenden. Der Code ist inline kommentiert, also erkl√§re ich jetzt hier nichts weiter.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 Connect-MgGraph -Scopes AppRoleAssignment.ReadWrite.All,Application.Read.All,RoleManagement.ReadWrite.Directory # Put your Managed Identity / Enterprise App registration name here: $MI_Name = \"Mein-Automation-Account\" # there is no need to change any of the code below $MI_SP = Get-MgServicePrincipal -Property \"displayName,appId,id\" -Filter \"servicePrincipalType eq 'ManagedIdentity' and DisplayName eq '$($MI_Name)'\" -ErrorAction Stop if($MI_SP.Count -ne 1) { Write-Error \"Something is wrong, found $($MI_SP.Count) matching Entra Service Principals. Aborting...\" exit 1 } else { $MI_ID = $MI_SP.Id } # try to retrieve the Exchange Online Service Principal (sometimes it's not available) $EXO_SP = Get-MgServicePrincipal -Filter \"AppId eq '00000002-0000-0ff1-ce00-000000000000'\" if(!$EXO_SP) { Write-Error \"No Exchange Online Service Principal found. Check this for troubleshooting: https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps#what-to-do-if-the-office-365-exchange-online-resource-is-not-available-in-microsoft-entra-id\" exit 1 # we can't proceed without the EXO_SP } # Exchange.ManageAsApp API Permission $AppRoleId = \"dc50a0fb-09a3-484d-be87-e023b12c6440\" # the GUID value of the Office 365 Exchange Online resource in Microsoft Entra ID. The AppId value is the same in every organization, but the Id value is different in every organization. $ResourceID = $EXO_SP.Id # the actual assignment of Exchange.ManageAsApp: New-MgServicePrincipalAppRoleAssignment -ServicePrincipalId $MI_ID -PrincipalId $MI_ID -AppRoleId $AppRoleID -ResourceId $ResourceID $ExchangeAdminRoleID = (Get-MgRoleManagementDirectoryRoleDefinition -Filter \"DisplayName eq 'Exchange Administrator'\").Id # the actual assignment of the Exchange Administrator role: New-MgRoleManagementDirectoryRoleAssignment -PrincipalId $MI_ID -RoleDefinitionId $ExchangeAdminRoleID -DirectoryScopeId \"/\" Modul hinzuf√ºgen Egal ob ihr bereits ‚ÄúRuntime Environments‚Äù verwendet, oder noch die ‚ÄúOld experience‚Äù, ihr m√ºsst das ExchangeOnlineManagement PowerShell Modul hinzuf√ºgen. Im Falle der ‚ÄúOld experience‚Äù zum gesamten Automation Account. Wenn ihr Runtime Environments verwendet, dann f√ºgt das Modul stattdessen zu einem Runtime Environment hinzu bzw. legt ein neues Runtime Environment an. Das Modul wird sowohl von Windows PowerShell, als auch PowerShell 7 unterst√ºtzt.\nExchange Online PowerShell verwenden Folgender Beispiel Code f√ºr ein Runbook verbindet sich als System Managed Managed Identity mit der Exchange Online Verwaltung, f√ºhrt einen Exchange Online PowerShell Befehl aus und trennt dann die Verbindung zu Exchange Online wieder.\n1 2 3 4 5 6 7 8 # Replace the Organization name with a domain from your tenant Connect-ExchangeOnline -ManagedIdentity -Organization demotenant.de # Example command that uses Exchange Online PowerShell: List all mailboxes Get-ExoMailbox # Disconnect again to free up connections Disconnect-ExchangeOnline -Confirm:$false How-to Video Ich habe auch ein Video erstellt, in dem zeige wie Exchange Online per Azure Automation gesteuert werden kann. Dabei wird eine System Assigned Managed Identity f√ºr das Azure Automation Konto verwendet und dieser Identit√§t die Rechte zur Exchange Verwaltung zugewiesen.\nWeiterf√ºhrende Links Die offizielle Microsoft Dokumentation dazu ist hier zu finden: https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps\n","wordCount":"811","inLanguage":"de","image":"https://diecknet.de/images/2023/2023-AA-EXO.jpg","datePublished":"2023-01-09T00:00:00Z","dateModified":"2024-06-25T00:00:00Z","author":{"@type":"Person","name":"Andreas Dieckmann"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diecknet.de/de/2023/01/09/Exchange-Online-per-Azure-Automation/"},"publisher":{"@type":"Organization","name":"diecknet","logo":{"@type":"ImageObject","url":"https://diecknet.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diecknet.de/de/ accesskey=h title="diecknet (Alt + H)">diecknet</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://diecknet.de/de/2023/01/09/Exchange-Online-per-Azure-Automation/ title=Deutsch aria-label=Deutsch><b>Deutsch</b></a></li><li><a href=https://diecknet.de/en/2023/01/09/Exchange-Online-per-Azure-Automation/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://diecknet.de/de/ title=Home><span>Home</span></a></li><li><a href=https://diecknet.de/de/services/ title=Services><span>Services</span></a></li><li><a href=https://diecknet.de/de/about/ title=About><span>About</span></a></li><li><a href=https://diecknet.de/de/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://diecknet.de/de/archive/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://diecknet.de/de/>Home</a>&nbsp;¬ª&nbsp;<a href=https://diecknet.de/de/posts/>Posts</a></div><h1 class=post-title>Exchange Online per Azure Automation steuern im Jahr 2024</h1><div class=post-meta><span title='2023-01-09 00:00:00 +0000 UTC'>2023-01-09</span>&nbsp;¬∑&nbsp;4 Minuten&nbsp;¬∑&nbsp;Andreas Dieckmann&nbsp;|&nbsp;<ul class=i18n_list>üåç&nbsp;This content is also available in:&nbsp;<li><a href=https://diecknet.de/en/2023/01/09/Exchange-Online-per-Azure-Automation/>English</a></li></ul>&nbsp;|&nbsp;<a href=https://github.com/diecknet/diecknet-blog/tree/main/content/de/posts/2023/2023-01-09-Exchange-Online-per-Azure-Automation.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><figure class=entry-cover><img loading=lazy src=https://diecknet.de/images/2023/2023-AA-EXO.jpg alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Inhaltsverzeichnis</span></summary><div class=inner><ul><li><a href=#legacy-ansatz aria-label="Legacy Ansatz">Legacy Ansatz</a></li><li><a href=#managed-identities--exchange-online-powershell aria-label="Managed Identities + Exchange Online PowerShell">Managed Identities + Exchange Online PowerShell</a><ul><li><a href=#managed-identity-aktivieren aria-label="Managed Identity aktivieren">Managed Identity aktivieren</a></li><li><a href=#konfiguration-per-powershell aria-label="Konfiguration per PowerShell">Konfiguration per PowerShell</a></li><li><a href=#modul-hinzuf%c3%bcgen aria-label="Modul hinzuf√ºgen">Modul hinzuf√ºgen</a></li><li><a href=#exchange-online-powershell-verwenden aria-label="Exchange Online PowerShell verwenden">Exchange Online PowerShell verwenden</a></li></ul></li><li><a href=#how-to-video aria-label="How-to Video">How-to Video</a></li><li><a href=#weiterf%c3%bchrende-links aria-label="Weiterf√ºhrende Links">Weiterf√ºhrende Links</a></li></ul></div></details></div><div class=post-content><p>Wenn ihr Exchange Online per Azure Automation steuern wollt, dann ist <strong>Managed Identities</strong> was ihr benutzen solltet (diese Aussage wurde zuletzt gepr√ºft im Juni 2024).</p><h2 id=legacy-ansatz>Legacy Ansatz<a hidden class=anchor aria-hidden=true href=#legacy-ansatz>#</a></h2><p>Fr√ºher wurden daf√ºr auch gerne RunAs Accounts oder Plaintext Credentials (ü§¢) verwendet, aber das gilt mittlerweile als veraltet. RunAs Accounts sind zum Herbst 2023 abgek√ºndigt und zu Klartext-Kennw√∂rtern muss ich nix sagen, oder?
Eventuell bieten sich noch App Registrierungen in Entra ID an, aber wenn ihr wirklich einfach nur per Azure Automation ein paar Exchange Online Einstellungen automatisieren wollt, ist das eigentlich nicht notwendig.</p><h2 id=managed-identities--exchange-online-powershell>Managed Identities + Exchange Online PowerShell<a hidden class=anchor aria-hidden=true href=#managed-identities--exchange-online-powershell>#</a></h2><p>Eine <strong>System Assigned Managed Identity</strong> weist einer Azure Resource eine <em>Identit√§t</em> zu. Dieser Identit√§t k√∂nnen Rechte zugewiesen werden, z.B. f√ºr die Administration von Exchange Online oder bestimmten Azure Ressourcen. Die Verwaltung der Identit√§t erfolgt automatisch, es muss also kein Passwort regelm√§√üig ge√§ndert werden oder √§hnliches. Und wenn die dazugeh√∂rige Ressource (in dem Fall das Azure Automation Konto) gel√∂scht wird, wird die System Assigned Managed Identity automatisch mitgel√∂scht.
Das Exchange Online PowerShell Modul unterst√ºtzt ab Version 3 Managed Identities f√ºr die Authentifizierung.</p><p>Theoretisch sollte das ganze auch mit einer User Assigned Managed Identities funktionieren. Dabei wird die Managed Identity selbst erzeugt und kann dann mehreren Azure Ressourcen zugewiesen werden. F√ºr manche Szenarien sicher auch praktisch.</p><h3 id=managed-identity-aktivieren>Managed Identity aktivieren<a hidden class=anchor aria-hidden=true href=#managed-identity-aktivieren>#</a></h3><p>Ich bevorzuge es System Assigned Managed Identities zu verwenden, da so effektiv nur eine Ressource die Rechte erh√§lt. Ihr k√∂nnt im Automation Account unter &ldquo;Account Settings&rdquo; -> &ldquo;Identity&rdquo; pr√ºfen, ob eine Managed Identity verwendet wird. Hier ein Beispiel-Screenshot mit einer vorhandenen Managed Identity: Der Status steht auf &ldquo;On&rdquo; und es wird eine Object ID aufgef√ºhrt.</p><p><a href=/images/2024/2024-06-21_AutomationAccount-Managed-Identity.jpg><img loading=lazy src=/images/2024/2024-06-21_AutomationAccount-Managed-Identity.jpg alt="Beispiel f√ºr einen Azure Automation Account mit einer System Assigned Managed Identity" title="Beispiel f√ºr einen Azure Automation Account mit einer System Assigned Managed Identity"></a></p><p>Die Zuweisung der &ldquo;Exchange Administrator&rdquo;-Rolle an die Managed Identity erfolgt dann anschlie√üend per <a href=#konfiguration-per-powershell>PowerShell/Graph API</a>.</p><h3 id=konfiguration-per-powershell>Konfiguration per PowerShell<a hidden class=anchor aria-hidden=true href=#konfiguration-per-powershell>#</a></h3><p>In diesem Abschnitt wird beschrieben, wie ihr die Konfiguration per PowerShell durchf√ºhren k√∂nnt. Die Zuweisung der &ldquo;Exchange Administrator&rdquo;-Rolle an eine Managed Identity erfolgt einmalig per <strong>lokaler</strong> PowerShell - der nachfolgende Code wird also nicht in Azure Automation als Runbook ausgef√ºhrt.</p><p>Voraussetzungen:</p><ul><li>Das Microsoft.Graph PowerShell Modul</li><li>Ein Benutzeraccount mit der Admin-Rolle &ldquo;Privileged Role Administrator&rdquo; oder &ldquo;Globaler Administrator&rdquo;</li></ul><p>Falls ihr das Modul noch nicht installiert habt, k√∂nnt ihr es wie folgt installieren (<a href="https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation?view=graph-powershell-1.0" target=_blank>mehr Infos hier</a>):</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Install-Module</span> Microsoft.Graph
</span></span></code></pre></td></tr></table></div></div><p>Anschlie√üend k√∂nnt ihr den nachfolgenden Code verwenden. Der Code ist inline kommentiert, also erkl√§re ich jetzt hier nichts weiter.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#d0a8ff>Connect-MgGraph</span> -Scopes AppRoleAssignment.ReadWrite.All,Application.Read.All,RoleManagement.ReadWrite.Directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Put your Managed Identity / Enterprise App registration name here:</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$MI_Name</span> = <span style=color:#fc6a5d>&#34;Mein-Automation-Account&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># there is no need to change any of the code below</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$MI_SP</span> = <span style=color:#d0a8ff>Get-MgServicePrincipal</span> -Property <span style=color:#fc6a5d>&#34;displayName,appId,id&#34;</span> -Filter <span style=color:#fc6a5d>&#34;servicePrincipalType eq &#39;ManagedIdentity&#39; and DisplayName eq &#39;</span>$(<span style=color:#41a1c0>$MI_Name</span>)<span style=color:#fc6a5d>&#39;&#34;</span> -ErrorAction Stop
</span></span><span style=display:flex><span><span style=color:#fc5fa3>if</span>(<span style=color:#41a1c0>$MI_SP</span>.Count -ne <span style=color:#d0bf69>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#d0a8ff>Write-Error</span> <span style=color:#fc6a5d>&#34;Something is wrong, found </span>$(<span style=color:#41a1c0>$MI_SP</span>.Count)<span style=color:#fc6a5d> matching Entra Service Principals. Aborting...&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#d0bf69>1</span>
</span></span><span style=display:flex><span>} <span style=color:#fc5fa3>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#41a1c0>$MI_ID</span> = <span style=color:#41a1c0>$MI_SP</span>.Id
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># try to retrieve the Exchange Online Service Principal (sometimes it&#39;s not available)</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$EXO_SP</span> = <span style=color:#d0a8ff>Get-MgServicePrincipal</span> -Filter <span style=color:#fc6a5d>&#34;AppId eq &#39;00000002-0000-0ff1-ce00-000000000000&#39;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#fc5fa3>if</span>(!<span style=color:#41a1c0>$EXO_SP</span>) {
</span></span><span style=display:flex><span>    <span style=color:#d0a8ff>Write-Error</span> <span style=color:#fc6a5d>&#34;No Exchange Online Service Principal found. Check this for troubleshooting: https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps#what-to-do-if-the-office-365-exchange-online-resource-is-not-available-in-microsoft-entra-id&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#d0bf69>1</span>
</span></span><span style=display:flex><span>    <span style=color:#6c7986># we can&#39;t proceed without the EXO_SP</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Exchange.ManageAsApp API Permission</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$AppRoleId</span> = <span style=color:#fc6a5d>&#34;dc50a0fb-09a3-484d-be87-e023b12c6440&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># the GUID value of the Office 365 Exchange Online resource in Microsoft Entra ID. The AppId value is the same in every organization, but the Id value is different in every organization.</span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$ResourceID</span> = <span style=color:#41a1c0>$EXO_SP</span>.Id 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># the actual assignment of Exchange.ManageAsApp:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>New-MgServicePrincipalAppRoleAssignment</span> -ServicePrincipalId <span style=color:#41a1c0>$MI_ID</span> -PrincipalId <span style=color:#41a1c0>$MI_ID</span> -AppRoleId <span style=color:#41a1c0>$AppRoleID</span> -ResourceId <span style=color:#41a1c0>$ResourceID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a1c0>$ExchangeAdminRoleID</span> = (<span style=color:#d0a8ff>Get-MgRoleManagementDirectoryRoleDefinition</span> -Filter <span style=color:#fc6a5d>&#34;DisplayName eq &#39;Exchange Administrator&#39;&#34;</span>).Id
</span></span><span style=display:flex><span><span style=color:#6c7986># the actual assignment of the Exchange Administrator role:</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>New-MgRoleManagementDirectoryRoleAssignment</span> -PrincipalId <span style=color:#41a1c0>$MI_ID</span> -RoleDefinitionId <span style=color:#41a1c0>$ExchangeAdminRoleID</span> -DirectoryScopeId <span style=color:#fc6a5d>&#34;/&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=modul-hinzuf√ºgen>Modul hinzuf√ºgen<a hidden class=anchor aria-hidden=true href=#modul-hinzuf√ºgen>#</a></h3><p>Egal ob ihr bereits &ldquo;Runtime Environments&rdquo; verwendet, oder noch die &ldquo;Old experience&rdquo;, ihr m√ºsst das ExchangeOnlineManagement PowerShell Modul hinzuf√ºgen. Im Falle der &ldquo;Old experience&rdquo; zum gesamten Automation Account. Wenn ihr Runtime Environments verwendet, dann f√ºgt das Modul stattdessen zu einem Runtime Environment hinzu bzw. legt ein neues Runtime Environment an. Das Modul wird sowohl von Windows PowerShell, als auch PowerShell 7 unterst√ºtzt.</p><h3 id=exchange-online-powershell-verwenden>Exchange Online PowerShell verwenden<a hidden class=anchor aria-hidden=true href=#exchange-online-powershell-verwenden>#</a></h3><p>Folgender Beispiel Code f√ºr ein Runbook verbindet sich als System Managed Managed Identity mit der Exchange Online Verwaltung, f√ºhrt einen Exchange Online PowerShell Befehl aus und trennt dann die Verbindung zu Exchange Online wieder.</p><div class=highlight><div style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#fff;background-color:#1f1f24;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#6c7986># Replace the Organization name with a domain from your tenant</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Connect-ExchangeOnline</span> -ManagedIdentity -Organization demotenant.de
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Example command that uses Exchange Online PowerShell: List all mailboxes</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Get-ExoMailbox</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7986># Disconnect again to free up connections</span>
</span></span><span style=display:flex><span><span style=color:#d0a8ff>Disconnect-ExchangeOnline</span> -Confirm:$false
</span></span></code></pre></td></tr></table></div></div><h2 id=how-to-video>How-to Video<a hidden class=anchor aria-hidden=true href=#how-to-video>#</a></h2><p>Ich habe auch ein <a href="https://www.youtube.com/watch?v=unXf7ma1NR4" target=_blank>Video</a> erstellt, in dem zeige wie Exchange Online per Azure Automation gesteuert werden kann. Dabei wird eine System Assigned Managed Identity f√ºr das Azure Automation Konto verwendet und dieser Identit√§t die Rechte zur Exchange Verwaltung zugewiesen.</p><p><a href="https://www.youtube.com/watch?v=unXf7ma1NR4" target=_blank><img loading=lazy src=/images/2023/2023-01-09_Azure_Automation_Exchange_online_thumbnail.png alt="Exchange Online per Azure Automation verwalten (YouTube)" title="Exchange Online per Azure Automation verwalten (YouTube)"></a></p><h2 id=weiterf√ºhrende-links>Weiterf√ºhrende Links<a hidden class=anchor aria-hidden=true href=#weiterf√ºhrende-links>#</a></h2><p>Die offizielle Microsoft Dokumentation dazu ist hier zu finden: <a href="https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps" target=_blank>https://learn.microsoft.com/en-us/powershell/exchange/connect-exo-powershell-managed-identity?view=exchange-ps</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://diecknet.de/de/tags/microsoft365/>Microsoft365</a></li><li><a href=https://diecknet.de/de/tags/office365/>Office365</a></li><li><a href=https://diecknet.de/de/tags/exchangeonline/>Exchangeonline</a></li><li><a href=https://diecknet.de/de/tags/powershell/>Powershell</a></li><li><a href=https://diecknet.de/de/tags/exo/>Exo</a></li><li><a href=https://diecknet.de/de/tags/azure/>Azure</a></li><li><a href=https://diecknet.de/de/tags/azureautomation/>Azureautomation</a></li></ul><div class=share-buttons></div></footer><script src=https://giscus.diecknet.de/client.js data-repo=diecknet/diecknet-blog data-repo-id="MDEwOlJlcG9zaXRvcnkyMDkzNDUzNzM=" data-category="Blog Discussions" data-category-id=MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyNjMwOTY0 data-mapping=specific data-term=Exchange-Online-per-Azure-Automation data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://diecknet.de/de/>diecknet</a></span>
&nbsp;|&nbsp;
<span><a href=https://diecknet.de/de/legal/>Impressum</a>
</span>&nbsp;|&nbsp;<span>
<a href=https://diecknet.de/de/privacy/>Datenschutz</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Kopieren";function s(){t.innerHTML="Kopiert!",setTimeout(()=>{t.innerHTML="Kopieren"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript>var _paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="//nc.diecknet.de/mt/",_paq.push(["setTrackerUrl",t+"mdata"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.defer=!0,e.src=t+"m.js",s.parentNode.insertBefore(e,s)}()</script><noscript><p><img src="https://nc.diecknet.de/mt/mdata?idsite=1&amp;rec=1" style=border:0 alt></p></noscript></body></html>